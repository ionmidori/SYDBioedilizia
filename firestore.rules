rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================
    // SESSIONS COLLECTION
    // ==========================================
    // Auth-required read with ownership check + 7-day TTL
    // Server-only write (only Admin SDK can create/update)
    match /sessions/{sessionId} {
      allow read: if request.auth != null
        && resource.data.userId == request.auth.uid
        && resource.data.createdAt != null
        && resource.data.createdAt > request.time - duration.value(7, 'd');

      // Only server can write (via Admin SDK with service account)
      allow write: if false;

      // Messages subcollection
      match /messages/{messageId} {
        // Allow read only if user owns the parent session
        allow read: if request.auth != null
          && (
            !exists(/databases/$(database)/documents/sessions/$(sessionId))
            || get(/databases/$(database)/documents/sessions/$(sessionId)).data.userId == request.auth.uid
          );

        // Only server can write messages
        allow write: if false;
      }
    }

    // ==========================================
    // LEADS COLLECTION
    // ==========================================
    // Server-only access (sensitive customer data)
    match /leads/{leadId} {
      // Only server can read/write leads
      allow read, write: if false;
    }


    // ==========================================
    // USER PREFERENCES
    // ==========================================

    match /users/{userId}/preferences/{prefId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ==========================================
    // PASSKEYS SUBCOLLECTION
    // ==========================================
    // Server-only write (registered via backend API)
    // Owner-only read (for credential discovery)

    match /users/{userId}/passkeys/{credId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false;
    }

    // ==========================================
    // PROJECT FILES METADATA
    // ==========================================

    match /projects/{projectId}/files/{fileId} {
      // Read: user must own the project
      allow read: if request.auth != null
        && (
          !exists(/databases/$(database)/documents/projects/$(projectId))
          || get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid
        );

      // Write: user must own the project AND NOT BE ANONYMOUS
      allow write: if request.auth != null
        && request.auth.token.firebase.sign_in_provider != 'anonymous'
        && (
          !exists(/databases/$(database)/documents/projects/$(projectId))
          || get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid
        );

      // Delete: user must own the project AND be the uploader
      allow delete: if request.auth != null
        && resource.data.uploadedBy == request.auth.uid
        && get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid;
    }

    // ==========================================
    // COLLECTION GROUP: FILES
    // ==========================================
    // Global Gallery queries restricted to files the user uploaded
    match /{path=**}/files/{fileId} {
      allow read: if request.auth != null
        && resource.data.uploadedBy == request.auth.uid;

      // Write restricted to uploader
      allow write: if request.auth != null
        && resource.data.uploadedBy == request.auth.uid;

      allow delete: if request.auth != null
        && resource.data.uploadedBy == request.auth.uid;
    }

    // ==========================================
    // PROJECTS COLLECTION
    // ==========================================

    match /projects/{projectId} {
      // Read: owner-only (Strict Deep Claim)
      allow read: if request.auth != null
        && resource.data.userId == request.auth.uid;

      // Create: any authenticated user
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;

      // Update: only owner
      allow update: if request.auth != null
        && resource.data.userId == request.auth.uid;

      // Delete: only owner
      allow delete: if request.auth != null
        && resource.data.userId == request.auth.uid;
    }

    // ==========================================
    // USERS COLLECTION
    // ==========================================

    // Users can only read/write their own data
    match /users/{userId} {
      // Allow authenticated users to read their own data
      allow read: if request.auth != null && request.auth.uid == userId;

      // Allow authenticated users to write their own data
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // ==========================================
    // DEFAULT RULE - DENY ALL
    // ==========================================
    // Deny access to all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
