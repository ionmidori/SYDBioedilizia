{"version":3,"sources":["../../../../ai_core/src/db/quotes.ts"],"sourcesContent":["\r\nimport { db } from '../firebase-admin';\r\nimport type { Firestore } from 'firebase-admin/firestore';\r\n\r\n/**\r\n * Interface corresponding to the data structure collected for the quote\r\n */\r\nexport interface QuoteDraftData {\r\n    // Technical Data (The Convergence Protocol)\r\n    logistics?: {\r\n        floor?: string;\r\n        elevator?: boolean;\r\n        yearOfConstruction?: string;\r\n        ceilingHeight?: string;\r\n    };\r\n    scopeOfWork?: {\r\n        demolitions?: boolean;\r\n        electrical?: string;\r\n        plumbing?: string;\r\n        fixtures?: string;\r\n    };\r\n    quantities?: {\r\n        sqm?: number;\r\n        points?: number;\r\n    };\r\n    // Context\r\n    roomType?: string;\r\n    style?: string;\r\n    // Generated Visuals\r\n    renderUrl?: string;\r\n\r\n    // Metadata\r\n    status: 'draft' | 'pending_review' | 'processed';\r\n    createdAt: string;\r\n    updatedAt: string;\r\n    schemaVersion: number;\r\n}\r\n\r\n/**\r\n * Saves a new quote draft to the 'quotes' collection in Firestore.\r\n * \r\n * @param userId - The ID of the user (or session ID if anonymous)\r\n * @param imageUrl - Optional URL of the reference image or generated render\r\n * @param aiData - The structured data collected by the Technical Surveyor (Mode B)\r\n * @returns The ID of the created document\r\n */\r\nexport async function saveQuoteDraft(\r\n    userId: string,\r\n    imageUrl: string | null | undefined,\r\n    aiData: any\r\n): Promise<string> {\r\n    try {\r\n        const firestore: Firestore = db();\r\n\r\n        // Sanitize and structure the data\r\n        const quoteData: QuoteDraftData = {\r\n            ...aiData,\r\n            clientId: userId, // Mapping userId to clientId or storing it separately\r\n            renderUrl: imageUrl || aiData.renderUrl || null,\r\n            status: 'draft',\r\n            createdAt: new Date().toISOString(),\r\n            updatedAt: new Date().toISOString(),\r\n            schemaVersion: 1\r\n        };\r\n\r\n        // Add to 'quotes' collection\r\n        const docRef = await firestore.collection('quotes').add(quoteData);\r\n\r\n        console.log(`[QuoteSystem] Draft saved with ID: ${docRef.id} for User: ${userId}`);\r\n\r\n        return docRef.id;\r\n\r\n    } catch (error) {\r\n        console.error('[QuoteSystem] Error saving quote draft:', error);\r\n        throw new Error(`Failed to save quote draft: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    }\r\n}\r\n"],"names":[],"mappings":"8CACA,IAAA,EAAA,EAAA,CAAA,CAAA,gBA6CO,eAAe,EAClB,CAAc,CACd,CAAmC,CACnC,CAAW,EAEX,GAAI,CACA,IAAM,EAAuB,CAAA,EAAA,EAAA,EAAA,AAAE,IAGzB,EAA4B,CAC9B,GAAG,CAAM,CACT,SAAU,EACV,UAAW,GAAY,EAAO,SAAS,EAAI,KAC3C,OAAQ,QACR,UAAW,IAAI,OAAO,WAAW,GACjC,UAAW,IAAI,OAAO,WAAW,GACjC,cAAe,CACnB,EAGM,EAAS,MAAM,EAAU,UAAU,CAAC,UAAU,GAAG,CAAC,GAIxD,OAFA,QAAQ,GAAG,CAAC,CAAC,mCAAmC,EAAE,EAAO,EAAE,CAAC,WAAW,EAAE,EAAA,CAAQ,EAE1E,EAAO,EAAE,AAEpB,CAAE,MAAO,EAAO,CAEZ,MADA,QAAQ,KAAK,CAAC,0CAA2C,GACnD,AAAI,MAAM,CAAC,4BAA4B,EAAE,aAAiB,MAAQ,EAAM,OAAO,CAAG,gBAAA,CAAiB,CAC7G,CACJ"}