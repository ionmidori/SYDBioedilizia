{"version":3,"sources":["../../../../ai_core/src/vision/triage.ts"],"sourcesContent":["import { GoogleGenerativeAI } from '@google/generative-ai';\r\n\r\n/**\r\n * Triage Analysis Result\r\n * A lightweight summary for the Chatbot to understand the context.\r\n */\r\nexport interface TriageAnalysis {\r\n    is_relevant: boolean; // True if it's a room/building interior/exterior suitable for renovation\r\n    relevance_reason: string;\r\n    summary_for_chat: string;\r\n    technical_data: {\r\n        room_type: string;\r\n        condition: 'good' | 'average' | 'poor' | 'shell';\r\n        complexity_score: number; // 1-10\r\n        detected_materials: string[];\r\n    };\r\n}\r\n\r\n/**\r\n * Phase 1: The Triage Analyzer\r\n * Analyzes the room image to provide immediate context to the Chatbot.\r\n * Uses the fast 'gemini-2.5-flash' model.\r\n * \r\n * @param imageBuffer - The image data as a Buffer\r\n * @returns Parsed TriageAnalysis JSON\r\n */\r\nexport async function analyzeImageForChat(imageBuffer: Buffer): Promise<TriageAnalysis> {\r\n    // 1. Define model in a SINGLE variable\r\n    const modelName = process.env.CHAT_MODEL_VERSION || 'gemini-2.5-flash';\r\n\r\n    // 2. Dynamic logging\r\n    console.log('[Triage] Starting analysis...');\r\n    console.log(`[Triage] Model: ${modelName}`);\r\n\r\n    const apiKey = process.env.GEMINI_API_KEY;\r\n    if (!apiKey) {\r\n        throw new Error('GEMINI_API_KEY not found');\r\n    }\r\n\r\n    const genAI = new GoogleGenerativeAI(apiKey);\r\n    // 3. Use the variable\r\n    const model = genAI.getGenerativeModel({\r\n        model: modelName,\r\n        generationConfig: {\r\n            responseMimeType: \"application/json\" // Force JSON mode if supported by the model version\r\n        }\r\n    });\r\n\r\n    const prompt = `Analyze this image for a home renovation context. \r\n    First, determine if this is an image of a room, building interior, or architectural space suitable for renovation.\r\n    If it is a picture of a pet, food, person (without room context), car, or landscape without buildings, set \"is_relevant\" to false.\r\n\r\n    Return ONLY a JSON object with this structure: \r\n    { \r\n        \"is_relevant\": boolean,\r\n        \"relevance_reason\": \"Brief explanation of why it is relevant or not\",\r\n        \"summary_for_chat\": \"A brief, natural language description of what you see (max 2 sentences) to be used by a chatbot. If irrelevant, describe what it is.\", \r\n        \"technical_data\": { \r\n            \"room_type\": \"string (or 'unknown' if irrelevant)\", \r\n            \"condition\": \"good|average|poor|shell\", \r\n            \"complexity_score\": number (1-10), \r\n            \"detected_materials\": [\"string\"] \r\n        } \r\n    }`;\r\n\r\n    try {\r\n        // Convert Buffer to Base64 for Gemini API\r\n        const base64Image = imageBuffer.toString('base64');\r\n\r\n        const result = await model.generateContent([\r\n            prompt,\r\n            {\r\n                inlineData: {\r\n                    data: base64Image,\r\n                    mimeType: 'image/jpeg' // Assuming JPEG for generic handling, or detect if strictly needed\r\n                }\r\n            }\r\n        ]);\r\n\r\n        const responseText = result.response.text();\r\n        console.log('[Triage] Raw response:', responseText.substring(0, 100) + '...');\r\n\r\n        // Strict JSON Parsing with cleanup\r\n        const cleanJson = responseText.replace(/```json\\n?|```/g, '').trim();\r\n        const data = JSON.parse(cleanJson) as TriageAnalysis;\r\n\r\n        // Runtime Validation\r\n        if (!data.summary_for_chat || !data.technical_data) {\r\n            throw new Error('Invalid JSON structure: missing required fields');\r\n        }\r\n\r\n        console.log('[Triage] âœ… Analysis complete:', data.technical_data.room_type);\r\n        return data;\r\n\r\n    } catch (error) {\r\n        console.error('[Triage] Error:', error);\r\n        throw new Error(`Triage analysis failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    }\r\n}\r\n"],"names":[],"mappings":"uCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OA0BO,eAAe,EAAoB,CAAmB,EAEzD,IAAM,EAAY,QAAQ,GAAG,CAAC,kBAAkB,EAAI,mBAGpD,QAAQ,GAAG,CAAC,iCACZ,QAAQ,GAAG,CAAC,CAAC,gBAAgB,EAAE,EAAA,CAAW,EAE1C,IAAM,EAAS,QAAQ,GAAG,CAAC,cAAc,CACzC,GAAI,CAAC,EACD,MADS,AACH,AAAI,MAAM,4BAKpB,IAAM,EAFQ,AAEA,IAFI,EAAA,kBAAkB,CAAC,GAEjB,kBAAkB,CAAC,CACnC,MAAO,EACP,iBAAkB,CACd,iBAAkB,kBACtB,CADyC,AAE7C,GAEM,EAAS,CAAC,8CAJiF;;;;;;;;;;;;;;;KAmBhG,CAAC,CAEF,GAAI,CAEA,IAAM,EAAc,EAAY,QAAQ,CAAC,UAYnC,EAAe,CAVN,MAAM,EAAM,eAAe,CAAC,CACvC,EACA,CACI,WAAY,CACR,KAAM,EACN,SAAU,YACd,CACJ,AAF+B,GAGlC,EAE2B,QAAQ,CAAC,IAAI,GACzC,QAAQ,GAAG,CAAC,yBAA0B,EAAa,OANmD,EAM1C,CAAC,EAAG,KAAO,OAGvE,IAAM,EAAY,EAAa,OAAO,CAAC,kBAAmB,IAAI,IAAI,GAC5D,EAAO,KAAK,KAAK,CAAC,GAGxB,GAAI,CAAC,EAAK,gBAAgB,EAAI,CAAC,EAAK,cAAc,CAC9C,CADgD,KAC1C,AAAI,MAAM,mDAIpB,OADA,QAAQ,GAAG,CAAC,gCAAiC,EAAK,cAAc,CAAC,SAAS,EACnE,CAEX,CAAE,MAAO,EAAO,CAEZ,MADA,QAAQ,KAAK,CAAC,kBAAmB,GAC3B,AAAI,MAAM,CAAC,wBAAwB,EAAE,aAAiB,MAAQ,EAAM,OAAO,CAAG,gBAAA,CAAiB,CACzG,CACJ"}