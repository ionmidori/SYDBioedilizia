{"version":3,"sources":["../../../../ai_core/src/imagen/generator.ts"],"sourcesContent":["\r\nimport { VertexAI, HarmCategory, HarmBlockThreshold } from '@google-cloud/vertexai';\r\n\r\n/**\r\n * The Painter: Executes the renovation using the provided Locked Prompt.\r\n * Uses Gemini 3 Pro Image Preview (Multimodal) for high-fidelity generation.\r\n * \r\n * ROLE: Senior AI Engineer Implementation\r\n * MODEL: gemini-3-pro-image-preview\r\n * REGION: us-central1\r\n */\r\nexport async function generateRenovation(imageBuffer: Buffer, prompt: string): Promise<Buffer> {\r\n    console.log(`[Painter] Starting renovation generation...`);\r\n    // console.log(`[Painter] Prompt length: ${prompt.length} chars`);\r\n\r\n    // STEP 2: The Painter (Vertex AI Generation) - DIRECT EXECUTION\r\n    // The prompt is now provided by the orchestrator (JIT Pipeline)\r\n    const finalPrompt = `${prompt}\\n\\nOutput a high-res renovation image.`;\r\n\r\n    // STEP 2: The Painter (Vertex AI Generation)\r\n    const projectId = process.env.FIREBASE_PROJECT_ID;\r\n    const location = 'us-central1'; // REQUIRED for preview models\r\n\r\n    if (!projectId) {\r\n        throw new Error('FIREBASE_PROJECT_ID not found');\r\n    }\r\n\r\n    // Initialize Vertex AI with explicit auth support for local dev\r\n    const vertex_ai = new VertexAI({\r\n        project: projectId,\r\n        location: location,\r\n        googleAuthOptions: process.env.FIREBASE_CLIENT_EMAIL && process.env.FIREBASE_PRIVATE_KEY ? {\r\n            credentials: {\r\n                client_email: process.env.FIREBASE_CLIENT_EMAIL,\r\n                private_key: process.env.FIREBASE_PRIVATE_KEY.replace(/\\\\n/g, '\\n')\r\n            }\r\n        } : undefined\r\n    });\r\n\r\n    // Use the model version from env (User requested: gemini-2.5-flash-image for I2I)\r\n    const envModel = process.env.VISION_MODEL_VERSION;\r\n    const modelName = envModel || 'gemini-2.5-flash-image';\r\n    console.log(`[Painter] ENV VISION_MODEL_VERSION: ${envModel}`);\r\n    console.log(`[Painter] Initializing model: ${modelName} in ${location}`);\r\n\r\n    const generativeModel = vertex_ai.getGenerativeModel({\r\n        model: modelName,\r\n        safetySettings: [\r\n            { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },\r\n            { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },\r\n            { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },\r\n            { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },\r\n        ],\r\n        generationConfig: {\r\n            maxOutputTokens: 8192,\r\n            temperature: 0.2, // Keep low to respect the \"Locked\" instructions\r\n            topP: 0.95,\r\n        }\r\n    });\r\n\r\n    try {\r\n        const base64Image = imageBuffer.toString('base64');\r\n        const mimeType = 'image/jpeg';\r\n\r\n        const multimodalPrompt = {\r\n            inlineData: {\r\n                mimeType: mimeType,\r\n                data: base64Image\r\n            }\r\n        };\r\n\r\n        const textPart = {\r\n            text: finalPrompt\r\n        };\r\n\r\n        const request = {\r\n            contents: [{\r\n                role: 'user',\r\n                parts: [multimodalPrompt, textPart]\r\n            }]\r\n        };\r\n\r\n        console.log('[Painter] Sending request to Vertex AI...');\r\n        const response = await generativeModel.generateContent(request);\r\n        const result = await response.response;\r\n\r\n        // Extract Image\r\n        if (!result.candidates || result.candidates.length === 0) {\r\n            throw new Error('No candidates returned');\r\n        }\r\n\r\n        const candidate = result.candidates[0];\r\n        let generatedImageBase64: string | undefined;\r\n\r\n        for (const part of candidate.content.parts) {\r\n            // Check for inlineData (Base64)\r\n            if (part.inlineData && part.inlineData.mimeType.startsWith('image/')) {\r\n                generatedImageBase64 = part.inlineData.data;\r\n                break;\r\n            }\r\n            // Future-proofing: Check for fileData (URI) if returned by some versions\r\n            // @ts-ignore\r\n            if (part.fileData && part.fileData.mimeType.startsWith('image/')) {\r\n                console.warn('[Painter] Received fileData URL instead of inlineData, functionality might need update.');\r\n            }\r\n        }\r\n\r\n        if (!generatedImageBase64) {\r\n            console.error('[Painter] Full Response:', JSON.stringify(result, null, 2));\r\n            throw new Error('Model returned valid response but NO image data found.');\r\n        }\r\n\r\n        const generatedBuffer = Buffer.from(generatedImageBase64, 'base64');\r\n        console.log(`[Painter] âœ… Generation complete! Image size: ${(generatedBuffer.length / 1024).toFixed(2)} KB`);\r\n\r\n        return generatedBuffer;\r\n\r\n    } catch (error) {\r\n        console.error('[Painter] Error:', error);\r\n        if (error instanceof Error && error.message.includes('404')) {\r\n            throw new Error(`Model ${modelName} not found in ${location}. Ensure Project ID is allowlisted.`);\r\n        }\r\n        throw new Error(`Painter generation failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}