{"version":3,"sources":["../../../../ai_core/src/storage/upload.ts"],"sourcesContent":["import { storage } from '../firebase-admin';\r\n\r\n/**\r\n * Uploads a generated image buffer to Firebase Storage.\r\n * \r\n * Target Path: generated/${userId}/${timestamp}_${slug}.jpg\r\n * Security: Private bucket, returns Signed URL (1 year validity)\r\n *\r\n * @param imageBuffer - The raw image buffer (JPEG).\r\n * @param userId - The ID of the user (or session ID) to scope the file.\r\n * @param slug - A descriptive slug for the filename (e.g. \"modern_living_room\").\r\n * @returns A signed URL valid for 1 year.\r\n */\r\nexport async function uploadGeneratedImage(imageBuffer: Buffer, userId: string, slug: string): Promise<string> {\r\n    // 1. Get Storage Instance (Singleton from firebase-admin.ts)\r\n    const storageInstance = storage();\r\n    const bucket = storageInstance.bucket();\r\n\r\n    // 2. Define Path\r\n    const timestamp = Date.now();\r\n    // Sanitize slug to be safe for filenames\r\n    const safeSlug = slug.replace(/[^a-z0-9_-]/gi, '_').toLowerCase();\r\n    const filePath = `generated/${userId}/${timestamp}_${safeSlug}.jpg`;\r\n\r\n    const file = bucket.file(filePath);\r\n\r\n    try {\r\n        console.log(`[Storage] Uploading ${imageBuffer.length} bytes to ${filePath}...`);\r\n\r\n        // 3. Upload File\r\n        await file.save(imageBuffer, {\r\n            contentType: 'image/jpeg',\r\n            metadata: {\r\n                contentType: 'image/jpeg',\r\n                // Custom metadata if needed in future\r\n                generatedBy: 'JIT-Pipeline'\r\n            }\r\n        });\r\n\r\n        // 4. Generate Signed URL (Read-Only)\r\n        // Valid for 365 days. \r\n        // Note: For production, consider shorter expiry or authenticating the client logic.\r\n        const [url] = await file.getSignedUrl({\r\n            action: 'read',\r\n            expires: Date.now() + 1000 * 60 * 60 * 24 * 365, // 1 year\r\n        });\r\n\r\n        console.log(`[Storage] ✅ Upload success. URL: ${url.substring(0, 50)}...`);\r\n        return url;\r\n\r\n    } catch (error) {\r\n        console.error(`[Storage] ❌ Failed to upload image to ${filePath}:`, error);\r\n        throw new Error(`Image upload failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    }\r\n}\r\n"],"names":[],"mappings":"8CAAA,IAAA,EAAA,EAAA,CAAA,CAAA,gBAaO,eAAe,EAAqB,CAAmB,CAAE,CAAc,CAAE,CAAY,EAGxF,IAAM,EADkB,AACT,CADS,EAAA,EAAA,OAAA,AAAO,IACA,MAAM,GAG/B,EAAY,KAAK,GAAG,GAEpB,EAAW,EAAK,OAAO,CAAC,gBAAiB,KAAK,WAAW,GACzD,EAAW,CAAC,UAAU,EAAE,EAAO,CAAC,EAAE,EAAU,CAAC,EAAE,EAAS,IAAI,CAAC,CAE7D,EAAO,EAAO,IAAI,CAAC,GAEzB,GAAI,CACA,QAAQ,GAAG,CAAC,CAAC,oBAAoB,EAAE,EAAY,MAAM,CAAC,UAAU,EAAE,EAAS,GAAG,CAAC,EAG/E,MAAM,EAAK,IAAI,CAAC,EAAa,CACzB,YAAa,aACb,SAAU,CACN,YAAa,aAEb,YAAa,cACjB,CACJ,GAKA,GAAM,CAAC,EAAI,CAAG,MAAM,EAAK,YAAY,CAAC,CAClC,OAAQ,OACR,QAAS,KAAK,GAAG,GAAK,OAAO,AACjC,GAGA,EAJsC,KAAK,AAG3C,KAHgD,GAGxC,GAAG,CAAC,CAAC,iCAAiC,EAAE,EAAI,SAAS,CAAC,EAAG,IAAI,GAAG,CAAC,EAClE,CAEX,CAAE,MAAO,EAAO,CAEZ,MADA,QAAQ,KAAK,CAAC,CAAC,sCAAsC,EAAE,EAAS,CAAC,CAAC,CAAE,GAC9D,AAAI,MAAM,CAAC,qBAAqB,EAAE,aAAiB,MAAQ,EAAM,OAAO,CAAG,gBAAA,CAAiB,CACtG,CACJ"}