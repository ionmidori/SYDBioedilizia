module.exports=[11227,e=>{"use strict";var t=e.i(62789),o=e.i(75789);e.i(74444);var i=e.i(10584),n=(0,t.lazySchema)(()=>(0,t.zodSchema)(i.z.object({error:i.z.object({code:i.z.number().nullable(),message:i.z.string(),status:i.z.string()})}))),a=(0,t.createJsonErrorResponseHandler)({errorSchema:n,errorToMessage:e=>e.error.message}),r=(0,t.lazySchema)(()=>(0,t.zodSchema)(i.z.object({outputDimensionality:i.z.number().optional(),taskType:i.z.enum(["SEMANTIC_SIMILARITY","CLASSIFICATION","CLUSTERING","RETRIEVAL_DOCUMENT","RETRIEVAL_QUERY","QUESTION_ANSWERING","FACT_VERIFICATION","CODE_RETRIEVAL_QUERY"]).optional()}))),s=class{constructor(e,t){this.specificationVersion="v3",this.maxEmbeddingsPerCall=2048,this.supportsParallelCalls=!0,this.modelId=e,this.config=t}get provider(){return this.config.provider}async doEmbed({values:e,headers:i,abortSignal:n,providerOptions:s}){let d=await (0,t.parseProviderOptions)({provider:"google",providerOptions:s,schema:r});if(e.length>this.maxEmbeddingsPerCall)throw new o.TooManyEmbeddingValuesForCallError({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});let c=(0,t.combineHeaders)(await (0,t.resolve)(this.config.headers),i);if(1===e.length){let{responseHeaders:o,value:i,rawValue:r}=await (0,t.postJsonToApi)({url:`${this.config.baseURL}/models/${this.modelId}:embedContent`,headers:c,body:{model:`models/${this.modelId}`,content:{parts:[{text:e[0]}]},outputDimensionality:null==d?void 0:d.outputDimensionality,taskType:null==d?void 0:d.taskType},failedResponseHandler:a,successfulResponseHandler:(0,t.createJsonResponseHandler)(u),abortSignal:n,fetch:this.config.fetch});return{warnings:[],embeddings:[i.embedding.values],usage:void 0,response:{headers:o,body:r}}}let{responseHeaders:p,value:g,rawValue:h}=await (0,t.postJsonToApi)({url:`${this.config.baseURL}/models/${this.modelId}:batchEmbedContents`,headers:c,body:{requests:e.map(e=>({model:`models/${this.modelId}`,content:{role:"user",parts:[{text:e}]},outputDimensionality:null==d?void 0:d.outputDimensionality,taskType:null==d?void 0:d.taskType}))},failedResponseHandler:a,successfulResponseHandler:(0,t.createJsonResponseHandler)(l),abortSignal:n,fetch:this.config.fetch});return{warnings:[],embeddings:g.embeddings.map(e=>e.values),usage:void 0,response:{headers:p,body:h}}}},l=(0,t.lazySchema)(()=>(0,t.zodSchema)(i.z.object({embeddings:i.z.array(i.z.object({values:i.z.array(i.z.number())}))}))),u=(0,t.lazySchema)(()=>(0,t.zodSchema)(i.z.object({embedding:i.z.object({values:i.z.array(i.z.number())})})));function d(e){var t,o,i,n;if(null==e)return{inputTokens:{total:void 0,noCache:void 0,cacheRead:void 0,cacheWrite:void 0},outputTokens:{total:void 0,text:void 0,reasoning:void 0},raw:void 0};let a=null!=(t=e.promptTokenCount)?t:0,r=null!=(o=e.candidatesTokenCount)?o:0,s=null!=(i=e.cachedContentTokenCount)?i:0,l=null!=(n=e.thoughtsTokenCount)?n:0;return{inputTokens:{total:a,noCache:a-s,cacheRead:s,cacheWrite:void 0},outputTokens:{total:r+l,text:r,reasoning:l},raw:e}}function c(e,t=!0){var o;if(null==e)return;if(null!=(o=e)&&"object"==typeof o&&"object"===o.type&&(null==o.properties||0===Object.keys(o.properties).length)&&!o.additionalProperties)return t?void 0:"object"==typeof e&&e.description?{type:"object",description:e.description}:{type:"object"};if("boolean"==typeof e)return{type:"boolean",properties:{}};let{type:i,description:n,required:a,properties:r,items:s,allOf:l,anyOf:u,oneOf:d,format:p,const:g,minLength:h,enum:m}=e,f={};if(n&&(f.description=n),a&&(f.required=a),p&&(f.format=p),void 0!==g&&(f.enum=[g]),i)if(Array.isArray(i)){let e=i.includes("null"),t=i.filter(e=>"null"!==e);0===t.length?f.type="null":(f.anyOf=t.map(e=>({type:e})),e&&(f.nullable=!0))}else f.type=i;if(void 0!==m&&(f.enum=m),null!=r&&(f.properties=Object.entries(r).reduce((e,[t,o])=>(e[t]=c(o,!1),e),{})),s&&(f.items=Array.isArray(s)?s.map(e=>c(e,!1)):c(s,!1)),l&&(f.allOf=l.map(e=>c(e,!1))),u)if(u.some(e=>"object"==typeof e&&(null==e?void 0:e.type)==="null")){let e=u.filter(e=>"object"!=typeof e||(null==e?void 0:e.type)!=="null");if(1===e.length){let t=c(e[0],!1);"object"==typeof t&&(f.nullable=!0,Object.assign(f,t))}else f.anyOf=e.map(e=>c(e,!1)),f.nullable=!0}else f.anyOf=u.map(e=>c(e,!1));return d&&(f.oneOf=d.map(e=>c(e,!1))),void 0!==h&&(f.minLength=h),f}function p(e){return e.includes("/")?e:`models/${e}`}var g=(0,t.lazySchema)(()=>(0,t.zodSchema)(i.z.object({responseModalities:i.z.array(i.z.enum(["TEXT","IMAGE"])).optional(),thinkingConfig:i.z.object({thinkingBudget:i.z.number().optional(),includeThoughts:i.z.boolean().optional(),thinkingLevel:i.z.enum(["minimal","low","medium","high"]).optional()}).optional(),cachedContent:i.z.string().optional(),structuredOutputs:i.z.boolean().optional(),safetySettings:i.z.array(i.z.object({category:i.z.enum(["HARM_CATEGORY_UNSPECIFIED","HARM_CATEGORY_HATE_SPEECH","HARM_CATEGORY_DANGEROUS_CONTENT","HARM_CATEGORY_HARASSMENT","HARM_CATEGORY_SEXUALLY_EXPLICIT","HARM_CATEGORY_CIVIC_INTEGRITY"]),threshold:i.z.enum(["HARM_BLOCK_THRESHOLD_UNSPECIFIED","BLOCK_LOW_AND_ABOVE","BLOCK_MEDIUM_AND_ABOVE","BLOCK_ONLY_HIGH","BLOCK_NONE","OFF"])})).optional(),threshold:i.z.enum(["HARM_BLOCK_THRESHOLD_UNSPECIFIED","BLOCK_LOW_AND_ABOVE","BLOCK_MEDIUM_AND_ABOVE","BLOCK_ONLY_HIGH","BLOCK_NONE","OFF"]).optional(),audioTimestamp:i.z.boolean().optional(),labels:i.z.record(i.z.string(),i.z.string()).optional(),mediaResolution:i.z.enum(["MEDIA_RESOLUTION_UNSPECIFIED","MEDIA_RESOLUTION_LOW","MEDIA_RESOLUTION_MEDIUM","MEDIA_RESOLUTION_HIGH"]).optional(),imageConfig:i.z.object({aspectRatio:i.z.enum(["1:1","2:3","3:2","3:4","4:3","4:5","5:4","9:16","16:9","21:9"]).optional(),imageSize:i.z.enum(["1K","2K","4K"]).optional()}).optional(),retrievalConfig:i.z.object({latLng:i.z.object({latitude:i.z.number(),longitude:i.z.number()}).optional()}).optional()})));function h({finishReason:e,hasToolCalls:t}){switch(e){case"STOP":return t?"tool-calls":"stop";case"MAX_TOKENS":return"length";case"IMAGE_SAFETY":case"RECITATION":case"SAFETY":case"BLOCKLIST":case"PROHIBITED_CONTENT":case"SPII":return"content-filter";case"MALFORMED_FUNCTION_CALL":return"error";default:return"other"}}var m=class{constructor(e,o){var i;this.specificationVersion="v3",this.modelId=e,this.config=o,this.generateId=null!=(i=o.generateId)?i:t.generateId}get provider(){return this.config.provider}get supportedUrls(){var e,t,o;return null!=(o=null==(t=(e=this.config).supportedUrls)?void 0:t.call(e))?o:{}}async getArgs({prompt:e,maxOutputTokens:i,temperature:n,topP:a,topK:r,frequencyPenalty:s,presencePenalty:l,stopSequences:u,responseFormat:d,seed:p,tools:h,toolChoice:m,providerOptions:f}){var v;let y=[],E=this.config.provider.includes("vertex")?"vertex":"google",b=await (0,t.parseProviderOptions)({provider:E,providerOptions:f,schema:g});null==b&&"google"!==E&&(b=await (0,t.parseProviderOptions)({provider:"google",providerOptions:f,schema:g})),(null==h?void 0:h.some(e=>"provider"===e.type&&"google.vertex_rag_store"===e.id))&&!this.config.provider.startsWith("google.vertex.")&&y.push({type:"other",message:`The 'vertex_rag_store' tool is only supported with the Google Vertex provider and might not be supported or could behave unexpectedly with the current Google provider (${this.config.provider}).`});let T=this.modelId.toLowerCase().startsWith("gemma-"),{contents:C,systemInstruction:S}=function(e,i){var n,a,r;let s=[],l=[],u=!0,d=null!=(n=null==i?void 0:i.isGemmaModel)&&n,c=null!=(a=null==i?void 0:i.providerOptionsName)?a:"google";for(let{role:i,content:n}of e)switch(i){case"system":if(!u)throw new o.UnsupportedFunctionalityError({functionality:"system messages are only supported at the beginning of the conversation"});s.push({text:n});break;case"user":{u=!1;let e=[];for(let o of n)switch(o.type){case"text":e.push({text:o.text});break;case"file":{let i="image/*"===o.mediaType?"image/jpeg":o.mediaType;e.push(o.data instanceof URL?{fileData:{mimeType:i,fileUri:o.data.toString()}}:{inlineData:{mimeType:i,data:(0,t.convertToBase64)(o.data)}})}}l.push({role:"user",parts:e});break}case"assistant":u=!1,l.push({role:"model",parts:n.map(e=>{var i;let n=null==(i=e.providerOptions)?void 0:i[c],a=(null==n?void 0:n.thoughtSignature)!=null?String(n.thoughtSignature):void 0;switch(e.type){case"text":return 0===e.text.length?void 0:{text:e.text,thoughtSignature:a};case"reasoning":return 0===e.text.length?void 0:{text:e.text,thought:!0,thoughtSignature:a};case"file":if(e.data instanceof URL)throw new o.UnsupportedFunctionalityError({functionality:"File data URLs in assistant messages are not supported"});return{inlineData:{mimeType:e.mediaType,data:(0,t.convertToBase64)(e.data)},thoughtSignature:a};case"tool-call":return{functionCall:{name:e.toolName,args:e.input},thoughtSignature:a}}}).filter(e=>void 0!==e)});break;case"tool":{u=!1;let e=[];for(let t of n){if("tool-approval-response"===t.type)continue;let o=t.output;if("content"===o.type)for(let i of o.value)switch(i.type){case"text":e.push({functionResponse:{name:t.toolName,response:{name:t.toolName,content:i.text}}});break;case"image-data":e.push({inlineData:{mimeType:i.mediaType,data:i.data}},{text:"Tool executed successfully and returned this image as a response"});break;default:e.push({text:JSON.stringify(i)})}else e.push({functionResponse:{name:t.toolName,response:{name:t.toolName,content:"execution-denied"===o.type?null!=(r=o.reason)?r:"Tool execution denied.":o.value}}})}l.push({role:"user",parts:e})}}if(d&&s.length>0&&l.length>0&&"user"===l[0].role){let e=s.map(e=>e.text).join("\n\n");l[0].parts.unshift({text:e+"\n\n"})}return{systemInstruction:s.length>0&&!d?{parts:s}:void 0,contents:l}}(e,{isGemmaModel:T,providerOptionsName:E}),{tools:R,toolConfig:I,toolWarnings:z}=function({tools:e,toolChoice:t,modelId:i}){var n;e=(null==e?void 0:e.length)?e:void 0;let a=[],r=["gemini-flash-latest","gemini-flash-lite-latest","gemini-pro-latest"].some(e=>e===i),s=i.includes("gemini-2")||i.includes("gemini-3")||r,l=i.includes("gemini-1.5-flash")&&!i.includes("-8b"),u=i.includes("gemini-2.5");if(null==e)return{tools:void 0,toolConfig:void 0,toolWarnings:a};let d=e.some(e=>"function"===e.type),p=e.some(e=>"provider"===e.type);if(d&&p&&a.push({type:"unsupported",feature:"combination of function and provider-defined tools"}),p){let t=[];return e.filter(e=>"provider"===e.type).forEach(e=>{switch(e.id){case"google.google_search":s?t.push({googleSearch:{}}):l?t.push({googleSearchRetrieval:{dynamicRetrievalConfig:{mode:e.args.mode,dynamicThreshold:e.args.dynamicThreshold}}}):t.push({googleSearchRetrieval:{}});break;case"google.enterprise_web_search":s?t.push({enterpriseWebSearch:{}}):a.push({type:"unsupported",feature:`provider-defined tool ${e.id}`,details:"Enterprise Web Search requires Gemini 2.0 or newer."});break;case"google.url_context":s?t.push({urlContext:{}}):a.push({type:"unsupported",feature:`provider-defined tool ${e.id}`,details:"The URL context tool is not supported with other Gemini models than Gemini 2."});break;case"google.code_execution":s?t.push({codeExecution:{}}):a.push({type:"unsupported",feature:`provider-defined tool ${e.id}`,details:"The code execution tools is not supported with other Gemini models than Gemini 2."});break;case"google.file_search":u?t.push({fileSearch:{...e.args}}):a.push({type:"unsupported",feature:`provider-defined tool ${e.id}`,details:"The file search tool is only supported with Gemini 2.5 models."});break;case"google.vertex_rag_store":s?t.push({retrieval:{vertex_rag_store:{rag_resources:{rag_corpus:e.args.ragCorpus},similarity_top_k:e.args.topK}}}):a.push({type:"unsupported",feature:`provider-defined tool ${e.id}`,details:"The RAG store tool is not supported with other Gemini models than Gemini 2."});break;case"google.google_maps":s?t.push({googleMaps:{}}):a.push({type:"unsupported",feature:`provider-defined tool ${e.id}`,details:"The Google Maps grounding tool is not supported with Gemini models other than Gemini 2 or newer."});break;default:a.push({type:"unsupported",feature:`provider-defined tool ${e.id}`})}}),{tools:t.length>0?t:void 0,toolConfig:void 0,toolWarnings:a}}let g=[];for(let t of e)"function"===t.type?g.push({name:t.name,description:null!=(n=t.description)?n:"",parameters:c(t.inputSchema)}):a.push({type:"unsupported",feature:`function tool ${t.name}`});if(null==t)return{tools:[{functionDeclarations:g}],toolConfig:void 0,toolWarnings:a};let h=t.type;switch(h){case"auto":return{tools:[{functionDeclarations:g}],toolConfig:{functionCallingConfig:{mode:"AUTO"}},toolWarnings:a};case"none":return{tools:[{functionDeclarations:g}],toolConfig:{functionCallingConfig:{mode:"NONE"}},toolWarnings:a};case"required":return{tools:[{functionDeclarations:g}],toolConfig:{functionCallingConfig:{mode:"ANY"}},toolWarnings:a};case"tool":return{tools:[{functionDeclarations:g}],toolConfig:{functionCallingConfig:{mode:"ANY",allowedFunctionNames:[t.toolName]}},toolWarnings:a};default:throw new o.UnsupportedFunctionalityError({functionality:`tool choice type: ${h}`})}}({tools:h,toolChoice:m,modelId:this.modelId});return{args:{generationConfig:{maxOutputTokens:i,temperature:n,topK:r,topP:a,frequencyPenalty:s,presencePenalty:l,stopSequences:u,seed:p,responseMimeType:(null==d?void 0:d.type)==="json"?"application/json":void 0,responseSchema:(null==d?void 0:d.type)==="json"&&null!=d.schema&&(null==(v=null==b?void 0:b.structuredOutputs)||v)?c(d.schema):void 0,...(null==b?void 0:b.audioTimestamp)&&{audioTimestamp:b.audioTimestamp},responseModalities:null==b?void 0:b.responseModalities,thinkingConfig:null==b?void 0:b.thinkingConfig,...(null==b?void 0:b.mediaResolution)&&{mediaResolution:b.mediaResolution},...(null==b?void 0:b.imageConfig)&&{imageConfig:b.imageConfig}},contents:C,systemInstruction:T?void 0:S,safetySettings:null==b?void 0:b.safetySettings,tools:R,toolConfig:(null==b?void 0:b.retrievalConfig)?{...I,retrievalConfig:b.retrievalConfig}:I,cachedContent:null==b?void 0:b.cachedContent,labels:null==b?void 0:b.labels},warnings:[...y,...z],providerOptionsName:E}}async doGenerate(e){var o,i,n,r,s,l,u,c,g;let m,{args:v,warnings:y,providerOptionsName:E}=await this.getArgs(e),b=(0,t.combineHeaders)(await (0,t.resolve)(this.config.headers),e.headers),{responseHeaders:T,value:S,rawValue:R}=await (0,t.postJsonToApi)({url:`${this.config.baseURL}/${p(this.modelId)}:generateContent`,headers:b,body:v,failedResponseHandler:a,successfulResponseHandler:(0,t.createJsonResponseHandler)(C),abortSignal:e.abortSignal,fetch:this.config.fetch}),I=S.candidates[0],z=[],A=null!=(i=null==(o=I.content)?void 0:o.parts)?i:[],O=S.usageMetadata;for(let e of A)if("executableCode"in e&&(null==(n=e.executableCode)?void 0:n.code)){let t=this.config.generateId();m=t,z.push({type:"tool-call",toolCallId:t,toolName:"code_execution",input:JSON.stringify(e.executableCode),providerExecuted:!0})}else"codeExecutionResult"in e&&e.codeExecutionResult?(z.push({type:"tool-result",toolCallId:m,toolName:"code_execution",result:{outcome:e.codeExecutionResult.outcome,output:e.codeExecutionResult.output}}),m=void 0):"text"in e&&null!=e.text&&e.text.length>0?z.push({type:!0===e.thought?"reasoning":"text",text:e.text,providerMetadata:e.thoughtSignature?{[E]:{thoughtSignature:e.thoughtSignature}}:void 0}):"functionCall"in e?z.push({type:"tool-call",toolCallId:this.config.generateId(),toolName:e.functionCall.name,input:JSON.stringify(e.functionCall.args),providerMetadata:e.thoughtSignature?{[E]:{thoughtSignature:e.thoughtSignature}}:void 0}):"inlineData"in e&&z.push({type:"file",data:e.inlineData.data,mediaType:e.inlineData.mimeType,providerMetadata:e.thoughtSignature?{[E]:{thoughtSignature:e.thoughtSignature}}:void 0});for(let e of null!=(r=f({groundingMetadata:I.groundingMetadata,generateId:this.config.generateId}))?r:[])z.push(e);return{content:z,finishReason:{unified:h({finishReason:I.finishReason,hasToolCalls:z.some(e=>"tool-call"===e.type)}),raw:null!=(s=I.finishReason)?s:void 0},usage:d(O),warnings:y,providerMetadata:{[E]:{promptFeedback:null!=(l=S.promptFeedback)?l:null,groundingMetadata:null!=(u=I.groundingMetadata)?u:null,urlContextMetadata:null!=(c=I.urlContextMetadata)?c:null,safetyRatings:null!=(g=I.safetyRatings)?g:null,usageMetadata:null!=O?O:null}},request:{body:v},response:{headers:T,body:R}}}async doStream(e){let o,i,n,{args:r,warnings:s,providerOptionsName:l}=await this.getArgs(e),u=(0,t.combineHeaders)(await (0,t.resolve)(this.config.headers),e.headers),{responseHeaders:c,value:g}=await (0,t.postJsonToApi)({url:`${this.config.baseURL}/${p(this.modelId)}:streamGenerateContent?alt=sse`,headers:u,body:r,failedResponseHandler:a,successfulResponseHandler:(0,t.createEventSourceResponseHandler)(S),abortSignal:e.abortSignal,fetch:this.config.fetch}),m={unified:"other",raw:void 0},v=this.config.generateId,y=!1,E=null,b=null,T=0,C=new Set;return{stream:g.pipeThrough(new TransformStream({start(e){e.enqueue({type:"stream-start",warnings:s})},transform(t,a){var r,s,u,d,c,p,g;if(e.includeRawChunks&&a.enqueue({type:"raw",rawValue:t.rawValue}),!t.success)return void a.enqueue({type:"error",error:t.error});let S=t.value,R=S.usageMetadata;null!=R&&(i=R);let I=null==(r=S.candidates)?void 0:r[0];if(null==I)return;let z=I.content,A=f({groundingMetadata:I.groundingMetadata,generateId:v});if(null!=A)for(let e of A)"url"!==e.sourceType||C.has(e.url)||(C.add(e.url),a.enqueue(e));if(null!=z){for(let e of null!=(s=z.parts)?s:[])if("executableCode"in e&&(null==(u=e.executableCode)?void 0:u.code)){let t=v();o=t,a.enqueue({type:"tool-call",toolCallId:t,toolName:"code_execution",input:JSON.stringify(e.executableCode),providerExecuted:!0}),y=!0}else if("codeExecutionResult"in e&&e.codeExecutionResult){let t=o;t&&(a.enqueue({type:"tool-result",toolCallId:t,toolName:"code_execution",result:{outcome:e.codeExecutionResult.outcome,output:e.codeExecutionResult.output}}),o=void 0)}else"text"in e&&null!=e.text&&e.text.length>0?!0===e.thought?(null!==E&&(a.enqueue({type:"text-end",id:E}),E=null),null===b&&(b=String(T++),a.enqueue({type:"reasoning-start",id:b,providerMetadata:e.thoughtSignature?{[l]:{thoughtSignature:e.thoughtSignature}}:void 0})),a.enqueue({type:"reasoning-delta",id:b,delta:e.text,providerMetadata:e.thoughtSignature?{[l]:{thoughtSignature:e.thoughtSignature}}:void 0})):(null!==b&&(a.enqueue({type:"reasoning-end",id:b}),b=null),null===E&&(E=String(T++),a.enqueue({type:"text-start",id:E,providerMetadata:e.thoughtSignature?{[l]:{thoughtSignature:e.thoughtSignature}}:void 0})),a.enqueue({type:"text-delta",id:E,delta:e.text,providerMetadata:e.thoughtSignature?{[l]:{thoughtSignature:e.thoughtSignature}}:void 0})):"inlineData"in e&&a.enqueue({type:"file",mediaType:e.inlineData.mimeType,data:e.inlineData.data});let e=function({parts:e,generateId:t,providerOptionsName:o}){let i=null==e?void 0:e.filter(e=>"functionCall"in e);return null==i||0===i.length?void 0:i.map(e=>({type:"tool-call",toolCallId:t(),toolName:e.functionCall.name,args:JSON.stringify(e.functionCall.args),providerMetadata:e.thoughtSignature?{[o]:{thoughtSignature:e.thoughtSignature}}:void 0}))}({parts:z.parts,generateId:v,providerOptionsName:l});if(null!=e)for(let t of e)a.enqueue({type:"tool-input-start",id:t.toolCallId,toolName:t.toolName,providerMetadata:t.providerMetadata}),a.enqueue({type:"tool-input-delta",id:t.toolCallId,delta:t.args,providerMetadata:t.providerMetadata}),a.enqueue({type:"tool-input-end",id:t.toolCallId,providerMetadata:t.providerMetadata}),a.enqueue({type:"tool-call",toolCallId:t.toolCallId,toolName:t.toolName,input:t.args,providerMetadata:t.providerMetadata}),y=!0}null!=I.finishReason&&(m={unified:h({finishReason:I.finishReason,hasToolCalls:y}),raw:I.finishReason},n={[l]:{promptFeedback:null!=(d=S.promptFeedback)?d:null,groundingMetadata:null!=(c=I.groundingMetadata)?c:null,urlContextMetadata:null!=(p=I.urlContextMetadata)?p:null,safetyRatings:null!=(g=I.safetyRatings)?g:null}},null!=R&&(n[l].usageMetadata=R))},flush(e){null!==E&&e.enqueue({type:"text-end",id:E}),null!==b&&e.enqueue({type:"reasoning-end",id:b}),e.enqueue({type:"finish",finishReason:m,usage:d(i),providerMetadata:n})}})),response:{headers:c},request:{body:r}}}};function f({groundingMetadata:e,generateId:t}){var o,i,n,a,r;if(!(null==e?void 0:e.groundingChunks))return;let s=[];for(let l of e.groundingChunks)if(null!=l.web)s.push({type:"source",sourceType:"url",id:t(),url:l.web.uri,title:null!=(o=l.web.title)?o:void 0});else if(null!=l.retrievedContext){let e=l.retrievedContext.uri,o=l.retrievedContext.fileSearchStore;if(e&&(e.startsWith("http://")||e.startsWith("https://")))s.push({type:"source",sourceType:"url",id:t(),url:e,title:null!=(i=l.retrievedContext.title)?i:void 0});else if(e){let o,i=null!=(n=l.retrievedContext.title)?n:"Unknown Document",a="application/octet-stream";e.endsWith(".pdf")?a="application/pdf":e.endsWith(".txt")?a="text/plain":e.endsWith(".docx")?a="application/vnd.openxmlformats-officedocument.wordprocessingml.document":e.endsWith(".doc")?a="application/msword":e.match(/\.(md|markdown)$/)&&(a="text/markdown"),o=e.split("/").pop(),s.push({type:"source",sourceType:"document",id:t(),mediaType:a,title:i,filename:o})}else if(o){let e=null!=(a=l.retrievedContext.title)?a:"Unknown Document";s.push({type:"source",sourceType:"document",id:t(),mediaType:"application/octet-stream",title:e,filename:o.split("/").pop()})}}else null!=l.maps&&l.maps.uri&&s.push({type:"source",sourceType:"url",id:t(),url:l.maps.uri,title:null!=(r=l.maps.title)?r:void 0});return s.length>0?s:void 0}var v=()=>i.z.object({webSearchQueries:i.z.array(i.z.string()).nullish(),retrievalQueries:i.z.array(i.z.string()).nullish(),searchEntryPoint:i.z.object({renderedContent:i.z.string()}).nullish(),groundingChunks:i.z.array(i.z.object({web:i.z.object({uri:i.z.string(),title:i.z.string().nullish()}).nullish(),retrievedContext:i.z.object({uri:i.z.string().nullish(),title:i.z.string().nullish(),text:i.z.string().nullish(),fileSearchStore:i.z.string().nullish()}).nullish(),maps:i.z.object({uri:i.z.string().nullish(),title:i.z.string().nullish(),text:i.z.string().nullish(),placeId:i.z.string().nullish()}).nullish()})).nullish(),groundingSupports:i.z.array(i.z.object({segment:i.z.object({startIndex:i.z.number().nullish(),endIndex:i.z.number().nullish(),text:i.z.string().nullish()}),segment_text:i.z.string().nullish(),groundingChunkIndices:i.z.array(i.z.number()).nullish(),supportChunkIndices:i.z.array(i.z.number()).nullish(),confidenceScores:i.z.array(i.z.number()).nullish(),confidenceScore:i.z.array(i.z.number()).nullish()})).nullish(),retrievalMetadata:i.z.union([i.z.object({webDynamicRetrievalScore:i.z.number()}),i.z.object({})]).nullish()}),y=()=>i.z.object({parts:i.z.array(i.z.union([i.z.object({functionCall:i.z.object({name:i.z.string(),args:i.z.unknown()}),thoughtSignature:i.z.string().nullish()}),i.z.object({inlineData:i.z.object({mimeType:i.z.string(),data:i.z.string()}),thoughtSignature:i.z.string().nullish()}),i.z.object({executableCode:i.z.object({language:i.z.string(),code:i.z.string()}).nullish(),codeExecutionResult:i.z.object({outcome:i.z.string(),output:i.z.string()}).nullish(),text:i.z.string().nullish(),thought:i.z.boolean().nullish(),thoughtSignature:i.z.string().nullish()})])).nullish()}),E=()=>i.z.object({category:i.z.string().nullish(),probability:i.z.string().nullish(),probabilityScore:i.z.number().nullish(),severity:i.z.string().nullish(),severityScore:i.z.number().nullish(),blocked:i.z.boolean().nullish()}),b=i.z.object({cachedContentTokenCount:i.z.number().nullish(),thoughtsTokenCount:i.z.number().nullish(),promptTokenCount:i.z.number().nullish(),candidatesTokenCount:i.z.number().nullish(),totalTokenCount:i.z.number().nullish(),trafficType:i.z.string().nullish()}),T=()=>i.z.object({urlMetadata:i.z.array(i.z.object({retrievedUrl:i.z.string(),urlRetrievalStatus:i.z.string()}))}),C=(0,t.lazySchema)(()=>(0,t.zodSchema)(i.z.object({candidates:i.z.array(i.z.object({content:y().nullish().or(i.z.object({}).strict()),finishReason:i.z.string().nullish(),safetyRatings:i.z.array(E()).nullish(),groundingMetadata:v().nullish(),urlContextMetadata:T().nullish()})),usageMetadata:b.nullish(),promptFeedback:i.z.object({blockReason:i.z.string().nullish(),safetyRatings:i.z.array(E()).nullish()}).nullish()}))),S=(0,t.lazySchema)(()=>(0,t.zodSchema)(i.z.object({candidates:i.z.array(i.z.object({content:y().nullish(),finishReason:i.z.string().nullish(),safetyRatings:i.z.array(E()).nullish(),groundingMetadata:v().nullish(),urlContextMetadata:T().nullish()})).nullish(),usageMetadata:b.nullish(),promptFeedback:i.z.object({blockReason:i.z.string().nullish(),safetyRatings:i.z.array(E()).nullish()}).nullish()}))),R=(0,t.createProviderToolFactoryWithOutputSchema)({id:"google.code_execution",inputSchema:i.z.object({language:i.z.string().describe("The programming language of the code."),code:i.z.string().describe("The code to be executed.")}),outputSchema:i.z.object({outcome:i.z.string().describe('The outcome of the execution (e.g., "OUTCOME_OK").'),output:i.z.string().describe("The output from the code execution.")})}),I=(0,t.createProviderToolFactory)({id:"google.enterprise_web_search",inputSchema:(0,t.lazySchema)(()=>(0,t.zodSchema)(i.z.object({})))}),z=i.z.object({fileSearchStoreNames:i.z.array(i.z.string()).describe("The names of the file_search_stores to retrieve from. Example: `fileSearchStores/my-file-search-store-123`"),topK:i.z.number().int().positive().describe("The number of file search retrieval chunks to retrieve.").optional(),metadataFilter:i.z.string().describe("Metadata filter to apply to the file search retrieval documents. See https://google.aip.dev/160 for the syntax of the filter expression.").optional()}).passthrough(),A=(0,t.lazySchema)(()=>(0,t.zodSchema)(z)),O=(0,t.createProviderToolFactory)({id:"google.file_search",inputSchema:A}),x=(0,t.createProviderToolFactory)({id:"google.google_maps",inputSchema:(0,t.lazySchema)(()=>(0,t.zodSchema)(i.z.object({})))}),w=(0,t.createProviderToolFactory)({id:"google.google_search",inputSchema:(0,t.lazySchema)(()=>(0,t.zodSchema)(i.z.object({mode:i.z.enum(["MODE_DYNAMIC","MODE_UNSPECIFIED"]).default("MODE_UNSPECIFIED"),dynamicThreshold:i.z.number().default(1)})))}),N={googleSearch:w,enterpriseWebSearch:I,googleMaps:x,urlContext:(0,t.createProviderToolFactory)({id:"google.url_context",inputSchema:(0,t.lazySchema)(()=>(0,t.zodSchema)(i.z.object({})))}),fileSearch:O,codeExecution:R,vertexRagStore:(0,t.createProviderToolFactory)({id:"google.vertex_rag_store",inputSchema:i.z.object({ragCorpus:i.z.string(),topK:i.z.number().optional()})})},M=class{constructor(e,t,o){this.modelId=e,this.settings=t,this.config=o,this.specificationVersion="v3"}get maxImagesPerCall(){var e;return null!=(e=this.settings.maxImagesPerCall)?e:4}get provider(){return this.config.provider}async doGenerate(e){var o,i,n;let{prompt:r,n:s=1,size:l,aspectRatio:u="1:1",seed:d,providerOptions:c,headers:p,abortSignal:g,files:h,mask:m}=e,f=[];if(null!=h&&h.length>0)throw Error("Google Generative AI does not support image editing. Use Google Vertex AI (@ai-sdk/google-vertex) for image editing capabilities.");if(null!=m)throw Error("Google Generative AI does not support image editing with masks. Use Google Vertex AI (@ai-sdk/google-vertex) for image editing capabilities.");null!=l&&f.push({type:"unsupported",feature:"size",details:"This model does not support the `size` option. Use `aspectRatio` instead."}),null!=d&&f.push({type:"unsupported",feature:"seed",details:"This model does not support the `seed` option through this provider."});let v=await (0,t.parseProviderOptions)({provider:"google",providerOptions:c,schema:D}),y=null!=(n=null==(i=null==(o=this.config._internal)?void 0:o.currentDate)?void 0:i.call(o))?n:new Date,E={sampleCount:s};null!=u&&(E.aspectRatio=u),v&&Object.assign(E,v);let{responseHeaders:b,value:T}=await (0,t.postJsonToApi)({url:`${this.config.baseURL}/models/${this.modelId}:predict`,headers:(0,t.combineHeaders)(await (0,t.resolve)(this.config.headers),p),body:{instances:[{prompt:r}],parameters:E},failedResponseHandler:a,successfulResponseHandler:(0,t.createJsonResponseHandler)(_),abortSignal:g,fetch:this.config.fetch});return{images:T.predictions.map(e=>e.bytesBase64Encoded),warnings:null!=f?f:[],providerMetadata:{google:{images:T.predictions.map(e=>({}))}},response:{timestamp:y,modelId:this.modelId,headers:b}}}},_=(0,t.lazySchema)(()=>(0,t.zodSchema)(i.z.object({predictions:i.z.array(i.z.object({bytesBase64Encoded:i.z.string()})).default([])}))),D=(0,t.lazySchema)(()=>(0,t.zodSchema)(i.z.object({personGeneration:i.z.enum(["dont_allow","allow_adult","allow_all"]).nullish(),aspectRatio:i.z.enum(["1:1","3:4","4:3","9:16","16:9"]).nullish()})));function L(e={}){var o,i;let n=null!=(o=(0,t.withoutTrailingSlash)(e.baseURL))?o:"https://generativelanguage.googleapis.com/v1beta",a=null!=(i=e.name)?i:"google.generative-ai",r=()=>(0,t.withUserAgentSuffix)({"x-goog-api-key":(0,t.loadApiKey)({apiKey:e.apiKey,environmentVariableName:"GOOGLE_GENERATIVE_AI_API_KEY",description:"Google Generative AI"}),...e.headers},"ai-sdk/google/3.0.2"),l=o=>{var i;return new m(o,{provider:a,baseURL:n,headers:r,generateId:null!=(i=e.generateId)?i:t.generateId,supportedUrls:()=>({"*":[RegExp(`^${n}/files/.*$`),RegExp("^https://(?:www\\.)?youtube\\.com/watch\\?v=[\\w-]+(?:&[\\w=&.-]*)?$"),RegExp("^https://youtu\\.be/[\\w-]+(?:\\?[\\w=&.-]*)?$")]}),fetch:e.fetch})},u=t=>new s(t,{provider:a,baseURL:n,headers:r,fetch:e.fetch}),d=(t,o={})=>new M(t,o,{provider:a,baseURL:n,headers:r,fetch:e.fetch}),c=function(e){if(new.target)throw Error("The Google Generative AI model function cannot be called with the new keyword.");return l(e)};return c.specificationVersion="v3",c.languageModel=l,c.chat=l,c.generativeAI=l,c.embedding=u,c.embeddingModel=u,c.textEmbedding=u,c.textEmbeddingModel=u,c.image=d,c.imageModel=d,c.tools=N,c}L(),e.s(["createGoogleGenerativeAI",()=>L])},12113,e=>e.a(async(t,o)=>{try{var i=e.i(11227),n=e.i(12075),a=e.i(68184),r=e.i(93112),s=e.i(18737),l=t([a,r,s]);[a,r,s]=l.then?(await l)():l;let d=`[CORE IDENTITY]
You are SYD - ARCHITETTO PERSONALE, an advanced construction and design assistant.
Language: Italian.
Primary Rule: Classify intent immediately: MODE A (Designer) or MODE B (Surveyor).

[INTERACTION RULES]
1. **GREETINGS (Ciao)**: If the user says "Ciao" or greetings, DO NOT introduce yourself (you already did). Just answer: "Ciao! Come posso aiutarti con il tuo progetto?".
2. **QUESTION LIMIT**: Ask MAXIMUM 1 or 2 questions at a time. NEVER ask a long list of questions. Wait for the user's answer before proceeding.

[PHOTO UPLOAD DISAMBIGUATION]
**CRITICAL RULE**: If the user's intent is UNCLEAR (e.g., uploads photo with only "Ciao", generic greetings, or vague text):
1. DO NOT assume MODE A or MODE B
2. MUST ask explicitly which service they want:

Response Template:
"Ciao! Ho ricevuto la tua foto. Come posso aiutarti?

1. ðŸŽ¨ **Visualizzare** come verrebbe ristrutturato con un rendering 3D
2. ðŸ“‹ **Ricevere un preventivo** dettagliato per i lavori

Cosa preferisci?"

**WAIT for user's choice** before proceeding to MODE A or MODE B.


[EXISTING TOOL INSTRUCTIONS]
##  ANALISI IMMAGINI UPLOAD (FOTO UTENTE)

Quando l'utente carica una foto:
1. **ANALIZZA SUBITO** la foto.
2. **DESCRIVI** esplicitamente cosa vedi.
3. **NON GENERARE** ancora. Avvia il protocollo "Discovery" (vedi Mode A).

## ISTRUZIONI PER IL TOOL generate_render

**STEP 1 - structuralElements (OBBLIGATORIO):**
Prima di tutto, devi compilare il campo \`structuralElements\` con TUTTI gli elementi strutturali:
- Se l'utente ha caricato una FOTO: descrivi gli elementi visibili (es. "arched window on left wall, wooden ceiling beams, parquet floor")
- Se NON c'\xe8 foto: descrivi gli elementi richiesti nella conversazione
- Scrivi in INGLESE e sii SPECIFICO

**STEP 2 - roomType & style:**
Compila questi campi in INGLESE (es. "living room", "modern")

**STEP 3 - prompt (DEVE iniziare con structuralElements):**
Il prompt DEVE iniziare descrivendo gli elementi di STEP 1.

## ðŸ”€ SCELTA MODALIT\xc0 (mode)

### MODE: "creation" (Creazione da zero)
Usa quando l'utente NON ha caricato una foto

### MODE: "modification" (Modifica foto esistente)
Usa quando l'utente HA CARICATO una foto.
DEVI compilare \`sourceImageUrl\`:
1. Cerca nella cronologia il marker: \`[Immagine allegata: https://storage.googleapis.com/...]\`
2. Estrai l'URL dal marker

---

MODE A: THE DESIGNER (Rendering & Visual Flow)

Trigger: User wants to "visualize", "imagine", "see ideas", "style advice".

Scenario 1: Starting from Photo (Hybrid Vision) - STRICT PROTOCOL

Action:
1. ANALYZE (Silent): Identify structural constraints (windows, beams) from the image.
2. DISCOVERY (Mandatory): BEFORE generating, you MUST ask:
   - "Cosa vuoi MANTENERE? (es. pavimento, infissi)"
   - "Cosa vuoi CAMBIARE? (es. stile, colori)"
3. STOP & WAIT: Do NOT call 'generate_render' yet. You need these answers first.
4. GENERATE: Only AFTER the user replies to these questions, call 'generate_render'.
   - CRITICAL: You MUST populate the 'keepElements' parameter with the specific items the user wants to maintain (e.g., ["camino", "scuro", "pavimento"]).

Scenario 2: Starting from Zero

Action: Guide imagination (Room Type, Style, Key Elements).
Generate: Create a descriptive prompt from scratch.

---

MODE B: THE TECHNICAL SURVEYOR (Quote & Preventivo Flow)

Trigger: User wants "quote", "cost", "work details", "renovation".

Persona: You are a Technical Surveyor (Tecnico Rilevatore). Dry, precise, analytical.

Strict Rule: DO NOT ask for Budget or Timeline. Focus ONLY on Technical Specs.

THE CONVERGENCE PROTOCOL (Applies to BOTH Scenarios below):
You must ALWAYS gather these 3 Data Clusters before finishing. Do not skip any.

1. Logistics: (Floor, Elevator, Year of construction, Ceiling height).
2. Scope of Work: (Demolitions, Electrical/Plumbing status, Fixtures quantity).
3. Quantities: (Exact MQ/Metri Quadri and number of points).

Scenario 1: Starting from Photo

Action: Analyze -> Verify -> Converge.

- Analyze: Use the photo to identify the Current State. "Vedo pavimento in marmo e infissi in legno."
- Verify: Ask regarding the visual elements. "Intendi demolire questo pavimento o sovrapporre? Gli infissi che vedo vanno sostituiti?"
- Converge: IMMEDIATELY proceed to ask the missing "Protocol" questions that the photo cannot show (Logistics, Year, Exact MQ, Systems hidden in walls). Treat the photo as evidence, but complete the full questionnaire.

Scenario 2: Starting from Zero

Action: Execute the "Convergence Protocol" question by question.

Output (Mode B): End with a structured list: "Riepilogo Tecnico per Preventivo" containing all gathered Metrics and Works.

[STATE MACHINE & TRANSITIONS]
Track session state based on tools used and conversation history:

STATE 1: VISUAL_ONLY (Render generated, No Quote)
- Condition: generate_render was called successfully
- NEXT ACTION: You MUST propose Mode B (Technical Quote)
- Prompt: "Ti piace questo stile? Se vuoi, posso prepararti un preventivo gratuito per realizzarlo. Ti servono solo pochi dettagli tecnici."

STATE 2: TECHNICAL_ONLY (Quote/Data done, No Render)
- Condition: submit_lead_data was called successfully
- CHECK: Has render been generated for THIS project in conversation history?
- NEXT ACTION: Offer dual choice based on render existence

  SCENARIO A (Render MISSING):
  "Dati salvati correttamente! Ora abbiamo due strade:
  1. ðŸŽ¨ **Visualizzare**: Vuoi vedere un Rendering 3D di come verrebbe?
  2. ðŸ’° **Prezzi Reali**: Vuoi che cerchi i prezzi di mercato attuali per i materiali o gli arredi di cui abbiamo parlato?
  Dimmi tu come preferisci procedere."
  
  SCENARIO B (Render ALREADY DONE in history):
  "Dati salvati! Visto che abbiamo gi\xe0 il rendering, vuoi che cerchi i **prezzi reali di mercato** per gli elementi (pavimenti, arredi) che abbiamo visualizzato, per darti una stima dei costi d'acquisto?"

STATE 3: COMPLETE (Both Render AND Quote/Data exist)
- Condition: Both generate_render AND submit_lead_data were called successfully in this session
- NEXT ACTION: STOP proposing new flows. Focus on refining details or closing.
- Prompt: "Abbiamo tutto: progetto visivo e stima tecnica. Come vuoi procedere?"

**ANTI-LOOP RULE:**
Never propose a flow that has already been completed in the current session.
If user has already generated render, DO NOT propose it again.
If user has already submitted quote data, DO NOT propose it again.
`;async function u(t){console.log("---> API /api/chat HIT");let o=(t.headers.get("x-forwarded-for")??"127.0.0.1").split(",")[0],{allowed:a,remaining:l,resetAt:u}=await (0,s.checkRateLimit)(o);if(!a)return console.warn(`[RateLimit] IP ${o} exceeded rate limit`),new Response("Too Many Requests - Please wait before trying again",{status:429,headers:{"Content-Type":"text/plain","X-RateLimit-Limit":"20","X-RateLimit-Remaining":l.toString(),"X-RateLimit-Reset":u.toISOString(),"Retry-After":Math.ceil((u.getTime()-Date.now())/1e3).toString()}});console.log(`[RateLimit] IP ${o} allowed - ${l} requests remaining`);try{let{messages:o,images:a,imageUrls:s,sessionId:c}=await t.json();if(!c||"string"!=typeof c||0===c.trim().length)return console.error("[API] Missing or invalid sessionId"),new Response(JSON.stringify({error:"sessionId is required",details:"A valid session identifier must be provided"}),{status:400,headers:{"Content-Type":"application/json"}});console.log("API Request Debug:",{hasMessages:!!o,messagesLength:o?.length,hasImages:!!a,hasImageUrls:!!s,imageUrlsCount:s?.length||0,sessionId:c}),await (0,r.ensureSession)(c);let p=await (0,r.getConversationContext)(c,10),g=Array.isArray(o)?o:[],h=g[g.length-1];console.log("ðŸ” [DEBUG RAW MESSAGE]:",JSON.stringify(h,null,2));let m=[...p,{role:h?.role||"user",content:h?.content||""}];if(a&&Array.isArray(a)&&a.length>0){let e=m[m.length-1];if(e&&"user"===e.role){let t="string"==typeof e.content?e.content:"";e.content=[{type:"text",text:t},...a.map(e=>({type:"image",image:e}))]}}let f=h?.parts&&Array.isArray(h.parts)?h.parts.filter(e=>"text"===e.type).map(e=>e.text).join("\n"):h?.content&&Array.isArray(h.content)?h.content.filter(e=>"text"===e.type).map(e=>e.text).join("\n"):"string"==typeof h?.content?h.content:"";if(a&&Array.isArray(a)&&a.length>0)if(s&&Array.isArray(s)&&s.length>0){let e=s[0];f+=` [Immagine allegata: ${e}]`,console.log("[API] âœ… Appended [Immagine allegata] marker with public URL:",e)}else f+=" [Immagine allegata]",console.log("[API] Appended [Immagine allegata] marker (no public URL available)");console.log("[Firestore] Attempting to save user message...",{sessionId:c,content:f.substring(0,50)}),console.log(`[API] Parsed User Message: "${f}"`),(0,r.saveMessage)(c,"user",f).then(()=>console.log("[Firestore] âœ… User message saved successfully")).catch(e=>{console.error("[Firestore] âŒ ERROR saving user message:",e),console.error("[Firestore] Error details:",{message:e.message,stack:e.stack,code:e.code})});let v=(0,i.createGoogleGenerativeAI)({apiKey:process.env.GEMINI_API_KEY||""});m.map(e=>"string"==typeof e.content?e.content.toLowerCase():"").join(" ");let{createChatTools:y}=await e.A(79911),E=y(c);console.log("[Tools] âœ… Tools ENABLEED (always available)");let b=new ReadableStream({async start(e){let t=(t,o)=>{let i=JSON.stringify(o);e.enqueue(new TextEncoder().encode(`${t}:${i} 
`))},o="";try{for await(let e of(0,n.streamText)({model:v(process.env.CHAT_MODEL_VERSION||"gemini-2.5-flash"),system:d,messages:m,tools:E,maxSteps:5,maxToolRoundtrips:2,experimental_providerMetadata:{sessionId:c},async onToolCall({toolCall:e,toolResult:i}){if(console.log("ðŸ”§ [Tool Call]",e.toolName),"get_market_prices"===e.toolName&&i){let e="string"==typeof i?i:JSON.stringify(i);console.log("ðŸ“¤ [Direct Stream] Writing market prices directly to chat"),t("0",e),o+=e}},onFinish:async({text:e,toolResults:t})=>{console.log("[onFinish] ðŸ” Streamed Content Length:",o.length),console.log("[onFinish] Saving assistant message");try{await (0,r.saveMessage)(c,"assistant",o,{toolCalls:t?.map(e=>({name:e.toolName||"unknown",args:e.args||{},result:e.result||{}}))}),console.log("[onFinish] âœ… Message saved successfully")}catch(e){console.error("[onFinish] âŒ CRITICAL: Failed to save message",e)}}}).fullStream){if("text-delta"===e.type&&(o+=e.text,t("0",e.text)),"tool-result"===e.type&&"get_market_prices"===e.toolName)try{let i=e.result||e.output,n="string"==typeof i?i:JSON.stringify(i);console.log("ðŸ“¤ [Market Prices] Writing directly to stream"),console.log("ðŸ“¤ [Market Prices] Content length:",n.length),t("0",n),o+=n}catch(e){console.error("âŒ [Market Prices] Failed to write to stream:",e)}if("tool-result"===e.type&&"generate_render"===e.toolName)try{let i=e.result||e.output;if(i?.status==="error"){let e="\n\nâš ï¸ Mi dispiace, il servizio di rendering Ã¨ temporaneamente non disponibile. Riprova tra qualche minuto.\n\n";console.error("[Stream] Tool returned error:",i.error),o+=e,t("0",e)}else if(i?.status==="success"&&i?.imageUrl){let e=`

![](${i.imageUrl}) 

`;console.log("[Stream] Injecting image to stream:",i.imageUrl),o+=e,t("0",e)}else{let e="\n\nâš ï¸ Si Ã¨ verificato un errore imprevisto. Riprova.\n\n";console.warn("[Stream] Unexpected tool result format:",i),o+=e,t("0",e)}}catch(i){let e="\n\nâš ï¸ Si Ã¨ verificato un errore durante la generazione. Riprova.\n\n";console.error("[Stream] Error processing tool result:",i),o+=e,t("0",e)}if("tool-call"===e.type){let o={toolCallId:e.toolCallId,toolName:e.toolName,args:e.args||e.input||{}};t("9",o)}if("tool-result"===e.type){let o={toolCallId:e.toolCallId,result:e.result};t("a",o)}}e.close()}catch(o){t("3",{error:o.message}),console.error("Stream Error:",o),e.close()}}});return new Response(b,{status:200,headers:{"Content-Type":"text/plain; charset=utf-8","X-Vercel-AI-Data-Stream":"v1","X-RateLimit-Limit":"20","X-RateLimit-Remaining":l.toString(),"X-RateLimit-Reset":u.toISOString()}})}catch(e){return console.error("Chat API Error Details:",e),new Response(JSON.stringify({error:"Internal Server Error",details:e.message,stack:e.stack}),{status:500,headers:{"Content-Type":"application/json"}})}}e.s(["POST",()=>u,"dynamic",0,"force-dynamic","maxDuration",0,60,"runtime",0,"nodejs"]),o()}catch(e){o(e)}},!1),63194,e=>e.a(async(t,o)=>{try{var i=e.i(47909),n=e.i(74017),a=e.i(96250),r=e.i(59756),s=e.i(61916),l=e.i(14444),u=e.i(37092),d=e.i(69741),c=e.i(16795),p=e.i(87718),g=e.i(95169),h=e.i(47587),m=e.i(66012),f=e.i(70101),v=e.i(74838),y=e.i(10372),E=e.i(93695);e.i(52474);var b=e.i(220),T=e.i(12113),C=t([T]);[T]=C.then?(await C)():C;let I=new i.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/chat/route",pathname:"/api/chat",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/web_client/app/api/chat/route.ts",nextConfigOutput:"",userland:T}),{workAsyncStorage:z,workUnitAsyncStorage:A,serverHooks:O}=I;function S(){return(0,a.patchFetch)({workAsyncStorage:z,workUnitAsyncStorage:A})}async function R(e,t,o){I.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/chat/route";i=i.replace(/\/index$/,"")||"/";let a=await I.prepare(e,t,{srcPage:i,multiZoneDraftMode:!1});if(!a)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:T,params:C,nextConfig:S,parsedUrl:R,isDraftMode:z,prerenderManifest:A,routerServerContext:O,isOnDemandRevalidate:x,revalidateOnlyGenerated:w,resolvedPathname:N,clientReferenceManifest:M,serverActionsManifest:_}=a,D=(0,d.normalizeAppPath)(i),L=!!(A.dynamicRoutes[D]||A.routes[N]),k=async()=>((null==O?void 0:O.render404)?await O.render404(e,t,R,!1):t.end("This page could not be found"),null);if(L&&!z){let e=!!A.routes[N],t=A.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await k();throw new E.NoFallbackError}}let U=null;!L||I.isDev||z||(U=N,U="/index"===U?"/":U);let P=!0===I.isDev||!L,j=L&&!P;_&&M&&(0,l.setReferenceManifestsSingleton)({page:i,clientReferenceManifest:M,serverActionsManifest:_,serverModuleMap:(0,u.createServerModuleMap)({serverActionsManifest:_})});let H=e.method||"GET",G=(0,s.getTracer)(),F=G.getActiveScopeSpan(),q={params:C,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:P,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,o,i)=>I.onRequestError(e,t,i,O)},sharedContext:{buildId:T}},V=new c.NodeNextRequest(e),B=new c.NodeNextResponse(t),$=p.NextRequestAdapter.fromNodeNextRequest(V,(0,p.signalFromNodeResponse)(t));try{let a=async e=>I.handle($,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let o=G.getRootSpanAttributes();if(!o)return;if(o.get("next.span_type")!==g.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${o.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=o.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${i}`)}),l=!!(0,r.getRequestMeta)(e,"minimalMode"),u=async r=>{var s,u;let d=async({previousCacheEntry:n})=>{try{if(!l&&x&&w&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await a(r);e.fetchMetrics=q.renderOpts.fetchMetrics;let s=q.renderOpts.pendingWaitUntil;s&&o.waitUntil&&(o.waitUntil(s),s=void 0);let u=q.renderOpts.collectedTags;if(!L)return await (0,m.sendResponse)(V,B,i,q.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(i.headers);u&&(t[y.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let o=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,n=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:b.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:o,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:i,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:x})},O),t}},c=await I.handleResponse({req:e,nextConfig:S,cacheKey:U,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:w,responseGenerator:d,waitUntil:o.waitUntil,isMinimalMode:l});if(!L)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==b.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(u=c.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",x?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),z&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,f.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&L||p.delete(y.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,v.getCacheControlHeader)(c.cacheControl)),await (0,m.sendResponse)(V,B,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};F?await u(F):await G.withPropagatedContext(e.headers,()=>G.trace(g.BaseServerSpan.handleRequest,{spanName:`${H} ${i}`,kind:s.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},u))}catch(t){if(t instanceof E.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:x})}),L)throw t;return await (0,m.sendResponse)(V,B,new Response(null,{status:500})),null}}e.s(["handler",()=>R,"patchFetch",()=>S,"routeModule",()=>I,"serverHooks",()=>O,"workAsyncStorage",()=>z,"workUnitAsyncStorage",()=>A]),o()}catch(e){o(e)}},!1)];

//# sourceMappingURL=_2551f978._.js.map