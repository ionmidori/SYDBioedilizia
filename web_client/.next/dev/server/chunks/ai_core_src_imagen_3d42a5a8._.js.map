{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/imagen/imagen_client.ts"],"sourcesContent":["import { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } from '@google/generative-ai';\r\n\r\n/**\r\n * Imagen Client (Gemini API Version)\r\n * \r\n * Uses the Google Generative AI SDK for image renovation via `gemini-3-pro-image-preview`.\r\n */\r\n\r\nexport interface ImagenGenerationRequest {\r\n    /** Base64-encoded input image buffer */\r\n    imageBase64: string;\r\n    /** MIME type of the input image (e.g., 'image/jpeg', 'image/png') */\r\n    mimeType: string;\r\n    /** The complete prompt for image generation */\r\n    prompt: string;\r\n    /** Negative prompt constraints */\r\n    negativePrompt: string;\r\n}\r\n\r\nexport interface ImagenGenerationResponse {\r\n    /** Base64-encoded generated image */\r\n    imageBase64: string;\r\n    /** Generation metadata */\r\n    metadata?: {\r\n        modelVersion?: string;\r\n    };\r\n}\r\n\r\n/**\r\n * Generate a renovation image using Gemini Pro Image Preview via API Key\r\n * \r\n * @param request - Image generation parameters\r\n * @returns Promise containing the generated image as base64\r\n */\r\nexport async function generateImagenRenovation(\r\n    request: ImagenGenerationRequest\r\n): Promise<ImagenGenerationResponse> {\r\n    const apiKey = process.env.GEMINI_API_KEY;\r\n    const modelId = 'gemini-3-pro-image-preview'; // User requested specific model\r\n\r\n    if (!apiKey) {\r\n        throw new Error('[ImagenClient] GEMINI_API_KEY environment variable is required');\r\n    }\r\n\r\n    console.log(`[ImagenClient] Initializing GoogleGenerativeAI (model: ${modelId})...`);\r\n\r\n    const genAI = new GoogleGenerativeAI(apiKey);\r\n    const model = genAI.getGenerativeModel({\r\n        model: modelId,\r\n        // Request image output capability\r\n        generationConfig: {\r\n            responseModalities: ['IMAGE', 'TEXT'],\r\n        } as any, // Cast needed for preview SDK features\r\n        safetySettings: [\r\n            {\r\n                category: HarmCategory.HARM_CATEGORY_HARASSMENT,\r\n                threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH,\r\n            },\r\n            {\r\n                category: HarmCategory.HARM_CATEGORY_HATE_SPEECH,\r\n                threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH,\r\n            },\r\n            {\r\n                category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT,\r\n                threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH,\r\n            },\r\n            {\r\n                category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT,\r\n                threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH,\r\n            },\r\n        ]\r\n    });\r\n\r\n    // Prepare Image Part\r\n    const imagePart = {\r\n        inlineData: {\r\n            data: request.imageBase64,\r\n            mimeType: request.mimeType,\r\n        },\r\n    };\r\n\r\n    // Prepare Prompt with Geometric Base Instruction\r\n    // This simulates \"ControlNet\" (geometry lock) via prompt engineering\r\n    const geometricInstruction = `[INSTRUCTION: Use the visual layout of the attached image as the strict geometric base. Maintain all structural lines, edges, and spatial relationships exactly. Redesign ONLY the surfaces, materials, lighting, and furnishings according to the description below.]`;\r\n\r\n    const fullPrompt = `${geometricInstruction}\\n\\n${request.prompt}\\n\\n[NEGATIVE CONSTRAINTS]: ${request.negativePrompt}`;\r\n\r\n    console.log(`[ImagenClient] Sending multimodal request...`);\r\n    console.log(`  - Prompt Length: ${fullPrompt.length} chars`);\r\n\r\n    try {\r\n        // Generate Content with [Prompt, Image]\r\n        const result = await model.generateContent([fullPrompt, imagePart]);\r\n        const response = await result.response;\r\n\r\n        console.log(`[ImagenClient] Response received`);\r\n\r\n        // Extract Image from Response\r\n        let outputImageBase64: string | null = null;\r\n\r\n        if (response.candidates && response.candidates.length > 0) {\r\n            const parts = response.candidates[0].content.parts;\r\n            for (const part of parts) {\r\n                if (part.inlineData && part.inlineData.mimeType.startsWith('image/')) {\r\n                    outputImageBase64 = part.inlineData.data;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (!outputImageBase64) {\r\n            console.error('[ImagenClient] No image found in response parts:', JSON.stringify(response, null, 2));\r\n            throw new Error('No image data returned from Gemini API');\r\n        }\r\n\r\n        const imageSizeKb = (outputImageBase64.length * 0.75 / 1024).toFixed(2);\r\n        console.log(`[ImagenClient] ✅ Generation complete! Image size: ~${imageSizeKb} KB`);\r\n\r\n        return {\r\n            imageBase64: outputImageBase64,\r\n            metadata: {\r\n                modelVersion: modelId,\r\n            },\r\n        };\r\n\r\n    } catch (error: any) {\r\n        console.error('[ImagenClient] ❌ API error:', error);\r\n        throw new Error(`Gemini generation failed: ${error.message || error} `);\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAkCO,eAAe,yBAClB,OAAgC;IAEhC,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc;IACzC,MAAM,UAAU,8BAA8B,gCAAgC;IAE9E,IAAI,CAAC,QAAQ;QACT,MAAM,IAAI,MAAM;IACpB;IAEA,QAAQ,GAAG,CAAC,CAAC,uDAAuD,EAAE,QAAQ,IAAI,CAAC;IAEnF,MAAM,QAAQ,IAAI,sLAAkB,CAAC;IACrC,MAAM,QAAQ,MAAM,kBAAkB,CAAC;QACnC,OAAO;QACP,kCAAkC;QAClC,kBAAkB;YACd,oBAAoB;gBAAC;gBAAS;aAAO;QACzC;QACA,gBAAgB;YACZ;gBACI,UAAU,gLAAY,CAAC,wBAAwB;gBAC/C,WAAW,sLAAkB,CAAC,eAAe;YACjD;YACA;gBACI,UAAU,gLAAY,CAAC,yBAAyB;gBAChD,WAAW,sLAAkB,CAAC,eAAe;YACjD;YACA;gBACI,UAAU,gLAAY,CAAC,+BAA+B;gBACtD,WAAW,sLAAkB,CAAC,eAAe;YACjD;YACA;gBACI,UAAU,gLAAY,CAAC,+BAA+B;gBACtD,WAAW,sLAAkB,CAAC,eAAe;YACjD;SACH;IACL;IAEA,qBAAqB;IACrB,MAAM,YAAY;QACd,YAAY;YACR,MAAM,QAAQ,WAAW;YACzB,UAAU,QAAQ,QAAQ;QAC9B;IACJ;IAEA,iDAAiD;IACjD,qEAAqE;IACrE,MAAM,uBAAuB,CAAC,sQAAsQ,CAAC;IAErS,MAAM,aAAa,GAAG,qBAAqB,IAAI,EAAE,QAAQ,MAAM,CAAC,4BAA4B,EAAE,QAAQ,cAAc,EAAE;IAEtH,QAAQ,GAAG,CAAC,CAAC,4CAA4C,CAAC;IAC1D,QAAQ,GAAG,CAAC,CAAC,mBAAmB,EAAE,WAAW,MAAM,CAAC,MAAM,CAAC;IAE3D,IAAI;QACA,wCAAwC;QACxC,MAAM,SAAS,MAAM,MAAM,eAAe,CAAC;YAAC;YAAY;SAAU;QAClE,MAAM,WAAW,MAAM,OAAO,QAAQ;QAEtC,QAAQ,GAAG,CAAC,CAAC,gCAAgC,CAAC;QAE9C,8BAA8B;QAC9B,IAAI,oBAAmC;QAEvC,IAAI,SAAS,UAAU,IAAI,SAAS,UAAU,CAAC,MAAM,GAAG,GAAG;YACvD,MAAM,QAAQ,SAAS,UAAU,CAAC,EAAE,CAAC,OAAO,CAAC,KAAK;YAClD,KAAK,MAAM,QAAQ,MAAO;gBACtB,IAAI,KAAK,UAAU,IAAI,KAAK,UAAU,CAAC,QAAQ,CAAC,UAAU,CAAC,WAAW;oBAClE,oBAAoB,KAAK,UAAU,CAAC,IAAI;oBACxC;gBACJ;YACJ;QACJ;QAEA,IAAI,CAAC,mBAAmB;YACpB,QAAQ,KAAK,CAAC,oDAAoD,KAAK,SAAS,CAAC,UAAU,MAAM;YACjG,MAAM,IAAI,MAAM;QACpB;QAEA,MAAM,cAAc,CAAC,kBAAkB,MAAM,GAAG,OAAO,IAAI,EAAE,OAAO,CAAC;QACrE,QAAQ,GAAG,CAAC,CAAC,mDAAmD,EAAE,YAAY,GAAG,CAAC;QAElF,OAAO;YACH,aAAa;YACb,UAAU;gBACN,cAAc;YAClB;QACJ;IAEJ,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,MAAM,IAAI,MAAM,CAAC,0BAA0B,EAAE,MAAM,OAAO,IAAI,MAAM,CAAC,CAAC;IAC1E;AACJ"}},
    {"offset": {"line": 99, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/imagen/generator.ts"],"sourcesContent":["\r\nimport { ArchitectOutput } from '../vision/architect';\r\nimport { generateImagenRenovation } from './imagen_client';\r\n\r\n/**\r\n * Builds a professional narrative prompt from ArchitectOutput using Positive Anchoring.\r\n * Implements the \"Skeleton & Skin\" methodology.\r\n * \r\n * @param architectData - Output from the Architect containing skeleton, materials, and furnishing\r\n * @param style - Target style name (e.g., \"Japandi\", \"Industrial\")\r\n * @returns Fluent narrative prompt for image generation\r\n */\r\nfunction buildProfessionalPrompt(architectData: ArchitectOutput, style: string): string {\r\n    // Block 1: Context & Subject\r\n    const context = `Professional architectural photography of a ${style} living space, shot for an interior design magazine.`;\r\n\r\n    // Block 2: Structural Anchoring (The Skeleton)\r\n    // Describes the geometry Gemini MUST see and respect\r\n    // Note: structuralSkeleton already starts with \"The room features...\"\r\n    const structure = architectData.structuralSkeleton;\r\n\r\n    // Block 3: Material Application (The New Skin)\r\n    const surfaces = `The space is finished with ${architectData.materialPlan}.`;\r\n\r\n    // Block 4: Furnishing & Atmosphere\r\n    const decor = `The area is furnished with ${architectData.furnishingStrategy}.`;\r\n\r\n    // Block 5: Quality & Lighting\r\n    const techSpecs = `Soft volumetric natural lighting, photorealistic, 8k resolution, sharp focus, highly detailed textures, raytracing.`;\r\n\r\n    // Fluent Assembly\r\n    return `${context} ${structure} ${surfaces} ${decor} ${techSpecs}`;\r\n}\r\n\r\n/**\r\n * The Painter: Executes the renovation using narrative prompting strategy.\r\n * Uses Gemini 3 Pro Image Preview (Multimodal) for high-fidelity generation.\r\n * \r\n * ROLE: Prompt Builder & Image Generator\r\n * MODEL: gemini-3-pro-image-preview\r\n */\r\nexport async function generateRenovation(imageBuffer: Buffer, architectOutput: ArchitectOutput, style: string): Promise<Buffer> {\r\n    console.log(`[Painter] Starting renovation generation with style: ${style}`);\r\n    console.log(`[Painter] Skeleton: ${architectOutput.structuralSkeleton.substring(0, 80)}...`);\r\n    console.log(`[Painter] Materials: ${architectOutput.materialPlan.substring(0, 80)}...`);\r\n    console.log(`[Painter] Furnishing: ${architectOutput.furnishingStrategy.substring(0, 80)}...`);\r\n\r\n    // BUILD PROFESSIONAL NARRATIVE PROMPT\r\n    const professionalPrompt = buildProfessionalPrompt(architectOutput, style);\r\n\r\n    console.log(`[Painter] PROFESSIONAL PROMPT LENGTH: ${professionalPrompt.length} chars`);\r\n    console.log(`[Painter] Full Prompt:`, professionalPrompt);\r\n\r\n    // Negative constraints (what to avoid)\r\n    const NEGATIVE_CONSTRAINTS = `AVOID: blurry, low quality, distorted perspective, bad architecture, debris remaining, messy, cluttered, ugly furniture, watermark, text, signature, oversaturated, CGI looking, cartoon, unrealistic lighting, motion blur, spinning objects.`;\r\n\r\n    // EXECUTE IMAGE GENERATION\r\n    console.log('[Painter] Starting Gemini 3 Pro Image generation...');\r\n\r\n    try {\r\n        const base64Image = imageBuffer.toString('base64');\r\n\r\n        // Call ImagenClient with narrative prompt\r\n        const response = await generateImagenRenovation({\r\n            imageBase64: base64Image,\r\n            mimeType: 'image/jpeg',\r\n            prompt: professionalPrompt,\r\n            negativePrompt: NEGATIVE_CONSTRAINTS.replace('AVOID: ', ''),\r\n        });\r\n\r\n        const generatedBuffer = Buffer.from(response.imageBase64, 'base64');\r\n        console.log(`[Painter] ✅ Generation complete! Image size: ${(generatedBuffer.length / 1024).toFixed(2)} KB`);\r\n\r\n        return generatedBuffer;\r\n\r\n    } catch (error) {\r\n        console.error('[Painter] Error:', error);\r\n        throw new Error(`Painter generation failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAEA;;AAEA;;;;;;;CAOC,GACD,SAAS,wBAAwB,aAA8B,EAAE,KAAa;IAC1E,6BAA6B;IAC7B,MAAM,UAAU,CAAC,4CAA4C,EAAE,MAAM,oDAAoD,CAAC;IAE1H,+CAA+C;IAC/C,qDAAqD;IACrD,sEAAsE;IACtE,MAAM,YAAY,cAAc,kBAAkB;IAElD,+CAA+C;IAC/C,MAAM,WAAW,CAAC,2BAA2B,EAAE,cAAc,YAAY,CAAC,CAAC,CAAC;IAE5E,mCAAmC;IACnC,MAAM,QAAQ,CAAC,2BAA2B,EAAE,cAAc,kBAAkB,CAAC,CAAC,CAAC;IAE/E,8BAA8B;IAC9B,MAAM,YAAY,CAAC,mHAAmH,CAAC;IAEvI,kBAAkB;IAClB,OAAO,GAAG,QAAQ,CAAC,EAAE,UAAU,CAAC,EAAE,SAAS,CAAC,EAAE,MAAM,CAAC,EAAE,WAAW;AACtE;AASO,eAAe,mBAAmB,WAAmB,EAAE,eAAgC,EAAE,KAAa;IACzG,QAAQ,GAAG,CAAC,CAAC,qDAAqD,EAAE,OAAO;IAC3E,QAAQ,GAAG,CAAC,CAAC,oBAAoB,EAAE,gBAAgB,kBAAkB,CAAC,SAAS,CAAC,GAAG,IAAI,GAAG,CAAC;IAC3F,QAAQ,GAAG,CAAC,CAAC,qBAAqB,EAAE,gBAAgB,YAAY,CAAC,SAAS,CAAC,GAAG,IAAI,GAAG,CAAC;IACtF,QAAQ,GAAG,CAAC,CAAC,sBAAsB,EAAE,gBAAgB,kBAAkB,CAAC,SAAS,CAAC,GAAG,IAAI,GAAG,CAAC;IAE7F,sCAAsC;IACtC,MAAM,qBAAqB,wBAAwB,iBAAiB;IAEpE,QAAQ,GAAG,CAAC,CAAC,sCAAsC,EAAE,mBAAmB,MAAM,CAAC,MAAM,CAAC;IACtF,QAAQ,GAAG,CAAC,CAAC,sBAAsB,CAAC,EAAE;IAEtC,uCAAuC;IACvC,MAAM,uBAAuB,CAAC,8OAA8O,CAAC;IAE7Q,2BAA2B;IAC3B,QAAQ,GAAG,CAAC;IAEZ,IAAI;QACA,MAAM,cAAc,YAAY,QAAQ,CAAC;QAEzC,0CAA0C;QAC1C,MAAM,WAAW,MAAM,IAAA,uKAAwB,EAAC;YAC5C,aAAa;YACb,UAAU;YACV,QAAQ;YACR,gBAAgB,qBAAqB,OAAO,CAAC,WAAW;QAC5D;QAEA,MAAM,kBAAkB,OAAO,IAAI,CAAC,SAAS,WAAW,EAAE;QAC1D,QAAQ,GAAG,CAAC,CAAC,6CAA6C,EAAE,CAAC,gBAAgB,MAAM,GAAG,IAAI,EAAE,OAAO,CAAC,GAAG,GAAG,CAAC;QAE3G,OAAO;IAEX,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,oBAAoB;QAClC,MAAM,IAAI,MAAM,CAAC,2BAA2B,EAAE,iBAAiB,QAAQ,MAAM,OAAO,GAAG,iBAAiB;IAC5G;AACJ"}}]
}