{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/vision/analyze-room.ts"],"sourcesContent":["import { GoogleGenerativeAI } from '@google/generative-ai';\r\n\r\n/**\r\n * Room structure analysis result from Gemini Vision\r\n */\r\nexport interface RoomAnalysis {\r\n    room_type: string;\r\n    approximate_size_sqm: number;\r\n    architectural_features: string[];\r\n    flooring_type: string;\r\n    wall_color: string;\r\n    ceiling_type: string;\r\n    windows: { position: string; size: string }[];\r\n    doors: { position: string }[];\r\n    special_features: string[];\r\n}\r\n\r\n/**\r\n * Analyze room structure from uploaded photo using Gemini Vision\r\n * \r\n * This function uses Gemini 1.5 Pro Vision to extract detailed structural\r\n * information from an interior photo, which will then be used to generate\r\n * a super-detailed prompt for T2I generation.\r\n * \r\n * @param imageUrl - Public HTTPS URL of the uploaded photo\r\n * @returns Detailed structural analysis as JSON\r\n */\r\nexport async function analyzeRoomStructure(imageUrl: string): Promise<RoomAnalysis> {\r\n    const startTime = Date.now();\r\n\r\n    // 1. Define model in a SINGLE variable\r\n    const modelName = process.env.CHAT_MODEL_VERSION || 'gemini-2.5-flash';\r\n\r\n    // 2. Dynamic logging\r\n    console.log('[Vision] Initializing Gemini Vision analysis...');\r\n    console.log(`[Vision] Model: ${modelName}`);\r\n    console.log('[Vision] Image URL:', imageUrl);\r\n\r\n    const apiKey = process.env.GEMINI_API_KEY;\r\n    if (!apiKey) {\r\n        throw new Error('GEMINI_API_KEY not found in environment variables');\r\n    }\r\n\r\n    const genAI = new GoogleGenerativeAI(apiKey);\r\n    // 3. Use the variable\r\n    const model = genAI.getGenerativeModel({ model: modelName });\r\n\r\n    // Structured analysis prompt\r\n    const analysisPrompt = `You are a professional interior designer and architect. Analyze this interior photo and extract precise structural and architectural information.\r\n\r\nReturn ONLY a valid JSON object with this EXACT structure (no markdown, no explanation):\r\n\r\n{\r\n    \"room_type\": \"living_room|bedroom|kitchen|bathroom|dining_room|office\",\r\n    \"approximate_size_sqm\": 25,\r\n    \"architectural_features\": [\r\n        \"wooden staircase on left wall corner\",\r\n        \"stone-clad fireplace centered on back wall\",\r\n        \"slanted ceiling with exposed beams\"\r\n    ],\r\n    \"flooring_type\": \"terracotta tiles|hardwood|marble|carpet|concrete|laminate\",\r\n    \"wall_color\": \"white|beige|gray|cream|...\",\r\n    \"ceiling_type\": \"flat|sloped|vaulted|exposed_beams\",\r\n    \"windows\": [\r\n        {\"position\": \"right wall center\", \"size\": \"large|medium|small\"}\r\n    ],\r\n    \"doors\": [\r\n        {\"position\": \"back wall left\"}\r\n    ],\r\n    \"special_features\": [\"fireplace\", \"staircase\", \"built-in_shelving\", \"exposed_brick\"]\r\n}\r\n\r\nCRITICAL RULES:\r\n1. Be EXTREMELY precise about positions: use \"left wall\", \"right wall\", \"center\", \"back wall\", \"corner\"\r\n2. Include ALL visible architectural elements\r\n3. Be specific about materials (e.g., \"terracotta tiles\" not just \"tiles\")\r\n4. Return ONLY the JSON object, nothing else\r\n5. Ensure the JSON is valid and parseable`;\r\n\r\n    try {\r\n        // Fetch image and convert to base64\r\n        console.log('[Vision] Fetching and converting image...');\r\n        const { data: imageData, mimeType } = await fetchImageAsBase64(imageUrl);\r\n\r\n        const imagePart = {\r\n            inlineData: {\r\n                data: imageData,\r\n                mimeType: mimeType\r\n            }\r\n        };\r\n\r\n        const TIMEOUT_MS = 30000; // 30 seconds timeout\r\n        const timeoutPromise = new Promise((_, reject) =>\r\n            setTimeout(() => reject(new Error('Vision API request timed out')), TIMEOUT_MS)\r\n        );\r\n\r\n        console.log('[Vision] Sending request to Gemini Vision API...');\r\n\r\n        // Race between API call and timeout\r\n        const result = await Promise.race([\r\n            model.generateContent([analysisPrompt, imagePart]),\r\n            timeoutPromise\r\n        ]) as any; // Cast to any because Promise.race returns the first resolved type\r\n\r\n        const responseText = result.response.text();\r\n\r\n        console.log('[Vision] Raw response:', responseText.substring(0, 200) + '...');\r\n\r\n        // Extract JSON from response (handle potential markdown wrapping)\r\n        let jsonText = responseText.trim();\r\n\r\n        // Remove markdown code blocks if present\r\n        jsonText = jsonText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\r\n\r\n        // Find JSON object in response\r\n        const jsonMatch = jsonText.match(/\\{[\\s\\S]*\\}/);\r\n        if (!jsonMatch) {\r\n            console.error('[Vision] Failed to extract JSON from response:', responseText);\r\n            throw new Error('Failed to parse room analysis - no JSON found in response');\r\n        }\r\n\r\n        let analysis: RoomAnalysis;\r\n\r\n        try {\r\n            analysis = JSON.parse(jsonMatch[0]);\r\n        } catch (parseError) {\r\n            console.error('[Vision] JSON Parse Error:', parseError);\r\n            throw new Error('Failed to parse (syntax error) in Vision API response');\r\n        }\r\n\r\n        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);\r\n        console.log(`[Vision] ✅ Analysis complete in ${elapsedTime}s`);\r\n        console.log('[Vision] Analyzed room:', JSON.stringify(analysis, null, 2));\r\n\r\n        // Validation - Robust check of all required fields\r\n        if (\r\n            typeof analysis.room_type !== 'string' ||\r\n            typeof analysis.approximate_size_sqm !== 'number' ||\r\n            !Array.isArray(analysis.architectural_features) ||\r\n            typeof analysis.flooring_type !== 'string' ||\r\n            typeof analysis.wall_color !== 'string' ||\r\n            typeof analysis.ceiling_type !== 'string' ||\r\n            !Array.isArray(analysis.windows) ||\r\n            !Array.isArray(analysis.doors)\r\n        ) {\r\n            console.error('[Vision] Validation Failed. Received:', analysis);\r\n            throw new Error('Invalid analysis result - missing required fields or incorrect types');\r\n        }\r\n\r\n        return analysis;\r\n\r\n    } catch (error) {\r\n        console.error('[Vision] Error during analysis:', error);\r\n\r\n        if (error instanceof Error) {\r\n            if (error.message.includes('API key')) {\r\n                throw new Error('Gemini API authentication failed. Check GEMINI_API_KEY.');\r\n            }\r\n            if (error.message.includes('quota')) {\r\n                throw new Error('Gemini API quota exceeded. Try again later.');\r\n            }\r\n        }\r\n\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Fetch image from URL and convert to base64 with MIME type detection\r\n * @param url - Public HTTPS URL of the image\r\n * @returns Object containing base64 data and mimeType\r\n */\r\nasync function fetchImageAsBase64(url: string): Promise<{ data: string; mimeType: string }> {\r\n    try {\r\n        const response = await fetch(url);\r\n\r\n        if (!response.ok) {\r\n            throw new Error(`Failed to fetch image: ${response.status} ${response.statusText}`);\r\n        }\r\n\r\n        const mimeType = response.headers.get('content-type') || 'image/jpeg';\r\n        const arrayBuffer = await response.arrayBuffer();\r\n        const buffer = Buffer.from(arrayBuffer);\r\n        const base64 = buffer.toString('base64');\r\n\r\n        console.log(`[Vision] Image fetched: ${(buffer.length / 1024).toFixed(2)} KB, Type: ${mimeType}`);\r\n\r\n        return { data: base64, mimeType };\r\n\r\n    } catch (error) {\r\n        console.error('[Vision] Error fetching image:', error);\r\n        throw new Error(`Failed to fetch image from URL: ${url}`);\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 250, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/imagen/generate-interior.ts"],"sourcesContent":["import { GoogleAuth } from 'google-auth-library';\r\n\r\n/**\r\n * Generate interior design image using Imagen 3 via REST API\r\n * Using REST API instead of SDK for better compatibility with service accounts\r\n */\r\nexport async function generateInteriorImage(options: {\r\n    prompt: string;\r\n    aspectRatio?: '1:1' | '16:9' | '9:16' | '4:3' | '3:4';\r\n    numberOfImages?: number;\r\n}): Promise<Buffer> {\r\n    const {\r\n        prompt,\r\n        aspectRatio = '16:9',\r\n        numberOfImages = 1,\r\n    } = options;\r\n\r\n    console.log('[Imagen REST] Starting image generation...');\r\n    console.log('[Imagen REST] Prompt:', prompt.substring(0, 100) + '...');\r\n\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n        // Initialize Google Auth with environment variables\r\n        const privateKey = process.env.FIREBASE_PRIVATE_KEY?.replace(/\\\\n/g, '\\n');\r\n        const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;\r\n        const projectId = process.env.FIREBASE_PROJECT_ID;\r\n\r\n        if (!privateKey || !clientEmail || !projectId) {\r\n            throw new Error('Missing Firebase credentials in environment variables');\r\n        }\r\n\r\n        const auth = new GoogleAuth({\r\n            credentials: {\r\n                client_email: clientEmail,\r\n                private_key: privateKey,\r\n                project_id: projectId,\r\n            },\r\n            scopes: ['https://www.googleapis.com/auth/cloud-platform'],\r\n        });\r\n\r\n        const client = await auth.getClient();\r\n        const accessToken = await client.getAccessToken();\r\n\r\n        if (!accessToken.token) {\r\n            throw new Error('Failed to get access token');\r\n        }\r\n\r\n        console.log('[Imagen REST] Got access token');\r\n        console.log('[Imagen REST] Project:', projectId);\r\n\r\n        // ✅ BUG FIX #8: Configurable Imagen model version\r\n        const location = 'us-central1';\r\n        const model = process.env.IMAGEN_MODEL_VERSION || 'imagen-3.0-generate-001';\r\n\r\n        const endpoint = `https://${location}-aiplatform.googleapis.com/v1/projects/${projectId}/locations/${location}/publishers/google/models/${model}:predict`;\r\n\r\n        // API request payload\r\n        const requestPayload = {\r\n            instances: [\r\n                {\r\n                    prompt: prompt,\r\n                }\r\n            ],\r\n            parameters: {\r\n                sampleCount: numberOfImages,\r\n                aspectRatio: aspectRatio,\r\n                safetySetting: 'block_some',\r\n                personGeneration: 'allow_adult',\r\n            }\r\n        };\r\n\r\n        console.log('[Imagen REST] Calling API...');\r\n\r\n        // Create AbortController for timeout\r\n        const controller = new AbortController();\r\n        const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s timeout\r\n\r\n        // Make REST API call\r\n        const response = await fetch(endpoint, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Authorization': `Bearer ${accessToken.token}`,\r\n                'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify(requestPayload),\r\n            signal: controller.signal,\r\n        });\r\n        clearTimeout(timeoutId); // Clear timeout on success\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            console.error('[Imagen REST] API Error:', response.status, errorText);\r\n            throw new Error(`Imagen API error: ${response.status} - ${errorText}`);\r\n        }\r\n\r\n        const result = await response.json();\r\n\r\n        console.log('[Imagen REST] API Response received');\r\n\r\n        // Extract base64 image from response\r\n        if (!result.predictions || result.predictions.length === 0) {\r\n            throw new Error('No image generated');\r\n        }\r\n\r\n        // Imagen returns base64 encoded image in predictions[0].bytesBase64Encoded\r\n        const base64Image = result.predictions[0].bytesBase64Encoded;\r\n\r\n        if (!base64Image) {\r\n            console.error('[Imagen REST] Response structure:', JSON.stringify(result, null, 2));\r\n            throw new Error('No image data in response');\r\n        }\r\n\r\n        // Convert base64 to Buffer\r\n        const imageBuffer = Buffer.from(base64Image, 'base64');\r\n\r\n        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);\r\n        console.log(`[Imagen REST] Image generated in ${elapsedTime}s`);\r\n        console.log(`[Imagen REST] Image size: ${(imageBuffer.length / 1024).toFixed(2)} KB`);\r\n\r\n        return imageBuffer;\r\n    } catch (error) {\r\n        console.error('[Imagen REST] Error:', error);\r\n\r\n        // ✅ BUG FIX #10: User-friendly error messages (don't expose internal details)\r\n        if (error instanceof Error) {\r\n            // Log detailed error for debugging\r\n            console.error('[Imagen REST] Detailed error:', error.message, error.stack);\r\n\r\n            if (error.message.includes('403')) {\r\n                throw new Error('Image generation service is currently unavailable. Please try again later.');\r\n            }\r\n\r\n            if (error.message.includes('404')) {\r\n                throw new Error('Image generation service is currently unavailable. Please try again later.');\r\n            }\r\n\r\n            if (error.message.includes('timeout') || error.message.includes('ETIMEDOUT')) {\r\n                throw new Error('Image generation timed out. Please try again.');\r\n            }\r\n        }\r\n\r\n        // Generic user-friendly message\r\n        throw new Error('Image generation failed. Please try again in a few moments.');\r\n    }\r\n}\r\n\r\n/**\r\n * Enhanced prompt generator for interior design\r\n */\r\nexport function buildInteriorDesignPrompt(options: {\r\n    userPrompt: string;\r\n    roomType: string;\r\n    style: string;\r\n}): string {\r\n    const { userPrompt, roomType, style } = options;\r\n\r\n    const enhancedPrompt = `\r\nPhotorealistic interior design rendering of a ${roomType}.\r\nStyle: ${style}.\r\n${userPrompt}\r\n\r\nProfessional architectural visualization quality with natural lighting, realistic materials and textures, proper perspective, modern high-end interior design, clean composition, 4K quality.\r\n    `.trim();\r\n\r\n    return enhancedPrompt;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 379, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/imagen/prompt-builders.ts"],"sourcesContent":["import { RoomAnalysis } from '../vision/analyze-room';\r\n\r\n/**\r\n * Build a super-detailed T2I prompt from room structure analysis\r\n * \r\n * This replaces the I2I approach with a T2I approach that uses detailed\r\n * structural description extracted by Gemini Vision.\r\n * \r\n * @param analysis - Structural analysis from Gemini Vision\r\n * @param targetStyle - Desired design style (e.g., \"modern industrial\")\r\n * @param userRequest - User's specific renovation request\r\n * @returns Detailed T2I prompt that preserves structure\r\n */\r\nexport function buildPromptFromRoomAnalysis(\r\n    analysis: RoomAnalysis,\r\n    targetStyle: string,\r\n    userRequest: string\r\n): string {\r\n    console.log('[Prompt Builder] Building detailed T2I prompt from analysis...');\r\n\r\n    // Helper for formatting lists\r\n    const formatList = (items: any[], formatter: (item: any) => string, emptyText = '') =>\r\n        items && items.length > 0 ? items.map(formatter).join('\\n') : emptyText;\r\n\r\n    // Format architectural features\r\n    const features = formatList(analysis.architectural_features, f => `- ${f}`);\r\n\r\n    // Format windows\r\n    const windowsDescription = formatList(\r\n        analysis.windows,\r\n        w => `- ${w.size} window on ${w.position}`,\r\n        '- No visible windows'\r\n    );\r\n\r\n    // Format doors\r\n    const doorsDescription = formatList(analysis.doors, d => `- Door on ${d.position}`);\r\n\r\n    // Format special features\r\n    const specialFeaturesList = formatList(analysis.special_features, f => `- ${f}`);\r\n    const specialFeatures = specialFeaturesList ? `\\nSpecial architectural elements:\\n${specialFeaturesList}` : '';\r\n\r\n    // Build comprehensive prompt\r\n    const detailedPrompt = `\r\nProfessional architectural photography of a ${analysis.room_type}, approximately ${analysis.approximate_size_sqm} square meters.\r\n\r\nARCHITECTURAL LAYOUT (MUST PRESERVE EXACTLY):\r\n${features}\r\n\r\nWindows:\r\n${windowsDescription}\r\n\r\n${doorsDescription ? `Doors:\\n${doorsDescription}\\n` : ''}\r\nFlooring: ${analysis.flooring_type}\r\nWalls: ${analysis.wall_color}\r\nCeiling: ${analysis.ceiling_type}${specialFeatures}\r\n\r\nDESIGN TRANSFORMATION:\r\nStyle: ${targetStyle}\r\nUser request: ${userRequest}\r\n\r\nSTRICT REQUIREMENTS:\r\n- Preserve the EXACT architectural layout described above\r\n- Keep all structural elements in their specified positions\r\n- Maintain the same room dimensions and proportions\r\n- Change ONLY: furniture, decorative elements, material textures, colors, lighting fixtures\r\n- Do NOT move or alter: windows, doors, stairs, fireplace, built-in features\r\n- Quality: Photorealistic, 8K resolution, architectural magazine quality\r\n- Lighting: Natural sunlight through windows + ambient interior lighting\r\n- Style: High-end professional interior design\r\n- Perspective: Proper architectural perspective, sharp focus throughout\r\n- Rendering: Physically based rendering, ray-traced reflections, realistic materials\r\n    `.trim();\r\n\r\n    console.log('[Prompt Builder] Generated prompt length:', detailedPrompt.length, 'characters');\r\n\r\n    // Log a preview\r\n    const preview = detailedPrompt.substring(0, 200) + '...';\r\n    console.log('[Prompt Builder] Preview:', preview);\r\n\r\n    return detailedPrompt;\r\n}\r\n\r\n/**\r\n * Build a fallback prompt if vision analysis fails\r\n * This is used as a safety net\r\n */\r\nexport function buildFallbackPrompt(\r\n    roomType: string,\r\n    style: string,\r\n    userRequest: string\r\n): string {\r\n    return `\r\nProfessional ${style} style ${roomType}.\r\n${userRequest}\r\nPhotorealistic, 8K, architectural photography, high-end interior design, natural lighting.\r\n    `.trim();\r\n}\r\n"],"names":[],"mappings":";;;;;;AAaO,SAAS,4BACZ,QAAsB,EACtB,WAAmB,EACnB,WAAmB;IAEnB,QAAQ,GAAG,CAAC;IAEZ,8BAA8B;IAC9B,MAAM,aAAa,CAAC,OAAc,WAAkC,YAAY,EAAE,GAC9E,SAAS,MAAM,MAAM,GAAG,IAAI,MAAM,GAAG,CAAC,WAAW,IAAI,CAAC,QAAQ;IAElE,gCAAgC;IAChC,MAAM,WAAW,WAAW,SAAS,sBAAsB,EAAE,CAAA,IAAK,CAAC,EAAE,EAAE,GAAG;IAE1E,iBAAiB;IACjB,MAAM,qBAAqB,WACvB,SAAS,OAAO,EAChB,CAAA,IAAK,CAAC,EAAE,EAAE,EAAE,IAAI,CAAC,WAAW,EAAE,EAAE,QAAQ,EAAE,EAC1C;IAGJ,eAAe;IACf,MAAM,mBAAmB,WAAW,SAAS,KAAK,EAAE,CAAA,IAAK,CAAC,UAAU,EAAE,EAAE,QAAQ,EAAE;IAElF,0BAA0B;IAC1B,MAAM,sBAAsB,WAAW,SAAS,gBAAgB,EAAE,CAAA,IAAK,CAAC,EAAE,EAAE,GAAG;IAC/E,MAAM,kBAAkB,sBAAsB,CAAC,mCAAmC,EAAE,qBAAqB,GAAG;IAE5G,6BAA6B;IAC7B,MAAM,iBAAiB,CAAC;4CACgB,EAAE,SAAS,SAAS,CAAC,gBAAgB,EAAE,SAAS,oBAAoB,CAAC;;;AAGjH,EAAE,SAAS;;;AAGX,EAAE,mBAAmB;;AAErB,EAAE,mBAAmB,CAAC,QAAQ,EAAE,iBAAiB,EAAE,CAAC,GAAG,GAAG;UAChD,EAAE,SAAS,aAAa,CAAC;OAC5B,EAAE,SAAS,UAAU,CAAC;SACpB,EAAE,SAAS,YAAY,GAAG,gBAAgB;;;OAG5C,EAAE,YAAY;cACP,EAAE,YAAY;;;;;;;;;;;;;IAaxB,CAAC,CAAC,IAAI;IAEN,QAAQ,GAAG,CAAC,6CAA6C,eAAe,MAAM,EAAE;IAEhF,gBAAgB;IAChB,MAAM,UAAU,eAAe,SAAS,CAAC,GAAG,OAAO;IACnD,QAAQ,GAAG,CAAC,6BAA6B;IAEzC,OAAO;AACX;AAMO,SAAS,oBACZ,QAAgB,EAChB,KAAa,EACb,WAAmB;IAEnB,OAAO,CAAC;aACC,EAAE,MAAM,OAAO,EAAE,SAAS;AACvC,EAAE,YAAY;;IAEV,CAAC,CAAC,IAAI;AACV"}},
    {"offset": {"line": 512, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/vision/architect.ts"],"sourcesContent":["import { VertexAI } from '@google-cloud/vertexai';\r\n\r\n/**\r\n * Structured output from the Architect for narrative prompt generation.\r\n * Uses the \"Skeleton & Skin\" methodology: neutral geometry + material overlay + furnishing.\r\n */\r\nexport interface ArchitectOutput {\r\n    /** \r\n     * Neutral description of fixed geometry (walls, ceiling, windows, doors, stairs).\r\n     * Example: \"The room features a high vaulted ceiling, a spiral staircase on the left, and a large bay window on the right.\"\r\n     */\r\n    structuralSkeleton: string;\r\n\r\n    /** \r\n     * Material palette mapped to structural elements based on requested style.\r\n     * Example: \"Walls finished in matte lime wash, staircase in blonde oak wood, flooring in polished concrete.\"\r\n     */\r\n    materialPlan: string;\r\n\r\n    /** \r\n     * Description of NEW furniture and decor to populate the space.\r\n     * Example: \"Low-profile minimalist beige sofas, paper lanterns, and woven jute rugs.\"\r\n     */\r\n    furnishingStrategy: string;\r\n\r\n    /** \r\n     * Technical metadata (lighting quality, camera perspective).\r\n     * Example: \"Soft volumetric natural lighting, wide-angle view from corner.\"\r\n     */\r\n    technicalNotes: string;\r\n}\r\n\r\n/**\r\n * The Architect: Generates a narrative-based structural plan for the Painter.\r\n * Uses Gem ini Flash (via Vertex AI) to extract geometry and material planning.\r\n * \r\n * @param imageBuffer - The source image buffer\r\n * @param targetStyle - The desired renovation style (e.g., \"Japandi\", \"Industrial\")\r\n * @param keepElements - List of elements to explicitly preserve (from user chat)\r\n * @returns ArchitectOutput object with skeleton, materials, and furnishing separated\r\n */\r\nexport async function generateArchitecturalPrompt(imageBuffer: Buffer, targetStyle: string, keepElements: string[] = []): Promise<ArchitectOutput> {\r\n    const modelName = process.env.CHAT_MODEL_VERSION || 'gemini-2.5-flash';\r\n\r\n    console.log(`[Architect] Building narrative plan (Style: ${targetStyle}, Keep: ${keepElements.length})...`);\r\n    console.log(`[Architect] Model: ${modelName} (Vertex AI)`);\r\n\r\n    const projectId = process.env.FIREBASE_PROJECT_ID;\r\n    const location = 'us-central1';\r\n\r\n    if (!projectId) {\r\n        throw new Error('FIREBASE_PROJECT_ID not found');\r\n    }\r\n\r\n    const vertexAI = new VertexAI({\r\n        project: projectId,\r\n        location: location,\r\n        // @ts-ignore\r\n        apiVersion: 'v1beta1',\r\n    });\r\n\r\n    const model = vertexAI.getGenerativeModel({ model: modelName });\r\n    const base64Image = imageBuffer.toString('base64');\r\n\r\n    const preservationList = keepElements.length > 0\r\n        ? keepElements.join(', ')\r\n        : \"None specified (renovate freely)\";\r\n\r\n    const systemPrompt = `\r\nROLE: You are an Architectural Surveyor and Interior Design Specialist.\r\n\r\nGOAL: Analyze the input room image and generate a structured plan for renovation in the \"${targetStyle}\" style.\r\n\r\nUSER-SPECIFIED PRESERVATION: ${preservationList}\r\n\r\nYOUR TASK: Generate FOUR FIELDS for a narrative-based image generation prompt.\r\n\r\n---\r\n\r\nFIELD 1: structuralSkeleton (Neutral Geometry Description)\r\n\r\nDescribe the FIXED GEOMETRY of the room. Focus ONLY on structure:\r\n- Wall configuration and angles\r\n- Ceiling type (flat/vaulted/beamed) and height\r\n- Architectural features (fireplaces, alcoves, archways)\r\n- Window and door placements\r\n- Permanent fixtures (stairs, columns, beams)\r\n- Room shape and spatial layout\r\n- Camera perspective\r\n\r\n**RULES:**\r\n- DO NOT mention condition (old/damaged/dirty)\r\n- DO NOT use imperative language (\"preserve\", \"keep\")\r\n- DESCRIBE what exists\r\n- Be specific about positions\r\n\r\n**Material Normalization:**\r\nIf preserving items: \"${preservationList}\", use CLEAN names:\r\n- \"vecchio cotto\" → \"terracotta tile flooring\"\r\n- \"scala legno rovinato\" → \"wooden staircase\"\r\n\r\n**Example:**\r\n\"The room features a high vaulted ceiling with exposed beams, a wooden staircase on the left with glass balustrade, a large rectangular window in a recessed alcove on the right, and a fireplace on the back wall. Terracotta tile flooring throughout.\"\r\n\r\n---\r\n\r\nFIELD 2: materialPlan (Style-Specific Material Mapping)\r\n\r\nBased on \"${targetStyle}\", specify materials for structural elements.\r\n\r\nCRITICAL INSTRUCTION FOR MATERIALS:\r\n1. For NEW elements (furniture, decor, changed walls): Apply the requested style strictly (e.g., if 'Minimalist', use 'Light Oak', 'White Plaster').\r\n2. For EXISTING STRUCTURAL elements (Stairs, Fireplace, Window Frames) that are kept:\r\n   - DO NOT automatically change their material to fit the style unless explicitly asked.\r\n   - Instead, DETECT the current material/color in the image (e.g., \"Dark Mahogany\", \"Red Brick\").\r\n   - Describe it as \"RESTORED\" or \"REFINISHED\" to improve quality without changing the essence.\r\n   - Use adjectives like: \"polished\", \"varnished\", \"cleaned\", \"rich tone\", \"high-quality grain\".\r\n\r\nOUTPUT RULE:\r\nIn the 'materialPlan', for existing structures, write: \"The existing [Structure Name] is preserved in its original [Color/Material] tone, refinished to a pristine condition.\"\r\n\r\nExamples:\r\n- Walls: \"Walls finished in pure matte white plaster\"\r\n- Floor: \"Restored terracotta tiles with polished surface catching warm daylight\"\r\n- Stairs (PRESERVED): \"The staircase retains its original deep walnut hue but is refinished with a smooth satin varnish\"\r\n- Fireplace (PRESERVED): \"The original stone fireplace is cleaned to reveal its natural grey texture\"\r\n\r\n**Example:**\r\n\"Walls finished in soft matte white, the staircase refinished in blonde oak wood catching ambientlight, flooring featuring restored terracotta with polished finish, and fireplace clad in white marble.\"\r\n\r\n---\r\n\r\nFIELD 3: furnishingStrategy (New Furniture & Decor)\r\n\r\nDescribe furniture/decor for \"${targetStyle}\".\r\n\r\nBe EXTREMELY specific:\r\n- \"Low-profile sectional sofa in textured beige bouclé\"\r\n- \"Noguchi-style coffee table with walnut base and glass top\"\r\n- \"Hand-woven jute area rug, linen throw pillows in terracotta\"\r\n- \"Sculptural ceramic vases, potted fiddle-leaf fig, art books\"\r\n\r\nInclude:\r\n1. Seating, tables\r\n2. Lighting fixtures\r\n3. Textiles (rugs, pillows, curtains)\r\n4. Decor (plants, art, ceramics)\r\n5. Atmosphere\r\n\r\n**Example:**\r\n\"Low-profile beige linen sofa, natural oak coffee table, hand-woven jute rug, sheer linen curtains, potted fiddle-leaf fig, ceramic vases, paper pendant lights casting soft glow.\"\r\n\r\n---\r\n\r\nFIELD 4: technicalNotes (Lighting & Camera)\r\n\r\nBrief technical specs:\r\n\r\n**Example:**\r\n\"24mm wide-angle lens, f/8, soft volumetric natural lighting (5500K), warm accents (2700K), 8K photorealistic, global illumination.\"\r\n\r\n---\r\n\r\nOUTPUT FORMAT\r\n\r\nRespond with ONLY valid JSON. No markdown, no explanations:\r\n\r\n{\r\n  \"structuralSkeleton\": \"The room features...\",\r\n  \"materialPlan\": \"Walls finished in...\",\r\n  \"furnishingStrategy\": \"Low-profile sofa...\",\r\n  \"technicalNotes\": \"24mm lens, f/8...\"\r\n}\r\n`;\r\n\r\n    try {\r\n        const result = await model.generateContent({\r\n            contents: [{\r\n                role: 'user',\r\n                parts: [\r\n                    { inlineData: { data: base64Image, mimeType: 'image/jpeg' } },\r\n                    { text: systemPrompt }\r\n                ]\r\n            }]\r\n        });\r\n\r\n        const rawOutput = result.response.candidates?.[0].content.parts[0].text;\r\n\r\n        if (!rawOutput) {\r\n            console.warn('[Architect] No output, using fallback');\r\n            return {\r\n                structuralSkeleton: `A standard living room with ${preservationList || 'typical architectural features'}`,\r\n                materialPlan: `Walls in ${targetStyle.toLowerCase()} style finish, flooring in complementary material`,\r\n                furnishingStrategy: `${targetStyle} furniture and decor appropriate to the space`,\r\n                technicalNotes: \"24mm lens, f/8, photorealistic 8K, natural lighting\"\r\n            };\r\n        }\r\n\r\n        let cleanedOutput = '';\r\n        try {\r\n            cleanedOutput = rawOutput.replace(/```json/g, '').replace(/```/g, '').trim();\r\n            const parsed = JSON.parse(cleanedOutput);\r\n\r\n            if (!parsed.structuralSkeleton || !parsed.materialPlan || !parsed.furnishingStrategy) {\r\n                throw new Error('Missing required fields');\r\n            }\r\n\r\n            console.log(`[Architect] ✅ Structured Output Generated (Vertex AI)`);\r\n            console.log(`[Architect] Skeleton: ${parsed.structuralSkeleton.length} chars`);\r\n            console.log(`[Architect] Materials: ${parsed.materialPlan.length} chars`);\r\n            console.log(`[Architect] Furnishing: ${parsed.furnishingStrategy.length} chars`);\r\n\r\n            return {\r\n                structuralSkeleton: parsed.structuralSkeleton,\r\n                materialPlan: parsed.materialPlan,\r\n                furnishingStrategy: parsed.furnishingStrategy,\r\n                technicalNotes: parsed.technicalNotes || \"24mm lens, f/8, photorealistic 8K, natural lighting\"\r\n            };\r\n\r\n        } catch (parseError) {\r\n            console.error('[Architect] JSON Parse Error:', parseError);\r\n            console.log('[Architect] Raw output:', cleanedOutput || rawOutput);\r\n\r\n            // Fallback with cleaned output\r\n            return {\r\n                structuralSkeleton: `A standard living room with ${preservationList || 'typical architectural features'}`,\r\n                materialPlan: `Walls in ${targetStyle.toLowerCase()} style finish`,\r\n                furnishingStrategy: (cleanedOutput || rawOutput || '').substring(0, 500) || `${targetStyle} furniture`,\r\n                technicalNotes: \"24mm lens, f/8, photorealistic 8K\"\r\n            };\r\n        }\r\n\r\n    } catch (error) {\r\n        console.error('[Architect] Generation Error:', error);\r\n        throw new Error(`Architect generation failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAyCO,eAAe,4BAA4B,WAAmB,EAAE,WAAmB,EAAE,eAAyB,EAAE;IACnH,MAAM,YAAY,QAAQ,GAAG,CAAC,kBAAkB,IAAI;IAEpD,QAAQ,GAAG,CAAC,CAAC,4CAA4C,EAAE,YAAY,QAAQ,EAAE,aAAa,MAAM,CAAC,IAAI,CAAC;IAC1G,QAAQ,GAAG,CAAC,CAAC,mBAAmB,EAAE,UAAU,YAAY,CAAC;IAEzD,MAAM,YAAY,QAAQ,GAAG,CAAC,mBAAmB;IACjD,MAAM,WAAW;IAEjB,IAAI,CAAC,WAAW;QACZ,MAAM,IAAI,MAAM;IACpB;IAEA,MAAM,WAAW,IAAI,oLAAQ,CAAC;QAC1B,SAAS;QACT,UAAU;QACV,aAAa;QACb,YAAY;IAChB;IAEA,MAAM,QAAQ,SAAS,kBAAkB,CAAC;QAAE,OAAO;IAAU;IAC7D,MAAM,cAAc,YAAY,QAAQ,CAAC;IAEzC,MAAM,mBAAmB,aAAa,MAAM,GAAG,IACzC,aAAa,IAAI,CAAC,QAClB;IAEN,MAAM,eAAe,CAAC;;;yFAG+D,EAAE,YAAY;;6BAE1E,EAAE,iBAAiB;;;;;;;;;;;;;;;;;;;;;;;;sBAwB1B,EAAE,iBAAiB;;;;;;;;;;;UAW/B,EAAE,YAAY;;;;;;;;;;;;;;;;;;;;;;;;;;8BA0BM,EAAE,YAAY;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAuC5C,CAAC;IAEG,IAAI;QACA,MAAM,SAAS,MAAM,MAAM,eAAe,CAAC;YACvC,UAAU;gBAAC;oBACP,MAAM;oBACN,OAAO;wBACH;4BAAE,YAAY;gCAAE,MAAM;gCAAa,UAAU;4BAAa;wBAAE;wBAC5D;4BAAE,MAAM;wBAAa;qBACxB;gBACL;aAAE;QACN;QAEA,MAAM,YAAY,OAAO,QAAQ,CAAC,UAAU,EAAE,CAAC,EAAE,CAAC,QAAQ,KAAK,CAAC,EAAE,CAAC;QAEnE,IAAI,CAAC,WAAW;YACZ,QAAQ,IAAI,CAAC;YACb,OAAO;gBACH,oBAAoB,CAAC,4BAA4B,EAAE,oBAAoB,kCAAkC;gBACzG,cAAc,CAAC,SAAS,EAAE,YAAY,WAAW,GAAG,iDAAiD,CAAC;gBACtG,oBAAoB,GAAG,YAAY,6CAA6C,CAAC;gBACjF,gBAAgB;YACpB;QACJ;QAEA,IAAI,gBAAgB;QACpB,IAAI;YACA,gBAAgB,UAAU,OAAO,CAAC,YAAY,IAAI,OAAO,CAAC,QAAQ,IAAI,IAAI;YAC1E,MAAM,SAAS,KAAK,KAAK,CAAC;YAE1B,IAAI,CAAC,OAAO,kBAAkB,IAAI,CAAC,OAAO,YAAY,IAAI,CAAC,OAAO,kBAAkB,EAAE;gBAClF,MAAM,IAAI,MAAM;YACpB;YAEA,QAAQ,GAAG,CAAC,CAAC,qDAAqD,CAAC;YACnE,QAAQ,GAAG,CAAC,CAAC,sBAAsB,EAAE,OAAO,kBAAkB,CAAC,MAAM,CAAC,MAAM,CAAC;YAC7E,QAAQ,GAAG,CAAC,CAAC,uBAAuB,EAAE,OAAO,YAAY,CAAC,MAAM,CAAC,MAAM,CAAC;YACxE,QAAQ,GAAG,CAAC,CAAC,wBAAwB,EAAE,OAAO,kBAAkB,CAAC,MAAM,CAAC,MAAM,CAAC;YAE/E,OAAO;gBACH,oBAAoB,OAAO,kBAAkB;gBAC7C,cAAc,OAAO,YAAY;gBACjC,oBAAoB,OAAO,kBAAkB;gBAC7C,gBAAgB,OAAO,cAAc,IAAI;YAC7C;QAEJ,EAAE,OAAO,YAAY;YACjB,QAAQ,KAAK,CAAC,iCAAiC;YAC/C,QAAQ,GAAG,CAAC,2BAA2B,iBAAiB;YAExD,+BAA+B;YAC/B,OAAO;gBACH,oBAAoB,CAAC,4BAA4B,EAAE,oBAAoB,kCAAkC;gBACzG,cAAc,CAAC,SAAS,EAAE,YAAY,WAAW,GAAG,aAAa,CAAC;gBAClE,oBAAoB,CAAC,iBAAiB,aAAa,EAAE,EAAE,SAAS,CAAC,GAAG,QAAQ,GAAG,YAAY,UAAU,CAAC;gBACtG,gBAAgB;YACpB;QACJ;IAEJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,iCAAiC;QAC/C,MAAM,IAAI,MAAM,CAAC,6BAA6B,EAAE,iBAAiB,QAAQ,MAAM,OAAO,GAAG,iBAAiB;IAC9G;AACJ"}},
    {"offset": {"line": 742, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/firebase-admin.ts"],"sourcesContent":["import { initializeApp, cert, getApps, App } from 'firebase-admin/app';\r\nimport { getFirestore, Firestore } from 'firebase-admin/firestore';\r\nimport { getStorage, Storage } from 'firebase-admin/storage';\r\n\r\n/**\r\n * Firebase Admin SDK initialization for server-side operations\r\n * Singleton pattern ensures single instance across serverless invocations\r\n * ALWAYS loads from firebase-service-account.json for reliability\r\n */\r\n\r\nlet firebaseApp: App | undefined;\r\nlet firestoreInstance: Firestore | undefined;\r\nlet storageInstance: Storage | undefined;\r\n\r\n/**\r\n * ✅ CRITICAL FIX #2: Validate Firebase credentials format\r\n * Prevents security risks from malformed credentials\r\n */\r\n/**\r\n * ✅ CRITICAL FIX #2: Sanitize and Validate Firebase Private Key\r\n * Prevents security risks from malformed credentials and ensures correct format.\r\n * Returns the sanitized private key.\r\n */\r\nfunction sanitizeAndValidatePrivateKey(privateKey: string): string {\r\n    if (!privateKey) {\r\n        throw new Error('[Firebase] Private key is missing');\r\n    }\r\n\r\n    // 1. Sanitize: Handle both escaped (\\n) and unescaped newlines\r\n    let sanitizedKey = privateKey.replace(/\\\\n/g, '\\n');\r\n\r\n    // 2. Sanitize: Remove wrapping quotes if present (common env var issue)\r\n    if (sanitizedKey.startsWith('\"') && sanitizedKey.endsWith('\"')) {\r\n        sanitizedKey = sanitizedKey.slice(1, -1);\r\n    }\r\n    if (sanitizedKey.startsWith(\"'\") && sanitizedKey.endsWith(\"'\")) {\r\n        sanitizedKey = sanitizedKey.slice(1, -1);\r\n    }\r\n\r\n    // 3. Validation: Check for standard PEM format markers\r\n    console.log('[Firebase] Debug Key:', {\r\n        length: sanitizedKey.length,\r\n        hasNewlines: sanitizedKey.includes('\\n'),\r\n        startsWith: sanitizedKey.substring(0, 30),\r\n        endsWith: sanitizedKey.substring(sanitizedKey.length - 30),\r\n        dotCount: (sanitizedKey.match(/\\./g) || []).length // Check for weird conversions\r\n    });\r\n\r\n    if (!sanitizedKey.includes('BEGIN PRIVATE KEY') || !sanitizedKey.includes('END PRIVATE KEY')) {\r\n        throw new Error('[Firebase] Invalid private key format - must be a valid RSA private key (PEM format)');\r\n    }\r\n\r\n    // 4. Validation: content check\r\n    const keyContent = sanitizedKey.split('BEGIN PRIVATE KEY')[1]?.split('END PRIVATE KEY')[0];\r\n    if (!keyContent || keyContent.trim().length < 100) {\r\n        throw new Error('[Firebase] Private key appears to be truncated or empty');\r\n    }\r\n\r\n    // 5. Re-verify newlines for PEM validity\r\n    if (!sanitizedKey.includes('\\n')) {\r\n        throw new Error('[Firebase] Private key invalid: missing newlines after sanitization');\r\n    }\r\n\r\n    return sanitizedKey;\r\n}\r\n\r\n/**\r\n * Validates other credential fields\r\n */\r\nfunction validateServiceAccount(clientEmail: string, projectId: string): void {\r\n    // Validate email format\r\n    if (!clientEmail || !clientEmail.includes('@') || !clientEmail.endsWith('.gserviceaccount.com')) {\r\n        throw new Error(`[Firebase] Invalid service account email: ${clientEmail} - must end with .gserviceaccount.com`);\r\n    }\r\n\r\n    // Validate project ID format\r\n    if (!projectId || projectId.length < 6 || !/^[a-z0-9-]+$/.test(projectId)) {\r\n        throw new Error(`[Firebase] Invalid project ID: ${projectId} - must contain only lowercase letters, numbers, and hyphens`);\r\n    }\r\n}\r\n\r\n/**\r\n * Initialize Firebase Admin SDK\r\n * Loads from environment variables (Vercel-compatible) or falls back to JSON file\r\n */\r\nfunction initializeFirebase(): App {\r\n    if (getApps().length === 0) {\r\n        console.log('[Firebase] Initializing Firebase Admin SDK...');\r\n\r\n        try {\r\n            // Try environment variables first (Vercel-compatible)\r\n            // Try environment variables first (Vercel-compatible)\r\n            const rawPrivateKey = process.env.FIREBASE_PRIVATE_KEY;\r\n\r\n            if (rawPrivateKey && process.env.FIREBASE_CLIENT_EMAIL && process.env.FIREBASE_PROJECT_ID) {\r\n                console.log('[Firebase] Loading credentials from environment variables');\r\n\r\n                // ✅ CRITICAL FIX #2: Sanitize & Validate\r\n                const privateKey = sanitizeAndValidatePrivateKey(rawPrivateKey);\r\n\r\n                validateServiceAccount(\r\n                    process.env.FIREBASE_CLIENT_EMAIL,\r\n                    process.env.FIREBASE_PROJECT_ID\r\n                );\r\n\r\n                firebaseApp = initializeApp({\r\n                    credential: cert({\r\n                        projectId: process.env.FIREBASE_PROJECT_ID,\r\n                        clientEmail: process.env.FIREBASE_CLIENT_EMAIL,\r\n                        privateKey: privateKey,\r\n                    }),\r\n                    storageBucket: process.env.FIREBASE_STORAGE_BUCKET || `${process.env.FIREBASE_PROJECT_ID}.firebasestorage.app`,\r\n                });\r\n\r\n                console.log('[Firebase] ✅ Successfully initialized from environment variables');\r\n\r\n                return firebaseApp;\r\n            }\r\n\r\n            // Fallback to JSON file (local development)\r\n            const fs = require('fs');\r\n            const path = require('path');\r\n\r\n            const serviceAccountPath = path.join(process.cwd(), 'firebase-service-account.json');\r\n\r\n            console.log('[Firebase] Loading credentials from:', serviceAccountPath);\r\n\r\n            if (!fs.existsSync(serviceAccountPath)) {\r\n                throw new Error(`Firebase service account file not found at: ${serviceAccountPath}. Please ensure firebase-service-account.json exists in the project root OR set environment variables.`);\r\n            }\r\n\r\n            const serviceAccount = JSON.parse(fs.readFileSync(serviceAccountPath, 'utf8'));\r\n\r\n            // ✅ CRITICAL FIX #2: Validate JSON file credentials\r\n            const privateKey = sanitizeAndValidatePrivateKey(serviceAccount.private_key);\r\n\r\n            validateServiceAccount(\r\n                serviceAccount.client_email,\r\n                serviceAccount.project_id\r\n            );\r\n\r\n            firebaseApp = initializeApp({\r\n                credential: cert({\r\n                    ...serviceAccount,\r\n                    private_key: privateKey // Use sanitized key\r\n                }),\r\n                storageBucket: serviceAccount.project_id + '.firebasestorage.app',\r\n            });\r\n\r\n            console.log('[Firebase] ✅ Successfully initialized from JSON file');\r\n\r\n            return firebaseApp!; // Assert not null since we just initialized it\r\n        } catch (error) {\r\n            console.error('[Firebase] ❌ Initialization FAILED:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    return getApps()[0];\r\n}\r\n\r\n/**\r\n * Get Firestore instance (singleton)\r\n * CRITICAL FIX: Removed settings() call to prevent re-initialization error\r\n */\r\nexport function getFirestoreDb(): Firestore {\r\n    if (!firestoreInstance) {\r\n        const app = initializeFirebase();\r\n        firestoreInstance = getFirestore(app);\r\n        // REMOVED: settings() call - was causing \"already initialized\" error\r\n    }\r\n\r\n    return firestoreInstance;\r\n}\r\n\r\n/**\r\n * Get Firebase Storage instance (singleton)\r\n */\r\nexport function getFirebaseStorage(): Storage {\r\n    if (!storageInstance) {\r\n        const app = initializeFirebase();\r\n        storageInstance = getStorage(app);\r\n    }\r\n\r\n    return storageInstance;\r\n}\r\n\r\n// Export convenient aliases\r\nexport const db = getFirestoreDb;\r\nexport const storage = getFirebaseStorage;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 903, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/tool-quota.ts"],"sourcesContent":["/**\r\n * Tool-specific quota system (IP-based, daily limits)\r\n * \r\n * Provides fine-grained quota management for expensive AI operations.\r\n * Uses Firestore transactions to ensure consistency across distributed instances.\r\n * \r\n * @module tool-quota\r\n * \r\n * Limits:\r\n * - Max 2 renders per IP per 24h\r\n * - Max 2 quotes per IP per 24h\r\n * \r\n * This is separate from the general rate limiter (20 req/min)\r\n * and protects expensive AI operations.\r\n * \r\n * @example\r\n * ```typescript\r\n * import { checkToolQuota, incrementToolQuota } from '@ai-core';\r\n * \r\n * // Before expensive operation\r\n * const check = await checkToolQuota(userIP, 'render');\r\n * if (!check.allowed) {\r\n *   return { error: `Quota exceeded. Reset at ${check.resetAt}` };\r\n * }\r\n * \r\n * // After successful operation\r\n * await incrementToolQuota(userIP, 'render', { metadata });\r\n * ```\r\n */\r\n\r\nimport { db } from './firebase-admin';\r\nimport { Timestamp } from 'firebase-admin/firestore';\r\n\r\n// ✅ IP validation regex (IPv4 and IPv6)\r\nconst IP_REGEX = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/;\r\n\r\n// Configuration\r\nconst QUOTA_WINDOW_MS = 86400000; // 24 hours\r\nconst MAX_RENDERS_PER_DAY = 50;\r\nconst MAX_QUOTES_PER_DAY = 2;\r\n\r\n/**\r\n * Supported tool types for quota tracking\r\n */\r\nexport type ToolQuotaType = 'render' | 'quote';\r\n\r\n/**\r\n * Quota data structure stored in Firestore\r\n */\r\ninterface QuotaData {\r\n    /** Current usage count within the window */\r\n    count: number;\r\n    /** Maximum allowed operations in the window */\r\n    limit: number;\r\n    /** Window start timestamp (milliseconds since epoch) */\r\n    windowStart: number;\r\n    /** Array of individual operation records */\r\n    calls: Array<{\r\n        /** Operation timestamp */\r\n        timestamp: number;\r\n        /** Optional metadata about the operation */\r\n        metadata?: any;\r\n    }>;\r\n}\r\n\r\n/**\r\n * Result of a quota check operation\r\n */\r\ninterface QuotaCheckResult {\r\n    /** Whether the operation is allowed */\r\n    allowed: boolean;\r\n    /** Number of operations remaining in current window */\r\n    remaining: number;\r\n    /** When the quota window resets */\r\n    resetAt: Date;\r\n    /** Current usage count */\r\n    currentCount: number;\r\n}\r\n\r\n/**\r\n * Validates an IP address format\r\n * @param ip - IP address to validate\r\n * @returns true if valid IPv4 or IPv6\r\n * @private\r\n */\r\nfunction isValidIP(ip: string): boolean {\r\n    return IP_REGEX.test(ip);\r\n}\r\n\r\n/**\r\n * Check if IP is within quota for a specific tool\r\n * \r\n * Uses Firestore transactions to ensure atomicity and prevent race conditions.\r\n * Implements a sliding 24-hour window that automatically resets.\r\n * \r\n * @param ip - User's IP address (IPv4 or IPv6)\r\n * @param toolType - Type of tool ('render' or 'quote')\r\n * @returns Promise resolving to quota check result\r\n * @throws Error if IP is invalid or Firestore operation fails\r\n * \r\n * @example\r\n * ```typescript\r\n * const result = await checkToolQuota('192.168.1.1', 'render');\r\n * if (!result.allowed) {\r\n *   console.log(`Quota exceeded. Reset at: ${result.resetAt}`);\r\n * }\r\n * ```\r\n */\r\nexport async function checkToolQuota(\r\n    ip: string,\r\n    toolType: ToolQuotaType\r\n): Promise<QuotaCheckResult> {\r\n    // ✅ Input validation\r\n    if (!ip || typeof ip !== 'string') {\r\n        throw new Error('[ToolQuota] Invalid IP: must be a non-empty string');\r\n    }\r\n\r\n    if (!isValidIP(ip)) {\r\n        console.warn(`[ToolQuota] Potentially invalid IP format: ${ip}`);\r\n        // Don't throw - might be proxy/forwarded IP\r\n    }\r\n\r\n    if (!toolType || !['render', 'quote'].includes(toolType)) {\r\n        throw new Error(`[ToolQuota] Invalid tool type: ${toolType}`);\r\n    }\r\n    const firestore = db();\r\n    const quotaRef = firestore.collection('tool_quotas').doc(ip);\r\n\r\n    const result = await firestore.runTransaction(async (transaction) => {\r\n        const doc = await transaction.get(quotaRef);\r\n        const now = Date.now();\r\n\r\n        const limit = toolType === 'render' ? MAX_RENDERS_PER_DAY : MAX_QUOTES_PER_DAY;\r\n\r\n        if (!doc.exists) {\r\n            // First request from this IP\r\n            const newData: Record<string, QuotaData> = {\r\n                [toolType]: {\r\n                    count: 0,\r\n                    limit,\r\n                    windowStart: now,\r\n                    calls: [],\r\n                }\r\n            };\r\n\r\n            transaction.set(quotaRef, newData);\r\n\r\n            return {\r\n                allowed: true,\r\n                remaining: limit,\r\n                resetAt: now + QUOTA_WINDOW_MS,\r\n                currentCount: 0,\r\n            };\r\n        }\r\n\r\n        const data = doc.data() as Record<string, any>;\r\n        const toolData = data[toolType] as QuotaData | undefined;\r\n\r\n        if (!toolData) {\r\n            // First time using this specific tool\r\n            const updates: Record<string, QuotaData> = {\r\n                ...data,\r\n                [toolType]: {\r\n                    count: 0,\r\n                    limit,\r\n                    windowStart: now,\r\n                    calls: [],\r\n                }\r\n            };\r\n\r\n            transaction.set(quotaRef, updates);\r\n\r\n            return {\r\n                allowed: true,\r\n                remaining: limit,\r\n                resetAt: now + QUOTA_WINDOW_MS,\r\n                currentCount: 0,\r\n            };\r\n        }\r\n\r\n        const timeSinceWindowStart = now - toolData.windowStart;\r\n\r\n        // Check if we need a new window (24h passed)\r\n        if (timeSinceWindowStart >= QUOTA_WINDOW_MS) {\r\n            // Reset quota for new 24h window\r\n            const updates = {\r\n                ...data,\r\n                [toolType]: {\r\n                    count: 0,\r\n                    limit,\r\n                    windowStart: now,\r\n                    calls: [],\r\n                }\r\n            };\r\n\r\n            transaction.set(quotaRef, updates);\r\n\r\n            return {\r\n                allowed: true,\r\n                remaining: limit,\r\n                resetAt: now + QUOTA_WINDOW_MS,\r\n                currentCount: 0,\r\n            };\r\n        }\r\n\r\n        // Within existing window - check quota\r\n        if (toolData.count >= limit) {\r\n            // Quota exceeded\r\n            return {\r\n                allowed: false,\r\n                remaining: 0,\r\n                resetAt: toolData.windowStart + QUOTA_WINDOW_MS,\r\n                currentCount: toolData.count,\r\n            };\r\n        }\r\n\r\n        // Quota available\r\n        return {\r\n            allowed: true,\r\n            remaining: limit - toolData.count,\r\n            resetAt: toolData.windowStart + QUOTA_WINDOW_MS,\r\n            currentCount: toolData.count,\r\n        };\r\n    });\r\n\r\n    return {\r\n        ...result,\r\n        resetAt: new Date(result.resetAt),\r\n    };\r\n}\r\n\r\n/**\r\n * Increment quota counter after successful tool execution\r\n * \r\n * Should be called ONLY after the expensive operation completes successfully.\r\n * Uses Firestore transactions to ensure the increment is atomic.\r\n * \r\n * @param ip - User's IP address\r\n * @param toolType - Type of tool that was executed\r\n * @param metadata - Optional metadata about the operation (e.g., roomType, imageUrl)\r\n * @throws Error if IP is invalid or Firestore operation fails\r\n * \r\n * @example\r\n * ```typescript\r\n * // After successful image generation\r\n * await incrementToolQuota(userIP, 'render', {\r\n *   roomType: 'kitchen',\r\n *   style: 'modern',\r\n *   imageUrl: 'https://...'\r\n * });\r\n * ```\r\n */\r\nexport async function incrementToolQuota(\r\n    ip: string,\r\n    toolType: ToolQuotaType,\r\n    metadata?: any\r\n): Promise<void> {\r\n    // ✅ Input validation\r\n    if (!ip || typeof ip !== 'string') {\r\n        throw new Error('[ToolQuota] Invalid IP: must be a non-empty string');\r\n    }\r\n\r\n    if (!toolType || !['render', 'quote'].includes(toolType)) {\r\n        throw new Error(`[ToolQuota] Invalid tool type: ${toolType}`);\r\n    }\r\n    const firestore = db();\r\n    const quotaRef = firestore.collection('tool_quotas').doc(ip);\r\n    const now = Date.now();\r\n\r\n    await firestore.runTransaction(async (transaction) => {\r\n        const doc = await transaction.get(quotaRef);\r\n\r\n        if (!doc.exists) {\r\n            console.error('[ToolQuota] Document should exist before increment. Creating it now.');\r\n            const limit = toolType === 'render' ? MAX_RENDERS_PER_DAY : MAX_QUOTES_PER_DAY;\r\n\r\n            transaction.set(quotaRef, {\r\n                [toolType]: {\r\n                    count: 1,\r\n                    limit,\r\n                    windowStart: now,\r\n                    calls: [{ timestamp: now, metadata }]\r\n                }\r\n            });\r\n            return;\r\n        }\r\n\r\n        const data = doc.data() as Record<string, any>;\r\n        const toolData = data[toolType] as QuotaData;\r\n\r\n        // Increment count and add call record\r\n        const updatedToolData: QuotaData = {\r\n            ...toolData,\r\n            count: toolData.count + 1,\r\n            calls: [\r\n                ...toolData.calls,\r\n                { timestamp: now, metadata }\r\n            ]\r\n        };\r\n\r\n        transaction.update(quotaRef, {\r\n            [toolType]: updatedToolData\r\n        });\r\n    });\r\n\r\n    console.log(`[ToolQuota] Incremented ${toolType} quota for IP ${ip}`);\r\n}\r\n\r\n/**\r\n * Get current quota stats for an IP (for debugging and monitoring)\r\n * \r\n * @param ip - IP address to query\r\n * @returns Promise resolving to quota data or null if no record exists\r\n * @throws Error if IP is invalid\r\n * \r\n * @example\r\n * ```typescript\r\n * const stats = await getToolQuotaStats('192.168.1.1');\r\n * if (stats) {\r\n *   console.log(`Render quota: ${stats.render.count}/${stats.render.limit}`);\r\n *   console.log(`Quote quota: ${stats.quote.count}/${stats.quote.limit}`);\r\n * }\r\n * ```\r\n */\r\nexport async function getToolQuotaStats(ip: string): Promise<Record<string, QuotaData> | null> {\r\n    if (!ip || typeof ip !== 'string') {\r\n        throw new Error('[ToolQuota] Invalid IP: must be a non-empty string');\r\n    }\r\n    const firestore = db();\r\n    const doc = await firestore.collection('tool_quotas').doc(ip).get();\r\n    if (!doc.exists) return null;\r\n\r\n    return doc.data() as Record<string, QuotaData>;\r\n}\r\n\r\n/**\r\n * Cleanup expired quota records (maintenance)\r\n * \r\n * Removes quota records older than 48 hours to prevent database bloat.\r\n * Should be called periodically (e.g., daily cron job).\r\n * \r\n * @returns Promise resolving to number of records deleted\r\n * \r\n * @example\r\n * ```typescript\r\n * // In a scheduled Cloud Function or cron job\r\n * const deleted = await cleanupExpiredQuotas();\r\n * console.log(`Cleaned up ${deleted} expired quota records`);\r\n * ```\r\n */\r\nexport async function cleanupExpiredQuotas(): Promise<number> {\r\n    const firestore = db();\r\n    const twoDaysAgo = Timestamp.fromMillis(Date.now() - 172800000); // 48h\r\n\r\n    const snapshot = await firestore.collection('tool_quotas')\r\n        .where('render.windowStart', '<', twoDaysAgo)\r\n        .limit(500)\r\n        .get();\r\n\r\n    if (snapshot.empty) {\r\n        return 0;\r\n    }\r\n\r\n    const batch = firestore.batch();\r\n    snapshot.docs.forEach((doc: any) => batch.delete(doc.ref));\r\n\r\n    await batch.commit();\r\n\r\n    console.log(`[ToolQuota Cleanup] Deleted ${snapshot.size} expired records`);\r\n    return snapshot.size;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1151, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/chat-tools.ts"],"sourcesContent":["// Tool definitions for chat API\r\nimport { tool } from 'ai';\r\nimport { z } from 'zod';\r\n// ✅ BUG FIX #12: Removed duplicate import (storage is imported dynamically below)\r\nimport { saveLead } from './db/leads';\r\nimport { generateInteriorImage, buildInteriorDesignPrompt } from './imagen/generate-interior';\r\nimport { generateInteriorImageI2I, buildI2IEditingPrompt } from './imagen/generate-interior-i2i';\r\n// ✅ VISION + T2I: Static imports (no I2I fallback needed)\r\nimport { analyzeRoomStructure } from './vision/analyze-room';\r\nimport { buildPromptFromRoomAnalysis } from './imagen/prompt-builders';\r\nimport { uploadBase64Image } from './imagen/upload-base64-image';\r\nimport { generateArchitecturalPrompt } from './vision/architect';\r\nimport { checkToolQuota, incrementToolQuota } from './tool-quota';\r\nimport crypto from 'node:crypto';\r\n\r\n// Factory function to create tools with injected sessionId and IP for quota checks\r\nexport function createChatTools(sessionId: string, ip: string) {\r\n\r\n    // Define schemas first - ✅ CHAIN OF THOUGHT: Forza l'AI a riflettere sulla struttura prima del prompt\r\n    const GenerateRenderParameters = z.object({\r\n        // 1️⃣ STEP 1: Analizza la struttura (Chain of Thought)\r\n        structuralElements: z.string()\r\n            .min(5)\r\n            .describe(\r\n                'MANDATORY: List ALL structural elements visible in the user photo or mentioned in the request (in ENGLISH). ' +\r\n                'Examples: \"arched window\", \"beams\". ' +\r\n                'If no photo was uploaded, describe the structural requests.'\r\n            ),\r\n\r\n        // 2️⃣ STEP 2: Type & Style (già esistenti)\r\n        roomType: z.string().min(3).describe('MANDATORY: Type of room in ENGLISH (e.g. \"kitchen\", \"bathroom\").'),\r\n        style: z.string().min(3).describe('MANDATORY: Design style in ENGLISH (e.g. \"industrial\", \"modern\").'),\r\n\r\n        // 3️⃣ STEP 3: Prompt finale (DEVE usare structuralElements)\r\n        prompt: z.string()\r\n            .min(10)\r\n            .describe(\r\n                'MANDATORY: The final detailed prompt for the image generator IN ENGLISH. ' +\r\n                'MUST start by describing the structuralElements listed above.'\r\n            ),\r\n\r\n        // 🆕 HYBRID TOOL PARAMETERS (Optional - backward compatible)\r\n\r\n        // 4️⃣ Mode selection (creation vs modification)\r\n        mode: z.enum(['creation', 'modification'])\r\n            .optional()\r\n            .default('creation')\r\n            .describe(\r\n                'Choose \"modification\" if user uploaded a photo and wants to transform that specific room. ' +\r\n                'Choose \"creation\" if user is describing an imaginary room from scratch. ' +\r\n                'DEFAULT: \"creation\" if not specified.'\r\n            ),\r\n\r\n        // 5️⃣ Source image URL (required for modification mode)\r\n        sourceImageUrl: z.string()\r\n            .url()\r\n            .optional()\r\n            .describe(\r\n                'REQUIRED if mode=\"modification\". The public HTTPS URL of the uploaded user photo (from Firebase Storage). ' +\r\n                'Search conversation history for URLs like \"https://storage.googleapis.com/...\". ' +\r\n                'If user uploaded a photo but you cannot find the URL, ask them to re-upload. ' +\r\n                'Leave empty for mode=\"creation\".'\r\n            ),\r\n        // 6️⃣ Modification Type (for model selection)\r\n        modificationType: z.enum(['renovation', 'detail'])\r\n            .optional()\r\n            .default('renovation')\r\n            .describe(\r\n                'Choose \"renovation\" for whole-room transformation (default). ' +\r\n                'Choose \"detail\" for small edits (e.g., \"change sofa color\", \"add plant\"). ' +\r\n                'This selects the appropriate AI model.'\r\n            ),\r\n\r\n        // 7️⃣ Elements to Keep (Crucial for JIT)\r\n        keepElements: z.array(z.string())\r\n            .optional()\r\n            .default([])\r\n            .describe(\r\n                'List of specific structural or furniture elements the user explicitly asked to PRESERVE/KEEP. ' +\r\n                'Examples: [\"terracotta floor\", \"fireplace\", \"wooden beams\", \"staircase\"]. ' +\r\n                'This is CRITICAL for the \"Modification\" mode to ensure these objects remain untouched.'\r\n            ),\r\n    });\r\n\r\n    const SubmitLeadParameters = z.object({\r\n        name: z.string().max(100).describe('Customer name'),\r\n        email: z.string().email().max(200).describe('Customer email'),\r\n        phone: z.string().max(20).optional().describe('Customer phone number'),\r\n        projectDetails: z.string().max(2000).describe('Detailed project description'),\r\n        roomType: z.string().max(100).optional().describe('Type of room'),\r\n        style: z.string().max(100).optional().describe('Preferred style'),\r\n    });\r\n\r\n    return {\r\n        generate_render: tool({\r\n            description: `Generate a photorealistic 3D rendering of an interior design.\r\n            \r\n            IMPORTANT CONFIRMATION RULE:\r\n            DO NOT call without confirmation! First summarize collected details and ask: \"Vuoi che proceda con la generazione?\"\r\n            \r\n            CRITICAL - AFTER THIS TOOL RETURNS:\r\n            You MUST include the returned imageUrl in your next response using markdown format.\r\n            Example: \"Ecco il rendering!\\\\n\\\\n![](RETURNED_IMAGE_URL)\\\\n\\\\nTi piace?\"\r\n            \r\n            The imageUrl will be in the tool result under result.imageUrl - you MUST display it with ![](url) syntax.`,\r\n            parameters: GenerateRenderParameters,\r\n            execute: async (args: any) => {\r\n                // Extract all parameters including new hybrid parameters\r\n                const { prompt, roomType, style, structuralElements, mode, sourceImageUrl, modificationType, keepElements } = args || {};\r\n\r\n                try {\r\n                    // ✅ CHECK RENDER QUOTA (2 per IP per 24h)\r\n                    console.log(`[generate_render] Checking quota for IP: ${ip}`);\r\n                    const quotaCheck = await checkToolQuota(ip, 'render');\r\n\r\n                    if (!quotaCheck.allowed) {\r\n                        const resetTime = quotaCheck.resetAt.toLocaleString('it-IT');\r\n                        console.warn(`[generate_render] Quota exceeded for IP ${ip}. Reset at: ${resetTime}`);\r\n                        return {\r\n                            status: 'error',\r\n                            error: `Hai raggiunto il limite di ${quotaCheck.currentCount} rendering giornalieri. Potrai generare nuovi rendering dopo le ${resetTime}.`\r\n                        };\r\n                    }\r\n\r\n                    console.log(`[generate_render] Quota OK. Remaining: ${quotaCheck.remaining} renders`);\r\n\r\n                    // Use sessionId and ip from closure (injected via factory)\r\n                    console.log('🏗️ [Chain of Thought] Structural elements detected:', structuralElements);\r\n                    console.log('🛠️ [Hybrid Tool] Mode selected:', mode || 'creation (default)');\r\n                    console.log('🔧 [Hybrid Tool] Modification Type:', modificationType || 'renovation (default)');\r\n                    console.log('🛡️ [Hybrid Tool] KEEP ELEMENTS:', keepElements);\r\n                    console.log('🎨 [generate_render] RECEIVED ARGS:', { prompt, roomType, style, mode, hasSourceImage: !!sourceImageUrl });\r\n\r\n                    const safeRoomType = (roomType || 'room').substring(0, 100);\r\n                    const safeStyle = (style || 'modern').substring(0, 100);\r\n\r\n                    // FAILSAFE: If prompt is empty/short, regenerate it\r\n                    let safePrompt = prompt || `Interior design of a ${safeRoomType} in ${safeStyle} style`;\r\n                    if (safePrompt.length < 10) {\r\n                        console.warn('⚠️ [Failsafe] Short prompt detected, regenerating...');\r\n                        safePrompt = `${safeStyle} style ${safeRoomType} with ${structuralElements || 'modern design'}`;\r\n                    }\r\n\r\n                    console.log('🔥 [generate_render] Safe Prompt used:', safePrompt);\r\n\r\n                    // 🔀 ROUTING LOGIC: Choose T2I (creation) or I2I (modification)\r\n                    let imageBuffer: Buffer;\r\n                    let enhancedPrompt: string;\r\n                    let triageResult: any = null; // Lifted scope for persistence\r\n\r\n                    // 🔥 AUTO-DETECT MODE FROM IMAGE PRESENCE\r\n                    // If sourceImageUrl exists, we MUST be in modification mode (I2I), \r\n                    // unless explicitly told otherwise (rare).\r\n                    // This fixes cases where the LLM forgets to pass mode=\"modification\".\r\n                    const actualMode = (sourceImageUrl && (!mode || mode === 'modification'))\r\n                        ? 'modification'\r\n                        : (mode || 'creation');\r\n\r\n                    console.log(`🔍 [DEBUG] actualMode: \"${actualMode}\" derived from mode=\"${mode}\" and hasImage=${!!sourceImageUrl}`);\r\n\r\n                    // Use Triage logic\r\n                    if (actualMode === 'modification' && sourceImageUrl) {\r\n                        try {\r\n                            console.log('[Hybrid Tool] 📸 Detected Renovation Mode (I2I)');\r\n\r\n                            // Check if it's a storage URL\r\n                            // Extract path from URL: https://storage.googleapis.com/.../app/user-uploads/...\r\n                            // or https://firebasestorage.googleapis.com/.../o/user-uploads%2F...\r\n\r\n                            // Simple fetch attempt first (for public URLs)\r\n                            let buffer: Buffer;\r\n                            const fetchResponse = await fetch(sourceImageUrl);\r\n\r\n                            if (fetchResponse.ok) {\r\n                                const arrayBuffer = await fetchResponse.arrayBuffer();\r\n                                buffer = Buffer.from(arrayBuffer);\r\n                            } else {\r\n                                // Fallback: Try Admin SDK if forbidden (private bucket)\r\n                                console.log('[JIT] Fetch failed (403/404), trying Admin SDK...');\r\n                                const { getStorage } = await import('firebase-admin/storage');\r\n                                const bucket = getStorage().bucket(process.env.FIREBASE_STORAGE_BUCKET);\r\n\r\n                                // Extract relative path from URL (hacky but effective for standard Firebase URLs)\r\n                                // Remove domain and bucket name to get object path\r\n                                let objectPath = sourceImageUrl;\r\n                                if (sourceImageUrl.includes('/o/')) {\r\n                                    // Firebase Client URL\r\n                                    objectPath = decodeURIComponent(sourceImageUrl.split('/o/')[1].split('?')[0]);\r\n                                } else if (sourceImageUrl.includes('storage.googleapis.com')) {\r\n                                    // Public HTTP URL\r\n                                    const parts = sourceImageUrl.split(process.env.FIREBASE_STORAGE_BUCKET + '/');\r\n                                    if (parts.length > 1) objectPath = parts[1].split('?')[0];\r\n                                }\r\n\r\n                                console.log('[JIT] Admin SDK downloading path:', objectPath);\r\n                                const [fileBuffer] = await bucket.file(objectPath).download();\r\n                                buffer = fileBuffer;\r\n                            }\r\n\r\n                            imageBuffer = buffer; // Assign to outer variable\r\n\r\n                            // 2. Triage (Analysis)\r\n                            console.log('[JIT] Step 1: Triage analysis...');\r\n                            const { analyzeImageForChat } = await import('./vision/triage');\r\n                            triageResult = await analyzeImageForChat(imageBuffer);\r\n                            console.log('[JIT] Triage Result:', JSON.stringify(triageResult, null, 2));\r\n\r\n                            // 3. Architect (Prompt Engineering)\r\n                            console.log('[JIT] Step 2: Architect designing... (Style: ' + (style || 'modern') + ')');\r\n                            // Use the style from arguments, falling back to a default if needed\r\n                            const targetStyle = style || 'modern renovation';\r\n\r\n                            // 🔒 GET STRUCTURED OUTPUT (Anchors + Vision)\r\n                            // Ensure keepElements is always an array (coerce if string)\r\n                            const safeKeepElements = Array.isArray(keepElements)\r\n                                ? keepElements\r\n                                : (keepElements ? [keepElements] : []);\r\n\r\n                            const architectOutput = await generateArchitecturalPrompt(imageBuffer, targetStyle, safeKeepElements);\r\n                            console.log('[JIT] ✅ Architect output received:', architectOutput.structuralSkeleton.length, 'chars skeleton');\r\n\r\n                            // 4. Painter (Generation)\r\n                            console.log('[JIT] Step 3: Painter executing with bifocal prompt...');\r\n                            const { generateRenovation } = await import('./imagen/generator');\r\n\r\n                            // ✅ PASS ARCHITECT OUTPUT TO PAINTER (Bifocal Strategy)\r\n                            imageBuffer = await generateRenovation(imageBuffer, architectOutput, targetStyle);\r\n\r\n                            // Set enhancedPrompt for the return value (combine for legacy compatibility)\r\n                            enhancedPrompt = `${architectOutput.materialPlan} | Skeleton: ${architectOutput.structuralSkeleton.substring(0, 100)}`;\r\n\r\n                            console.log('[JIT] ✅ Pipeline generation complete');\r\n\r\n                        } catch (jitError) {\r\n                            console.error('[JIT] ⚠️ Pipeline failed, falling back to legacy T2I:', jitError);\r\n\r\n                            // FALLBACK: Use standard T2I generation\r\n                            console.log('[Fallback] Switching to standard Text-to-Image generation...');\r\n\r\n                            enhancedPrompt = buildInteriorDesignPrompt({\r\n                                userPrompt: safePrompt,\r\n                                roomType: safeRoomType,\r\n                                style: safeStyle,\r\n                            });\r\n\r\n                            imageBuffer = await generateInteriorImage({\r\n                                prompt: enhancedPrompt,\r\n                                aspectRatio: '16:9',\r\n                            });\r\n                        }\r\n\r\n\r\n                    } else {\r\n                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\r\n                        // ✨ TEXT-TO-IMAGE CREATION MODE (existing flow - unchanged)\r\n                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\r\n                        console.log('[Hybrid Tool] ✨ Using TEXT-TO-IMAGE generation (creation mode)');\r\n                        console.log('[generate_render] Calling Imagen REST API...');\r\n\r\n                        // Build enhanced prompt (existing logic)\r\n                        enhancedPrompt = buildInteriorDesignPrompt({\r\n                            userPrompt: safePrompt,\r\n                            roomType: safeRoomType,\r\n                            style: safeStyle,\r\n                        });\r\n\r\n                        // Generate image (existing flow)\r\n                        imageBuffer = await generateInteriorImage({\r\n                            prompt: enhancedPrompt,\r\n                            aspectRatio: '16:9',\r\n                        });\r\n                    }\r\n\r\n                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\r\n                    // 📤 UPLOAD TO FIREBASE STORAGE (New Utility)\r\n                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\r\n\r\n                    // ✅ BUG FIX #7: Validate image buffer before upload\r\n                    if (!imageBuffer || imageBuffer.length === 0) {\r\n                        throw new Error('Generated image is empty or invalid');\r\n                    }\r\n\r\n                    const maxSizeBytes = 10 * 1024 * 1024; // 10MB limit\r\n                    if (imageBuffer.length > maxSizeBytes) {\r\n                        throw new Error(`Generated image is too large: ${(imageBuffer.length / 1024 / 1024).toFixed(2)}MB (max 10MB)`);\r\n                    }\r\n\r\n                    console.log(`[generate_render] Image validated: ${(imageBuffer.length / 1024).toFixed(2)} KB`);\r\n\r\n                    // Use new Storage Utility\r\n                    const { uploadGeneratedImage } = await import('./storage/upload');\r\n                    const safeSlug = safeRoomType.replace(/\\s+/g, '-');\r\n\r\n                    // Upload and get Signed URL\r\n                    const imageUrl = await uploadGeneratedImage(imageBuffer, sessionId, safeSlug);\r\n\r\n                    // ✅ INCREMENT QUOTA COUNTER (render successful)\r\n                    try {\r\n                        await incrementToolQuota(ip, 'render', { roomType: safeRoomType, style: safeStyle, imageUrl });\r\n                        console.log(`[generate_render] ✅ Quota incremented for IP ${ip}`);\r\n                    } catch (quotaError) {\r\n                        // ⚠️ Non-blocking: Log but don't fail the entire operation\r\n                        console.error(`[generate_render] ❌ Failed to increment quota:`, quotaError);\r\n                    }\r\n\r\n                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\r\n                    // 💾 PERSISTENCE (Save Quote if JIT data exists)\r\n                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\r\n                    if (triageResult) {\r\n                        console.log('[JIT] Step 3: Saving quote draft with RENDER URL...');\r\n                        const { saveQuoteDraft } = await import('./db/quotes');\r\n                        // Now we pass the FINAL GENERATED IMAGE URL\r\n                        await saveQuoteDraft(sessionId, imageUrl, triageResult);\r\n                    }\r\n\r\n                    // Return URL directly - Gemini will receive this and include it in response\r\n                    return {\r\n                        status: 'success',\r\n                        imageUrl,\r\n                        description: `Rendering ${safeStyle} per ${safeRoomType}`,\r\n                        promptUsed: enhancedPrompt\r\n                    };\r\n                } catch (error) {\r\n                    console.error('[generate_render] ❌ Error:', error);\r\n                    return {\r\n                        status: 'error',\r\n                        error: error instanceof Error ? error.message : 'Image generation failed'\r\n                    };\r\n                }\r\n            },\r\n        } as any),\r\n\r\n        submit_lead_data: tool({\r\n            description: 'Submit collected lead data (contact information and project details) to Firestore',\r\n            parameters: SubmitLeadParameters,\r\n            execute: async (data: any) => {\r\n                try {\r\n                    // ✅ CHECK QUOTE QUOTA (2 per IP per 24h)\r\n                    console.log(`[submit_lead_data] Checking quota for IP: ${ip}`);\r\n                    const quotaCheck = await checkToolQuota(ip, 'quote');\r\n\r\n                    if (!quotaCheck.allowed) {\r\n                        const resetTime = quotaCheck.resetAt.toLocaleString('it-IT');\r\n                        console.warn(`[submit_lead_data] Quota exceeded for IP ${ip}. Reset at: ${resetTime}`);\r\n                        return {\r\n                            success: false,\r\n                            message: `Hai raggiunto il limite di ${quotaCheck.currentCount} preventivi giornalieri. Potrai richiedere nuovi preventivi dopo le ${resetTime}.`\r\n                        };\r\n                    }\r\n\r\n                    console.log(`[submit_lead_data] Quota OK. Remaining: ${quotaCheck.remaining} quotes`);\r\n\r\n                    console.log('[submit_lead_data] Saving lead to Firestore:', data);\r\n\r\n                    const { getFirestore, Timestamp, FieldValue } = await import('firebase-admin/firestore');\r\n                    const { db } = await import('./firebase-admin');\r\n                    const firestore = db();\r\n\r\n                    await firestore.collection('leads').add({\r\n                        ...data,\r\n                        createdAt: new Date().toISOString(),\r\n                        source: 'chatbot',\r\n                        status: 'new'\r\n                    });\r\n\r\n                    console.log('[submit_lead_data] ✅ Lead saved successfully');\r\n\r\n                    //✅ INCREMENT QUOTA COUNTER (quote successful)\r\n                    try {\r\n                        await incrementToolQuota(ip, 'quote', { email: data.email, roomType: data.roomType });\r\n                        console.log(`[submit_lead_data] ✅ Quota incremented for IP ${ip}`);\r\n                    } catch (quotaError) {\r\n                        // ⚠️ Non-blocking: Log but don't fail the entire operation\r\n                        console.error(`[submit_lead_data] ❌ Failed to increment quota:`, quotaError);\r\n                    }\r\n\r\n                    return {\r\n                        success: true,\r\n                        message: 'Dati salvati con successo! Ti contatteremo presto.'\r\n                    };\r\n                } catch (error) {\r\n                    console.error('[submit_lead_data] Error:', error);\r\n                    return {\r\n                        success: false,\r\n                        message: 'Errore nel salvataggio dei dati.'\r\n                    };\r\n                }\r\n            }\r\n        } as any),\r\n\r\n        get_market_prices: tool({\r\n            description: `Search REAL-TIME Italian market prices for renovation materials, furniture, or labor costs.\r\n            Trigger when user asks: \"Quanto costa X?\" or \"Cerca il prezzo di Y\".\r\n            Returns concise price ranges from Italian suppliers (max 5 lines).`,\r\n            parameters: z.object({\r\n                query: z.string().describe('Specific Italian search query. Examples: \"prezzo gres porcellanato Italia 2026\", \"costo posa parquet al mq Milano\"'),\r\n            }),\r\n            execute: async ({ query }: { query: string }) => {\r\n                console.log('🔍 [get_market_prices] Query:', query);\r\n\r\n                // Optimize query for Italian market\r\n                const optimizedQuery = `${query} prezzo Italia 2026 (site:.it OR site:leroymerlin.it OR site:iperceramica.it OR site:manomano.it)`;\r\n                console.log('🔎 [Perplexity] Optimized:', optimizedQuery);\r\n\r\n                const apiKey = process.env.PERPLEXITY_API_KEY;\r\n                if (!apiKey) {\r\n                    console.error('❌ Missing PERPLEXITY_API_KEY');\r\n                    return 'Errore: API Key mancante.';\r\n                }\r\n\r\n                try {\r\n                    const response = await fetch('https://api.perplexity.ai/chat/completions', {\r\n                        method: 'POST',\r\n                        headers: {\r\n                            'Authorization': `Bearer ${apiKey}`,\r\n                            'Content-Type': 'application/json'\r\n                        },\r\n                        body: JSON.stringify({\r\n                            model: 'sonar',\r\n                            messages: [\r\n                                {\r\n                                    role: 'system',\r\n                                    content: 'Sei un PRICE AGGREGATOR. REGOLE OBBLIGATORIE: 1) Cerca SOLO nei 5 siti più visitati per il materiale richiesto in Italia. 2) Output SOLO lista a puntini. 3) Formato ESATTO: \"• [Nome Sito]: €[Min]-€[Max] /[unità]\". 4) VIETATO scrivere introduzioni, titoli, note, o spiegazioni. 5) MAX 5 righe.'\r\n                                },\r\n                                {\r\n                                    role: 'user',\r\n                                    content: optimizedQuery\r\n                                }\r\n                            ],\r\n                            temperature: 0.1\r\n                        })\r\n                    });\r\n\r\n                    if (!response.ok) {\r\n                        const errorBody = await response.text();\r\n                        console.error('❌ [Perplexity] Error:', errorBody);\r\n                        throw new Error(`Perplexity API Error: ${response.status}`);\r\n                    }\r\n\r\n                    const json = await response.json();\r\n                    const content = json.choices?.[0]?.message?.content || 'Nessun risultato trovato.';\r\n\r\n                    console.log('✅ [Perplexity] Response length:', content.length, 'chars');\r\n\r\n                    return content;\r\n\r\n                } catch (error: any) {\r\n                    console.error('❌ [Perplexity] Failed:', error);\r\n                    return `Errore nella ricerca prezzi: ${error.message}`;\r\n                }\r\n            }\r\n        } as any)\r\n    };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1521, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/ai-retry.ts"],"sourcesContent":["import { streamText } from 'ai';\r\n\r\n/**\r\n * ✅ CRITICAL FIX #3: AI timeout and rate limit handling\r\n * Helper function to call AI with retry logic and timeout\r\n */\r\nconst MAX_RETRIES = 2;\r\nconst TIMEOUT_MS = 45000; // 45 seconds\r\n\r\nasync function callAIWithRetry(config: any, retries = 0): Promise<any> {\r\n    try {\r\n        // Create abort controller for timeout\r\n        const controller = new AbortController();\r\n        const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);\r\n\r\n        const streamPromise = Promise.resolve().then(() =>\r\n            streamText({ ...config, abortSignal: controller.signal })\r\n        );\r\n\r\n        const result = await Promise.race([\r\n            streamPromise,\r\n            new Promise((_, reject) =>\r\n                setTimeout(() => reject(new Error('AI_TIMEOUT')), TIMEOUT_MS)\r\n            )\r\n        ]);\r\n\r\n        clearTimeout(timeoutId);\r\n        return result;\r\n\r\n    } catch (error: any) {\r\n        // Handle timeout errors\r\n        if (error.message === 'AI_TIMEOUT' && retries < MAX_RETRIES) {\r\n            console.warn(`[AI] Timeout, retrying (${retries + 1}/${MAX_RETRIES})`);\r\n            await new Promise(resolve => setTimeout(resolve, 1000 * (retries + 1)));\r\n            return callAIWithRetry(config, retries + 1);\r\n        }\r\n\r\n        // Handle rate limit (429) errors\r\n        if (error.status === 429 && retries < MAX_RETRIES) {\r\n            const retryAfter = parseInt(error.headers?.['retry-after'] || '5');\r\n            console.warn(`[AI] Rate limited, waiting ${retryAfter}s before retry`);\r\n            await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));\r\n            return callAIWithRetry(config, retries + 1);\r\n        }\r\n\r\n        // Throw user-friendly error\r\n        if (error.status === 429) {\r\n            throw new Error('Il servizio è temporaneamente sovraccarico. Riprova tra qualche minuto.');\r\n        }\r\n        if (error.message === 'AI_TIMEOUT') {\r\n            throw new Error('La richiesta ha impiegato troppo tempo. Riprova.');\r\n        }\r\n        throw error;\r\n    }\r\n}\r\n\r\nexport { callAIWithRetry };\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA;;;CAGC,GACD,MAAM,cAAc;AACpB,MAAM,aAAa,OAAO,aAAa;AAEvC,eAAe,gBAAgB,MAAW,EAAE,UAAU,CAAC;IACnD,IAAI;QACA,sCAAsC;QACtC,MAAM,aAAa,IAAI;QACvB,MAAM,YAAY,WAAW,IAAM,WAAW,KAAK,IAAI;QAEvD,MAAM,gBAAgB,QAAQ,OAAO,GAAG,IAAI,CAAC,IACzC,IAAA,oKAAU,EAAC;gBAAE,GAAG,MAAM;gBAAE,aAAa,WAAW,MAAM;YAAC;QAG3D,MAAM,SAAS,MAAM,QAAQ,IAAI,CAAC;YAC9B;YACA,IAAI,QAAQ,CAAC,GAAG,SACZ,WAAW,IAAM,OAAO,IAAI,MAAM,gBAAgB;SAEzD;QAED,aAAa;QACb,OAAO;IAEX,EAAE,OAAO,OAAY;QACjB,wBAAwB;QACxB,IAAI,MAAM,OAAO,KAAK,gBAAgB,UAAU,aAAa;YACzD,QAAQ,IAAI,CAAC,CAAC,wBAAwB,EAAE,UAAU,EAAE,CAAC,EAAE,YAAY,CAAC,CAAC;YACrE,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS,OAAO,CAAC,UAAU,CAAC;YACpE,OAAO,gBAAgB,QAAQ,UAAU;QAC7C;QAEA,iCAAiC;QACjC,IAAI,MAAM,MAAM,KAAK,OAAO,UAAU,aAAa;YAC/C,MAAM,aAAa,SAAS,MAAM,OAAO,EAAE,CAAC,cAAc,IAAI;YAC9D,QAAQ,IAAI,CAAC,CAAC,2BAA2B,EAAE,WAAW,cAAc,CAAC;YACrE,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS,aAAa;YAC9D,OAAO,gBAAgB,QAAQ,UAAU;QAC7C;QAEA,4BAA4B;QAC5B,IAAI,MAAM,MAAM,KAAK,KAAK;YACtB,MAAM,IAAI,MAAM;QACpB;QACA,IAAI,MAAM,OAAO,KAAK,cAAc;YAChC,MAAM,IAAI,MAAM;QACpB;QACA,MAAM;IACV;AACJ"}},
    {"offset": {"line": 1576, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/db/schema.ts"],"sourcesContent":["import { Timestamp } from 'firebase-admin/firestore';\r\n\r\n/**\r\n * Firestore Schema Definitions\r\n * Collections: users, sessions, messages (subcollection), leads\r\n */\r\n\r\n// /users/{userId}\r\nexport interface User {\r\n    email: string;\r\n    displayName: string;\r\n    photoURL?: string;\r\n    createdAt: Timestamp;\r\n    plan: 'free' | 'pro';\r\n    metadata: {\r\n        totalSessions: number;\r\n        totalMessages: number;\r\n        totalImagesGenerated: number;\r\n    };\r\n}\r\n\r\n// /sessions/{sessionId}\r\nexport interface Session {\r\n    userId?: string;\r\n    createdAt: Timestamp;\r\n    updatedAt: Timestamp;\r\n    summary?: string; // AI-generated summary for old sessions\r\n    messageCount: number;\r\n    status: 'active' | 'archived';\r\n    lastMessagePreview?: string;\r\n}\r\n\r\n// /sessions/{sessionId}/messages/{messageId}\r\nexport interface Message {\r\n    role: 'user' | 'assistant' | 'system';\r\n    content: string;\r\n    timestamp: Timestamp;\r\n    tokens?: {\r\n        input: number;\r\n        output: number;\r\n    };\r\n    imageUrl?: string; // For generated images\r\n    toolCalls?: Array<{\r\n        name: string;\r\n        args: any;\r\n        result: any;\r\n    }>;\r\n}\r\n\r\n// /leads/{leadId}\r\nexport interface Lead {\r\n    sessionId: string;\r\n    userId?: string;\r\n    name: string;\r\n    email: string;\r\n    phone?: string;\r\n    projectDetails: string;\r\n    roomType?: string;\r\n    style?: string;\r\n    estimatedBudget?: string;\r\n    createdAt: Timestamp;\r\n    status: 'new' | 'contacted' | 'converted';\r\n}\r\n\r\n// Collection names (constants for type safety)\r\nexport const COLLECTIONS = {\r\n    USERS: 'users',\r\n    SESSIONS: 'sessions',\r\n    MESSAGES: 'messages', // subcollection under sessions\r\n    LEADS: 'leads',\r\n} as const;\r\n"],"names":[],"mappings":";;;;AAiEO,MAAM,cAAc;IACvB,OAAO;IACP,UAAU;IACV,UAAU;IACV,OAAO;AACX"}},
    {"offset": {"line": 1592, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/db/leads.ts"],"sourcesContent":["import { db } from '../firebase-admin';\r\nimport { COLLECTIONS, Lead } from './schema';\r\nimport { FieldValue } from 'firebase-admin/firestore';\r\n\r\n/**\r\n * Save lead data to Firestore\r\n * Called from the submit_lead_data tool\r\n */\r\nexport async function saveLead(data: {\r\n    sessionId: string;\r\n    userId?: string;\r\n    name: string;\r\n    email: string;\r\n    phone?: string;\r\n    projectDetails: string;\r\n    roomType?: string;\r\n    style?: string;\r\n    estimatedBudget?: string;\r\n}): Promise<{ success: boolean; leadId?: string; error?: string }> {\r\n    try {\r\n        const firestore = db();\r\n\r\n        const leadData: Omit<Lead, 'createdAt'> & { createdAt: any } = {\r\n            ...data,\r\n            createdAt: FieldValue.serverTimestamp(),\r\n            status: 'new',\r\n        };\r\n\r\n        const leadRef = await firestore\r\n            .collection(COLLECTIONS.LEADS)\r\n            .add(leadData);\r\n\r\n        console.log(`[saveLead] Lead saved with ID: ${leadRef.id}`);\r\n\r\n        return {\r\n            success: true,\r\n            leadId: leadRef.id,\r\n        };\r\n\r\n    } catch (error) {\r\n        console.error('[saveLead] Error saving lead:', error);\r\n        return {\r\n            success: false,\r\n            error: error instanceof Error ? error.message : 'Unknown error',\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Get all leads (for admin dashboard - optional)\r\n */\r\nexport async function getLeads(\r\n    status?: 'new' | 'contacted' | 'converted',\r\n    limit: number = 50\r\n): Promise<Lead[]> {\r\n    try {\r\n        const firestore = db();\r\n\r\n        let query = firestore\r\n            .collection(COLLECTIONS.LEADS)\r\n            .orderBy('createdAt', 'desc')\r\n            .limit(limit);\r\n\r\n        if (status) {\r\n            query = query.where('status', '==', status) as any;\r\n        }\r\n\r\n        const snapshot = await query.get();\r\n\r\n        return snapshot.docs.map(doc => ({\r\n            ...doc.data(),\r\n            id: doc.id,\r\n        })) as unknown as Lead[];\r\n\r\n    } catch (error) {\r\n        console.error('[getLeads] Error fetching leads:', error);\r\n        return [];\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;;;;;;AAMO,eAAe,SAAS,IAU9B;IACG,IAAI;QACA,MAAM,YAAY,IAAA,2IAAE;QAEpB,MAAM,WAAyD;YAC3D,GAAG,IAAI;YACP,WAAW,0KAAU,CAAC,eAAe;YACrC,QAAQ;QACZ;QAEA,MAAM,UAAU,MAAM,UACjB,UAAU,CAAC,+IAAW,CAAC,KAAK,EAC5B,GAAG,CAAC;QAET,QAAQ,GAAG,CAAC,CAAC,+BAA+B,EAAE,QAAQ,EAAE,EAAE;QAE1D,OAAO;YACH,SAAS;YACT,QAAQ,QAAQ,EAAE;QACtB;IAEJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,iCAAiC;QAC/C,OAAO;YACH,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACpD;IACJ;AACJ;AAKO,eAAe,SAClB,MAA0C,EAC1C,QAAgB,EAAE;IAElB,IAAI;QACA,MAAM,YAAY,IAAA,2IAAE;QAEpB,IAAI,QAAQ,UACP,UAAU,CAAC,+IAAW,CAAC,KAAK,EAC5B,OAAO,CAAC,aAAa,QACrB,KAAK,CAAC;QAEX,IAAI,QAAQ;YACR,QAAQ,MAAM,KAAK,CAAC,UAAU,MAAM;QACxC;QAEA,MAAM,WAAW,MAAM,MAAM,GAAG;QAEhC,OAAO,SAAS,IAAI,CAAC,GAAG,CAAC,CAAA,MAAO,CAAC;gBAC7B,GAAG,IAAI,IAAI,EAAE;gBACb,IAAI,IAAI,EAAE;YACd,CAAC;IAEL,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,oCAAoC;QAClD,OAAO,EAAE;IACb;AACJ"}},
    {"offset": {"line": 1655, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/db/messages.ts"],"sourcesContent":["import { db } from '../firebase-admin';\r\nimport { COLLECTIONS } from './schema';\r\nimport { FieldValue } from 'firebase-admin/firestore';\r\n\r\n/**\r\n * Get conversation context (last N messages) for a session\r\n * Optimized for low latency (~30-50ms)\r\n */\r\nexport async function getConversationContext(\r\n    sessionId: string,\r\n    limit: number = 10\r\n): Promise<Array<{ role: string; content: string; toolInvocations?: any[] }>> {\r\n    try {\r\n        const firestore = db();\r\n\r\n        // Query last N messages, ordered by timestamp descending\r\n        const messagesRef = firestore\r\n            .collection(COLLECTIONS.SESSIONS)\r\n            .doc(sessionId)\r\n            .collection(COLLECTIONS.MESSAGES)\r\n            .orderBy('timestamp', 'desc')\r\n            .limit(limit);\r\n\r\n        const snapshot = await messagesRef.get();\r\n\r\n        if (snapshot.empty) {\r\n            console.log(`[getConversationContext] No messages found for session: ${sessionId}`);\r\n            return [];\r\n        }\r\n\r\n        // Convert to array and reverse (oldest first for chat context)\r\n        const messages = snapshot.docs\r\n            .map(doc => {\r\n                const data = doc.data();\r\n                return {\r\n                    role: data.role as 'user' | 'assistant' | 'system',\r\n                    content: data.content as string,\r\n                    toolInvocations: data.toolCalls?.map((tc: any) => ({\r\n                        toolCallId: crypto.randomUUID(), // Generate transient ID\r\n                        toolName: tc.name,\r\n                        args: tc.args,\r\n                        state: 'result',\r\n                        result: tc.result\r\n                    }))\r\n                };\r\n            })\r\n            .reverse(); // Reverse to get chronological order\r\n\r\n        console.log(`[getConversationContext] Loaded ${messages.length} messages for session: ${sessionId}`);\r\n        return messages;\r\n\r\n    } catch (error) {\r\n        console.error('[getConversationContext] Error loading context:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Save a message to Firestore\r\n * Non-blocking operation for performance\r\n */\r\nexport async function saveMessage(\r\n    sessionId: string,\r\n    role: 'user' | 'assistant' | 'system',\r\n    content: string,\r\n    metadata?: {\r\n        imageUrl?: string;\r\n        toolCalls?: Array<{ name: string; args: any; result: any }>;\r\n        tokens?: { input: number; output: number };\r\n    }\r\n): Promise<void> {\r\n    try {\r\n        const firestore = db();\r\n\r\n        const messageData = {\r\n            role,\r\n            content,\r\n            timestamp: FieldValue.serverTimestamp(),\r\n            ...metadata,\r\n        };\r\n\r\n        // Add message to subcollection\r\n        await firestore\r\n            .collection(COLLECTIONS.SESSIONS)\r\n            .doc(sessionId)\r\n            .collection(COLLECTIONS.MESSAGES)\r\n            .add(messageData);\r\n\r\n        // Update session metadata\r\n        await firestore\r\n            .collection(COLLECTIONS.SESSIONS)\r\n            .doc(sessionId)\r\n            .set(\r\n                {\r\n                    updatedAt: FieldValue.serverTimestamp(),\r\n                    messageCount: FieldValue.increment(1),\r\n                    lastMessagePreview: content.substring(0, 100),\r\n                },\r\n                { merge: true }\r\n            );\r\n\r\n        console.log(`[saveMessage] Saved ${role} message to session: ${sessionId}`);\r\n\r\n    } catch (error) {\r\n        console.error('[saveMessage] Error saving message:', error);\r\n        // Don't throw - message save failures shouldn't break the chat\r\n    }\r\n}\r\n\r\n/**\r\n * Create or update a session\r\n */\r\nexport async function ensureSession(sessionId: string): Promise<void> {\r\n    try {\r\n        const firestore = db();\r\n        const sessionRef = firestore.collection(COLLECTIONS.SESSIONS).doc(sessionId);\r\n\r\n        const session = await sessionRef.get();\r\n\r\n        if (!session.exists) {\r\n            await sessionRef.set({\r\n                createdAt: FieldValue.serverTimestamp(),\r\n                updatedAt: FieldValue.serverTimestamp(),\r\n                messageCount: 0,\r\n                status: 'active',\r\n            });\r\n\r\n            console.log(`[ensureSession] Created new session: ${sessionId}`);\r\n        }\r\n    } catch (error) {\r\n        console.error('[ensureSession] Error ensuring session:', error);\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;AACA;;;;;;;;;AAMO,eAAe,uBAClB,SAAiB,EACjB,QAAgB,EAAE;IAElB,IAAI;QACA,MAAM,YAAY,IAAA,2IAAE;QAEpB,yDAAyD;QACzD,MAAM,cAAc,UACf,UAAU,CAAC,+IAAW,CAAC,QAAQ,EAC/B,GAAG,CAAC,WACJ,UAAU,CAAC,+IAAW,CAAC,QAAQ,EAC/B,OAAO,CAAC,aAAa,QACrB,KAAK,CAAC;QAEX,MAAM,WAAW,MAAM,YAAY,GAAG;QAEtC,IAAI,SAAS,KAAK,EAAE;YAChB,QAAQ,GAAG,CAAC,CAAC,wDAAwD,EAAE,WAAW;YAClF,OAAO,EAAE;QACb;QAEA,+DAA+D;QAC/D,MAAM,WAAW,SAAS,IAAI,CACzB,GAAG,CAAC,CAAA;YACD,MAAM,OAAO,IAAI,IAAI;YACrB,OAAO;gBACH,MAAM,KAAK,IAAI;gBACf,SAAS,KAAK,OAAO;gBACrB,iBAAiB,KAAK,SAAS,EAAE,IAAI,CAAC,KAAY,CAAC;wBAC/C,YAAY,OAAO,UAAU;wBAC7B,UAAU,GAAG,IAAI;wBACjB,MAAM,GAAG,IAAI;wBACb,OAAO;wBACP,QAAQ,GAAG,MAAM;oBACrB,CAAC;YACL;QACJ,GACC,OAAO,IAAI,qCAAqC;QAErD,QAAQ,GAAG,CAAC,CAAC,gCAAgC,EAAE,SAAS,MAAM,CAAC,uBAAuB,EAAE,WAAW;QACnG,OAAO;IAEX,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,mDAAmD;QACjE,OAAO,EAAE;IACb;AACJ;AAMO,eAAe,YAClB,SAAiB,EACjB,IAAqC,EACrC,OAAe,EACf,QAIC;IAED,IAAI;QACA,MAAM,YAAY,IAAA,2IAAE;QAEpB,MAAM,cAAc;YAChB;YACA;YACA,WAAW,0KAAU,CAAC,eAAe;YACrC,GAAG,QAAQ;QACf;QAEA,+BAA+B;QAC/B,MAAM,UACD,UAAU,CAAC,+IAAW,CAAC,QAAQ,EAC/B,GAAG,CAAC,WACJ,UAAU,CAAC,+IAAW,CAAC,QAAQ,EAC/B,GAAG,CAAC;QAET,0BAA0B;QAC1B,MAAM,UACD,UAAU,CAAC,+IAAW,CAAC,QAAQ,EAC/B,GAAG,CAAC,WACJ,GAAG,CACA;YACI,WAAW,0KAAU,CAAC,eAAe;YACrC,cAAc,0KAAU,CAAC,SAAS,CAAC;YACnC,oBAAoB,QAAQ,SAAS,CAAC,GAAG;QAC7C,GACA;YAAE,OAAO;QAAK;QAGtB,QAAQ,GAAG,CAAC,CAAC,oBAAoB,EAAE,KAAK,qBAAqB,EAAE,WAAW;IAE9E,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,uCAAuC;IACrD,+DAA+D;IACnE;AACJ;AAKO,eAAe,cAAc,SAAiB;IACjD,IAAI;QACA,MAAM,YAAY,IAAA,2IAAE;QACpB,MAAM,aAAa,UAAU,UAAU,CAAC,+IAAW,CAAC,QAAQ,EAAE,GAAG,CAAC;QAElE,MAAM,UAAU,MAAM,WAAW,GAAG;QAEpC,IAAI,CAAC,QAAQ,MAAM,EAAE;YACjB,MAAM,WAAW,GAAG,CAAC;gBACjB,WAAW,0KAAU,CAAC,eAAe;gBACrC,WAAW,0KAAU,CAAC,eAAe;gBACrC,cAAc;gBACd,QAAQ;YACZ;YAEA,QAAQ,GAAG,CAAC,CAAC,qCAAqC,EAAE,WAAW;QACnE;IACJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,2CAA2C;IAC7D;AACJ"}},
    {"offset": {"line": 1754, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/imagen/upload-base64-image.ts"],"sourcesContent":["/**\r\n * Upload base64 image to Firebase Storage and return public URL\r\n * \r\n * Required for Imagen Capability API which needs HTTP/GCS URLs instead of base64\r\n * This is a helper function for the hybrid tool implementation\r\n */\r\n\r\n/**\r\n * Upload base64 encoded image to Firebase Storage\r\n * \r\n * @param options.base64Data - Base64 data URL (e.g., data:image/jpeg;base64,...)\r\n * @param options.sessionId - User session ID for organizing uploads\r\n * @param options.prefix - Optional prefix for storage path (default: 'user-uploads')\r\n * @returns Public HTTPS URL to the uploaded image\r\n * \r\n * @example\r\n * ```typescript\r\n * const url = await uploadBase64Image({\r\n *   base64Data: 'data:image/jpeg;base64,/9j/4AAQSkZ...',\r\n *   sessionId: 'abc123',\r\n *   prefix: 'user-uploads'\r\n * });\r\n * // Returns: https://storage.googleapis.com/bucket-name/user-uploads/abc123/1234567890-xyz.jpeg\r\n * ```\r\n */\r\nexport async function uploadBase64Image(options: {\r\n    base64Data: string;\r\n    sessionId: string;\r\n    prefix?: string;\r\n}): Promise<string> {\r\n    const { base64Data, sessionId, prefix = 'user-uploads' } = options;\r\n\r\n    console.log('[Upload Base64] Starting upload...');\r\n\r\n    try {\r\n        // 🔒 SECURITY: Validate and sanitize sessionId (prevent path traversal)\r\n        if (typeof sessionId !== 'string' || !/^[a-zA-Z0-9-]{20,50}$/.test(sessionId)) {\r\n            throw new Error('Invalid sessionId format');\r\n        }\r\n\r\n        // 1. Parse base64 data URL to extract MIME type and data\r\n        const matches = base64Data.match(/^data:([A-Za-z-+\\/]+);base64,(.+)$/);\r\n\r\n        if (!matches || matches.length !== 3) {\r\n            throw new Error('Invalid base64 format. Expected: data:image/TYPE;base64,DATA');\r\n        }\r\n\r\n        const mimeType = matches[1]; // e.g., 'image/jpeg', 'image/png'\r\n        const base64String = matches[2];\r\n\r\n        console.log(`[Upload Base64] Detected MIME type: ${mimeType}`);\r\n\r\n        // 2. Convert base64 string to Buffer\r\n        const imageBuffer = Buffer.from(base64String, 'base64');\r\n\r\n        // 3. Validate image size (max 10MB to match existing validation)\r\n        const maxSizeBytes = 10 * 1024 * 1024; // 10MB\r\n        if (imageBuffer.length > maxSizeBytes) {\r\n            const sizeMB = (imageBuffer.length / 1024 / 1024).toFixed(2);\r\n            throw new Error(`Image too large: ${sizeMB}MB (maximum 10MB allowed)`);\r\n        }\r\n\r\n        const sizeKB = (imageBuffer.length / 1024).toFixed(2);\r\n        console.log(`[Upload Base64] Image size: ${sizeKB} KB`);\r\n\r\n        // 4. Generate unique filename to prevent collisions\r\n        const timestamp = Date.now();\r\n        const uniqueId = crypto.randomUUID().split('-')[0]; // First segment for brevity\r\n        const extension = mimeType.split('/')[1]; // Extract extension (jpeg, png, webp, etc.)\r\n\r\n        // 🔒 SECURITY: sessionId is already validated, safe to use in path\r\n        const fileName = `${prefix}/${sessionId}/${timestamp}-${uniqueId}.${extension}`;\r\n\r\n        console.log(`[Upload Base64] Target path: ${fileName}`);\r\n\r\n        // 5. Import Firebase Storage dynamically (to avoid initialization issues)\r\n        // 5. Import Firebase Storage dynamically\r\n        console.log('[Upload Base64] Importing Firebase Admin...');\r\n        const { storage } = await import('../firebase-admin');\r\n        const bucket = storage().bucket();\r\n        console.log(`[Upload Base64] Using bucket: ${bucket.name}`);\r\n\r\n        // 6. Upload to Firebase Storage\r\n        const file = bucket.file(fileName);\r\n        console.log('[Upload Base64] Starting file.save()...');\r\n\r\n        await file.save(imageBuffer, {\r\n            contentType: mimeType,\r\n            metadata: {\r\n                cacheControl: 'public, max-age=31536000', // Cache for 1 year\r\n                metadata: {\r\n                    uploadedAt: new Date().toISOString(),\r\n                    sessionId: sessionId,\r\n                    source: 'chatbot-upload',\r\n                },\r\n            },\r\n        });\r\n\r\n        console.log('[Upload Base64] File saved to Storage. Making public...');\r\n\r\n        // 7. Make file publicly accessible\r\n        try {\r\n            await file.makePublic();\r\n            console.log('[Upload Base64] File made public successfully');\r\n        } catch (pubError) {\r\n            console.warn('[Upload Base64] Warning: makePublic failed (permissions?), continuing with signed URL fallback may be needed', pubError);\r\n            // If makePublic fails, the public URL below (https://storage.googleapis.com...) won't work for unauthenticated users\r\n            // But we don't block the flow, just log it.\r\n        }\r\n\r\n        // 8. Generate and return public URL\r\n        const publicUrl = `https://storage.googleapis.com/${bucket.name}/${fileName}`;\r\n\r\n        console.log(`[Upload Base64] ✅ Upload complete: ${publicUrl}`);\r\n\r\n        return publicUrl;\r\n\r\n    } catch (error) {\r\n        console.error('[Upload Base64] ❌ Error:', error);\r\n\r\n        // Provide user-friendly error messages\r\n        if (error instanceof Error) {\r\n            // Re-throw validation errors as-is\r\n            if (error.message.includes('Invalid base64') || error.message.includes('too large')) {\r\n                throw error;\r\n            }\r\n\r\n            // Handle Firebase errors\r\n            if (error.message.includes('PERMISSION_DENIED')) {\r\n                throw new Error('Storage permission denied. Please check Firebase Storage rules.');\r\n            }\r\n\r\n            if (error.message.includes('QUOTA_EXCEEDED')) {\r\n                throw new Error('Storage quota exceeded. Please contact support.');\r\n            }\r\n        }\r\n\r\n        // Generic error for unexpected issues\r\n        throw new Error('Failed to upload image. Please try again.');\r\n    }\r\n}\r\n\r\n/**\r\n * Validate if a string is a valid base64 data URL\r\n * \r\n * @param data - String to validate\r\n * @returns true if valid base64 data URL, false otherwise\r\n */\r\nexport function isValidBase64DataUrl(data: string): boolean {\r\n    const base64Regex = /^data:image\\/(jpeg|jpg|png|gif|webp|bmp);base64,/;\r\n    return base64Regex.test(data);\r\n}\r\n\r\n/**\r\n * Extract MIME type from base64 data URL\r\n * \r\n * @param base64Data - Base64 data URL\r\n * @returns MIME type (e.g., 'image/jpeg') or null if invalid\r\n */\r\nexport function extractMimeType(base64Data: string): string | null {\r\n    const matches = base64Data.match(/^data:([A-Za-z-+\\/]+);base64,/);\r\n    return matches ? matches[1] : null;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1885, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/index.ts"],"sourcesContent":["export * from './vision/analyze-room';\r\nexport * from './imagen/generate-interior';\r\nexport * from './imagen/prompt-builders';\r\nexport * from './chat-tools';\r\nexport * from './ai-retry';\r\nexport * from './db/leads';\r\nexport * from './db/messages';\r\nexport * from './db/schema';\r\nexport * from './imagen/upload-base64-image';\r\nexport * from './tool-quota';\r\n"],"names":[],"mappings":";AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA"}},
    {"offset": {"line": 1920, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/web_client/lib/firebase-admin.ts"],"sourcesContent":["import { initializeApp, cert, getApps, App } from 'firebase-admin/app';\r\nimport { getFirestore, Firestore } from 'firebase-admin/firestore';\r\nimport { getStorage, Storage } from 'firebase-admin/storage';\r\n\r\n/**\r\n * Firebase Admin SDK initialization for server-side operations\r\n * Singleton pattern ensures single instance across serverless invocations\r\n * ALWAYS loads from firebase-service-account.json for reliability\r\n */\r\n\r\nlet firebaseApp: App | undefined;\r\nlet firestoreInstance: Firestore | undefined;\r\nlet storageInstance: Storage | undefined;\r\n\r\n/**\r\n * ✅ CRITICAL FIX #2: Validate Firebase credentials format\r\n * Prevents security risks from malformed credentials\r\n */\r\n/**\r\n * ✅ CRITICAL FIX #2: Sanitize and Validate Firebase Private Key\r\n * Prevents security risks from malformed credentials and ensures correct format.\r\n * Returns the sanitized private key.\r\n */\r\nfunction sanitizeAndValidatePrivateKey(privateKey: string): string {\r\n    if (!privateKey) {\r\n        throw new Error('[Firebase] Private key is missing');\r\n    }\r\n\r\n    // 1. Sanitize: Handle both escaped (\\n) and unescaped newlines\r\n    let sanitizedKey = privateKey.replace(/\\\\n/g, '\\n');\r\n\r\n    // 2. Sanitize: Remove wrapping quotes if present (common env var issue)\r\n    if (sanitizedKey.startsWith('\"') && sanitizedKey.endsWith('\"')) {\r\n        sanitizedKey = sanitizedKey.slice(1, -1);\r\n    }\r\n    if (sanitizedKey.startsWith(\"'\") && sanitizedKey.endsWith(\"'\")) {\r\n        sanitizedKey = sanitizedKey.slice(1, -1);\r\n    }\r\n\r\n    // 3. Validation: Check for standard PEM format markers\r\n    if (!sanitizedKey.includes('BEGIN PRIVATE KEY') || !sanitizedKey.includes('END PRIVATE KEY')) {\r\n        throw new Error('[Firebase] Invalid private key format - must be a valid RSA private key (PEM format)');\r\n    }\r\n\r\n    // 4. Validation: content check\r\n    const keyContent = sanitizedKey.split('BEGIN PRIVATE KEY')[1]?.split('END PRIVATE KEY')[0];\r\n    if (!keyContent || keyContent.trim().length < 100) {\r\n        throw new Error('[Firebase] Private key appears to be truncated or empty');\r\n    }\r\n\r\n    // 5. Re-verify newlines for PEM validity\r\n    if (!sanitizedKey.includes('\\n')) {\r\n        throw new Error('[Firebase] Private key invalid: missing newlines after sanitization');\r\n    }\r\n\r\n    return sanitizedKey;\r\n}\r\n\r\n/**\r\n * Validates other credential fields\r\n */\r\nfunction validateServiceAccount(clientEmail: string, projectId: string): void {\r\n    // Validate email format\r\n    if (!clientEmail || !clientEmail.includes('@') || !clientEmail.endsWith('.gserviceaccount.com')) {\r\n        throw new Error(`[Firebase] Invalid service account email: ${clientEmail} - must end with .gserviceaccount.com`);\r\n    }\r\n\r\n    // Validate project ID format\r\n    if (!projectId || projectId.length < 6 || !/^[a-z0-9-]+$/.test(projectId)) {\r\n        throw new Error(`[Firebase] Invalid project ID: ${projectId} - must contain only lowercase letters, numbers, and hyphens`);\r\n    }\r\n}\r\n\r\n/**\r\n * Initialize Firebase Admin SDK\r\n * Loads from environment variables (Vercel-compatible) or falls back to JSON file\r\n */\r\nfunction initializeFirebase(): App {\r\n    if (getApps().length === 0) {\r\n        console.log('[Firebase] Initializing Firebase Admin SDK...');\r\n\r\n        try {\r\n            // Try environment variables first (Vercel-compatible)\r\n            // Try environment variables first (Vercel-compatible)\r\n            const rawPrivateKey = process.env.FIREBASE_PRIVATE_KEY;\r\n\r\n            if (rawPrivateKey && process.env.FIREBASE_CLIENT_EMAIL && process.env.FIREBASE_PROJECT_ID) {\r\n                console.log('[Firebase] Loading credentials from environment variables');\r\n\r\n                // ✅ CRITICAL FIX #2: Sanitize & Validate\r\n                const privateKey = sanitizeAndValidatePrivateKey(rawPrivateKey);\r\n\r\n                validateServiceAccount(\r\n                    process.env.FIREBASE_CLIENT_EMAIL,\r\n                    process.env.FIREBASE_PROJECT_ID\r\n                );\r\n\r\n                firebaseApp = initializeApp({\r\n                    credential: cert({\r\n                        projectId: process.env.FIREBASE_PROJECT_ID,\r\n                        clientEmail: process.env.FIREBASE_CLIENT_EMAIL,\r\n                        privateKey: privateKey,\r\n                    }),\r\n                    storageBucket: `${process.env.FIREBASE_PROJECT_ID}.firebasestorage.app`,\r\n                });\r\n\r\n                console.log('[Firebase] ✅ Successfully initialized from environment variables');\r\n\r\n                return firebaseApp;\r\n            }\r\n\r\n            // Fallback to JSON file (local development)\r\n            const fs = require('fs');\r\n            const path = require('path');\r\n\r\n            const serviceAccountPath = path.join(process.cwd(), 'firebase-service-account.json');\r\n\r\n            console.log('[Firebase] Loading credentials from:', serviceAccountPath);\r\n\r\n            if (!fs.existsSync(serviceAccountPath)) {\r\n                throw new Error(`Firebase service account file not found at: ${serviceAccountPath}. Please ensure firebase-service-account.json exists in the project root OR set environment variables.`);\r\n            }\r\n\r\n            const serviceAccount = JSON.parse(fs.readFileSync(serviceAccountPath, 'utf8'));\r\n\r\n            // ✅ CRITICAL FIX #2: Validate JSON file credentials\r\n            const privateKey = sanitizeAndValidatePrivateKey(serviceAccount.private_key);\r\n\r\n            validateServiceAccount(\r\n                serviceAccount.client_email,\r\n                serviceAccount.project_id\r\n            );\r\n\r\n            firebaseApp = initializeApp({\r\n                credential: cert({\r\n                    ...serviceAccount,\r\n                    private_key: privateKey // Use sanitized key\r\n                }),\r\n                storageBucket: serviceAccount.project_id + '.firebasestorage.app',\r\n            });\r\n\r\n            console.log('[Firebase] ✅ Successfully initialized from JSON file');\r\n\r\n            return firebaseApp!; // Assert not null since we just initialized it\r\n        } catch (error) {\r\n            console.error('[Firebase] ❌ Initialization FAILED:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    return getApps()[0];\r\n}\r\n\r\n/**\r\n * Get Firestore instance (singleton)\r\n * CRITICAL FIX: Removed settings() call to prevent re-initialization error\r\n */\r\nexport function getFirestoreDb(): Firestore {\r\n    if (!firestoreInstance) {\r\n        const app = initializeFirebase();\r\n        firestoreInstance = getFirestore(app);\r\n        // REMOVED: settings() call - was causing \"already initialized\" error\r\n    }\r\n\r\n    return firestoreInstance;\r\n}\r\n\r\n/**\r\n * Get Firebase Storage instance (singleton)\r\n */\r\nexport function getFirebaseStorage(): Storage {\r\n    if (!storageInstance) {\r\n        const app = initializeFirebase();\r\n        storageInstance = getStorage(app);\r\n    }\r\n\r\n    return storageInstance;\r\n}\r\n\r\n// Export convenient aliases\r\nexport const db = getFirestoreDb;\r\nexport const storage = getFirebaseStorage;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2074, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/web_client/lib/rate-limit.ts"],"sourcesContent":["/**\r\n * Hybrid Rate Limiter - Firestore + In-Memory Cache\r\n * \r\n * Architecture:\r\n * - Level 1: In-memory cache (fast, 10s TTL)\r\n * - Level 2: Firestore transaction (authoritative, distributed)\r\n * \r\n * Benefits:\r\n * - Low latency for repeated requests (~0ms cache hit)\r\n * - Distributed protection against abuse\r\n * - Works across serverless instances\r\n */\r\n\r\nimport { db as getDb } from '@/lib/firebase-admin';\r\nimport { Timestamp } from 'firebase-admin/firestore';\r\n\r\n// Get Firestore instance\r\nconst db = getDb();\r\n\r\n// Configuration\r\nconst WINDOW_MS = 60000; // 1 minute sliding window\r\nconst MAX_REQUESTS = 20; // 20 requests per minute\r\nconst CACHE_TTL_MS = 10000; // 10 seconds cache\r\n\r\n// Types\r\ninterface RateLimitData {\r\n    count: number;\r\n    windowStart: number;\r\n    lastRequest: number;\r\n}\r\n\r\ninterface CachedRateLimit {\r\n    allowed: boolean;\r\n    remaining: number;\r\n    resetAt: Date;\r\n    timestamp: number;\r\n}\r\n\r\n// In-memory cache for fast lookups\r\nconst cache = new Map<string, CachedRateLimit>();\r\n\r\n// ✅ BUG FIX #1: Proper interval cleanup to prevent memory leak\r\nlet cleanupInterval: NodeJS.Timeout | null = null;\r\n\r\nfunction initializeCleanup() {\r\n    if (cleanupInterval) return; // Already initialized\r\n\r\n    cleanupInterval = setInterval(() => {\r\n        const now = Date.now();\r\n        for (const [key, value] of cache.entries()) {\r\n            if (now - value.timestamp > CACHE_TTL_MS) {\r\n                cache.delete(key);\r\n            }\r\n        }\r\n    }, 30000); // Clean every 30 seconds\r\n\r\n    console.log('[RateLimit] Cache cleanup interval initialized');\r\n}\r\n\r\n// Initialize cleanup on module load\r\ninitializeCleanup();\r\n\r\n// Cleanup on process termination (important for serverless)\r\nprocess.on('beforeExit', () => {\r\n    if (cleanupInterval) {\r\n        clearInterval(cleanupInterval);\r\n        cleanupInterval = null;\r\n        console.log('[RateLimit] Cache cleanup interval cleared');\r\n    }\r\n});\r\n\r\n/**\r\n * Check if IP is within rate limits\r\n * Uses Firestore as authoritative source (cache disabled for accuracy)\r\n */\r\nexport async function checkRateLimit(ip: string): Promise<{\r\n    allowed: boolean;\r\n    remaining: number;\r\n    resetAt: Date;\r\n}> {\r\n    // Always check Firestore for accurate counting\r\n    // NOTE: Cache was causing issues with window resets\r\n    console.log('[RateLimit] Checking Firestore for IP:', ip);\r\n    const result = await checkFirestoreRateLimit(ip);\r\n\r\n    return result;\r\n}\r\n\r\n/**\r\n * Firestore-based rate limiting with sliding window\r\n */\r\nasync function checkFirestoreRateLimit(ip: string): Promise<{\r\n    allowed: boolean;\r\n    remaining: number;\r\n    resetAt: Date;\r\n}> {\r\n    const rateLimitRef = db.collection('rate_limits').doc(ip);\r\n\r\n    const result = await db.runTransaction(async (transaction) => {\r\n        const doc = await transaction.get(rateLimitRef);\r\n        const now = Date.now();\r\n\r\n        if (!doc.exists) {\r\n            // First request from this IP\r\n            transaction.set(rateLimitRef, {\r\n                count: 1,\r\n                windowStart: Timestamp.fromMillis(now),\r\n                lastRequest: Timestamp.fromMillis(now),\r\n            });\r\n\r\n            return {\r\n                allowed: true,\r\n                remaining: MAX_REQUESTS - 1,\r\n                resetAt: now + WINDOW_MS,\r\n            };\r\n        }\r\n\r\n        const data = doc.data() as any; // Firestore returns Timestamp objects\r\n        const windowStart = data.windowStart.toMillis();\r\n        const timeSinceWindowStart = now - windowStart;\r\n\r\n        // Check if we need a new window\r\n        if (timeSinceWindowStart >= WINDOW_MS) {\r\n            // Start new window\r\n            transaction.update(rateLimitRef, {\r\n                count: 1,\r\n                windowStart: Timestamp.fromMillis(now),\r\n                lastRequest: Timestamp.fromMillis(now),\r\n            });\r\n\r\n            return {\r\n                allowed: true,\r\n                remaining: MAX_REQUESTS - 1,\r\n                resetAt: now + WINDOW_MS,\r\n            };\r\n        }\r\n\r\n        // Within existing window\r\n        if (data.count >= MAX_REQUESTS) {\r\n            // Rate limit exceeded\r\n            return {\r\n                allowed: false,\r\n                remaining: 0,\r\n                resetAt: windowStart + WINDOW_MS,\r\n            };\r\n        }\r\n\r\n        // Increment counter\r\n        transaction.update(rateLimitRef, {\r\n            count: data.count + 1,\r\n            lastRequest: Timestamp.fromMillis(now),\r\n        });\r\n\r\n        return {\r\n            allowed: true,\r\n            remaining: MAX_REQUESTS - (data.count + 1),\r\n            resetAt: windowStart + WINDOW_MS,\r\n        };\r\n    });\r\n\r\n    return {\r\n        ...result,\r\n        resetAt: new Date(result.resetAt),\r\n    };\r\n}\r\n\r\n/**\r\n * Cleanup expired rate limit records (optional maintenance)\r\n * Call this from a cron job or scheduled function\r\n */\r\nexport async function cleanupExpiredRateLimits(): Promise<number> {\r\n    const twoHoursAgo = Timestamp.fromMillis(Date.now() - 7200000);\r\n\r\n    const snapshot = await db.collection('rate_limits')\r\n        .where('lastRequest', '<', twoHoursAgo)\r\n        .limit(500)\r\n        .get();\r\n\r\n    if (snapshot.empty) {\r\n        return 0;\r\n    }\r\n\r\n    const batch = db.batch();\r\n    snapshot.docs.forEach(doc => batch.delete(doc.ref));\r\n\r\n    await batch.commit();\r\n\r\n    console.log(`[RateLimit Cleanup] Deleted ${snapshot.size} expired records`);\r\n    return snapshot.size;\r\n}\r\n\r\n/**\r\n * Get current rate limit stats for an IP (for debugging)\r\n */\r\nexport async function getRateLimitStats(ip: string): Promise<RateLimitData | null> {\r\n    const doc = await db.collection('rate_limits').doc(ip).get();\r\n    if (!doc.exists) return null;\r\n\r\n    const data = doc.data() as any;\r\n    return {\r\n        count: data.count,\r\n        windowStart: data.windowStart.toMillis(),\r\n        lastRequest: data.lastRequest.toMillis(),\r\n    };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2232, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/web_client/app/api/chat/route.ts"],"sourcesContent":["import { createGoogleGenerativeAI } from '@ai-sdk/google';\r\nimport { streamText } from 'ai';\r\nimport { google as googleProvider } from '@ai-sdk/google';\r\nimport { getConversationContext, saveMessage, ensureSession } from '@ai-core';\r\nimport { checkRateLimit } from '@/lib/rate-limit';\r\nimport type { createChatTools } from '@ai-core';\r\nimport { callAIWithRetry } from '@ai-core';\r\n\r\n// ✅ Helper: Extract text content from various message formats\r\nfunction extractUserMessage(message: any): string {\r\n    // Case C: message.parts array (actual structure from AI SDK)\r\n    if (message?.parts && Array.isArray(message.parts)) {\r\n        return message.parts\r\n            .filter((part: any) => part.type === 'text')\r\n            .map((part: any) => part.text)\r\n            .join('\\n');\r\n    }\r\n\r\n    // Case B: message.content is an array (Vercel multipart)\r\n    if (message?.content && Array.isArray(message.content)) {\r\n        return message.content\r\n            .filter((part: any) => part.type === 'text')\r\n            .map((part: any) => part.text)\r\n            .join('\\n');\r\n    }\r\n\r\n    // Case A: message.content is a simple string\r\n    if (typeof message?.content === 'string') {\r\n        return message.content;\r\n    }\r\n\r\n    return '';\r\n}\r\n\r\n// Configurazione\r\nexport const maxDuration = 60;\r\nexport const dynamic = 'force-dynamic';\r\nexport const runtime = 'nodejs'; // Required for Firebase Admin SDK\r\n\r\nconst SYSTEM_INSTRUCTION = `[CORE IDENTITY]\r\nYou are SYD - ARCHITETTO PERSONALE, an advanced construction and design assistant.\r\nLanguage: Italian.\r\nPrimary Rule: Classify intent immediately: MODE A (Designer) or MODE B (Surveyor).\r\n\r\n[INTERACTION RULES]\r\n1. **GREETINGS (Ciao)**: If the user says \"Ciao\" or greetings, DO NOT introduce yourself (you already did). Just answer: \"Ciao! Come posso aiutarti con il tuo progetto?\".\r\n2. **QUESTION LIMIT**: Ask MAXIMUM 1 or 2 questions at a time. NEVER ask a long list of questions. Wait for the user's answer before proceeding.\r\n\r\n[PHOTO UPLOAD DISAMBIGUATION]\r\n**CRITICAL RULE**: If the user's intent is UNCLEAR (e.g., uploads photo with only \"Ciao\", generic greetings, or vague text):\r\n1. DO NOT assume MODE A or MODE B\r\n2. MUST ask explicitly which service they want:\r\n\r\nResponse Template:\r\n\"Ciao! Ho ricevuto la tua foto. Come posso aiutarti?\r\n\r\n1. 🎨 **Visualizzare** come verrebbe ristrutturato con un rendering 3D\r\n2. 📋 **Ricevere un preventivo** dettagliato per i lavori\r\n\r\nCosa preferisci?\"\r\n\r\n**WAIT for user's choice** before proceeding to MODE A or MODE B.\r\n\r\n\r\n[EXISTING TOOL INSTRUCTIONS]\r\n##  ANALISI IMMAGINI UPLOAD (FOTO UTENTE)\r\n\r\nQuando l'utente carica una foto:\r\n1. **ANALIZZA SUBITO** la foto.\r\n2. **DESCRIVI** esplicitamente cosa vedi.\r\n3. **NON GENERARE** ancora. Avvia il protocollo \"Discovery\" (vedi Mode A).\r\n\r\n## ISTRUZIONI PER IL TOOL generate_render\r\n\r\n**STEP 1 - structuralElements (OBBLIGATORIO):**\r\nPrima di tutto, devi compilare il campo \\`structuralElements\\` con TUTTI gli elementi strutturali:\r\n- Se l'utente ha caricato una FOTO: descrivi gli elementi visibili (es. \"arched window on left wall, wooden ceiling beams, parquet floor\")\r\n- Se NON c'è foto: descrivi gli elementi richiesti nella conversazione\r\n- Scrivi in INGLESE e sii SPECIFICO\r\n\r\n**STEP 2 - roomType & style:**\r\nCompila questi campi in INGLESE (es. \"living room\", \"modern\")\r\n\r\n**STEP 3 - prompt (DEVE iniziare con structuralElements):**\r\nIl prompt DEVE iniziare descrivendo gli elementi di STEP 1.\r\n\r\n## 🔀 SCELTA MODALITÀ (mode)\r\n\r\n### MODE: \"creation\" (Creazione da zero)\r\nUsa quando l'utente NON ha caricato una foto\r\n\r\n### MODE: \"modification\" (Modifica foto esistente)  \r\nUsa quando l'utente HA CARICATO una foto.\r\nDEVI compilare \\`sourceImageUrl\\`:\r\n1. Cerca nella cronologia il marker: \\`[Immagine allegata: https://storage.googleapis.com/...]\\`\r\n2. Estrai SOLO l'URL (tutto ciò che sta tra \":\" e \"]\")\r\n\r\n**ESEMPIO CONCRETO**:\r\n- Se vedi: \"Ciao [Immagine allegata: https://storage.googleapis.com/bucket/image.jpg]\"\r\n- Devi passare: mode: \"modification\", sourceImageUrl: \"https://storage.googleapis.com/bucket/image.jpg\"\r\n\r\n**CRITICO**: Se c'è un marker [Immagine allegata] nella cronologia, DEVI SEMPRE usare mode: \"modification\".\r\n\r\n---\r\n\r\n[CONFIRMATION HANDLING - CRITICAL]\r\nWhen you ask \"Vuoi che proceda con la generazione del rendering?\" or similar confirmation,\r\nand the user responds with ANY of these:\r\n- \"sì\", \"si\", \"yes\", \"ok\", \"vai\", \"procedi\", \"certo\", \"perfetto\", \"genera\", \"fallo\"\r\n- Or ANY SHORT affirmative response (1-3 words)\r\n\r\n**YOU MUST IMMEDIATELY call generate_render** with:\r\n- All details gathered from the conversation\r\n- sourceImageUrl from the [Immagine allegata: URL] marker\r\n- keepElements from user's preservation answers\r\n- style from user's design preferences\r\n\r\n**DO NOT**:\r\n- Ask additional questions\r\n- Confirm again\r\n- Repeat what you're about to do\r\n\r\n**JUST EXECUTE THE TOOL.**\r\n\r\n---\r\n\r\nMODE A: DESIGNER (Rendering Flow)\r\n\r\nTrigger: User wants to \"visualize\", \"imagine\", \"see ideas\", \"style advice\" OR chose \"rendering\" from photo disambiguation.\r\n\r\nScenario 1: Starting from Photo (I2I Renovation) - TWO-PHASE PROTOCOL\r\nGoal: First identify what to preserve, then gather expert details for what to change.\r\n\r\n═══════════════════════════════════════════════════════════════\r\nPHASE 1: PRESERVATION ANALYSIS (What to KEEP)\r\n═══════════════════════════════════════════════════════════════\r\n\r\n1. **VISUAL ANALYSIS**: Acknowledge the room using triage data if available (e.g., \"Vedo un soggiorno con pavimento in cotto, camino in pietra, scala in legno\").\r\n\r\n2. **PRESERVATION QUESTION** (Mandatory First Question):\r\n   \"Quali elementi della foto vuoi MANTENERE invariati? \r\n   (es. pavimento, camino, scala, infissi, soffitto...)\r\n   \r\n   Dimmi tutto quello che vuoi conservare, poi progettiamo il resto insieme.\"\r\n\r\n3. **STOP & WAIT**: Do NOT proceed until user specifies what to keep.\r\n\r\nRULE: MATERIAL FIDELITY\r\nIf the user says \"Keep the stairs\" or \"Don't change the fireplace\", implies they like the current look (color/material).\r\n- Look at the photo. Detect the actual color (e.g., \"Dark Brown Wood\", \"Red Brick\").\r\n- Use \"Refinished [Original Color]\" instead of \"[New Style Material]\" in your descriptions.\r\n- DO NOT assume \"Japandi = Light Oak\" for preserved elements. Respect the source.\r\n\r\n═══════════════════════════════════════════════════════════════\r\nPHASE 2: EXPERT DESIGN CONSULTATION (What to CHANGE)\r\n═══════════════════════════════════════════════════════════════\r\n\r\nOnce you know what to KEEP, ask expert questions ONLY for elements that will CHANGE:\r\n\r\n**If WALLS are NOT preserved** (user didn't mention walls/pareti in keepElements):\r\n   → Ask: \"Che colore vuoi per le pareti? (es. Bianco puro, Grigio tortora, Beige caldo...)\"\r\n\r\n**If FLOORING is NOT preserved** (user didn't mention floor/pavimento):\r\n   → Ask: \"Che tipo di pavimento immagini? (es. Parquet, Gres, Resina...)\"\r\n\r\n**ALWAYS ask** (regardless of preservation):\r\n   → Ask: \"Che stile di arredamento preferisci? (es. Moderno, Industriale, Scandinavo, Classico...)\"\r\n\r\n4. **GATHER INCREMENTALLY**: Ask 1-2 questions at a time, wait for answers.\r\n\r\n5. **EXECUTION**: Once you have all design details, call \\`generate_render\\`:\r\n   \r\n   **CRITICAL - keepElements MAPPING**:\r\n   This is an ARRAY of strings. You MUST populate it correctly:\r\n   \r\n   Examples:\r\n   - User: \"mantieni il pavimento in cotto\" → \\`keepElements: [\"terracotta floor\"]\\`\r\n   - User: \"tieni il camino e le scale\" → \\`keepElements: [\"fireplace\", \"staircase\"]\\`  \r\n   - User: \"preserve wooden beams and floor\" → \\`keepElements: [\"wooden beams\", \"floor\"]\\`\r\n   - User: \"voglio tenere solo il caminetto\" → \\`keepElements: [\"fireplace\"]\\`\r\n   - User: (nothing to keep) → \\`keepElements: []\\`\r\n   \r\n   **TRANSLATE TO ENGLISH**: Always convert Italian preservation requests to English.\r\n   \r\n   Tool parameters:\r\n   *   \\`keepElements\\`: Array populated as shown above (MANDATORY if user mentioned preservation)\r\n   *   \\`style\\`: Include explicit details from Phase 2 (e.g., \"Scandinavian style with WHITE WALLS and OAK PARQUET flooring\")\r\n   *   \\`sourceImageUrl\\`: Extract from conversation history marker \\`[Immagine allegata: URL]\\`\r\n\r\n---\r\n\r\nMODE B: RENOVATION CONSULTANT (Quote & Preventivo Flow)\r\n\r\nTrigger: User wants \"quote\", \"cost\", \"work details\", \"renovation\", \"preventivo\".\r\n\r\n═══════════════════════════════════════════════════════════════\r\nPERSONA & MINDSET\r\n═══════════════════════════════════════════════════════════════\r\nYou are a professional renovation consultant - think like an experienced architect \r\nor interior designer having a first consultation with a potential client.\r\n\r\nYour goal is to understand their PROJECT VISION and gather practical details \r\nfor an accurate quote, NOT to interrogate them with bureaucratic questions.\r\n\r\nTone: Professional, friendly, consultative, adaptive.\r\n\r\n═══════════════════════════════════════════════════════════════\r\nINFORMATION TO GATHER\r\n═══════════════════════════════════════════════════════════════\r\n\r\nESSENTIAL (Always Required):\r\n1. **Contact Information** (upfront, professional)\r\n   - Nome/Name\r\n   - Email\r\n   - Telefono/Phone (optional but encouraged)\r\n\r\n2. **Project Vision** (open-ended, rich detail)\r\n   - What do they want to achieve?\r\n   - Which room/space?\r\n   - Current state vs desired outcome\r\n\r\n3. **Scope of Work** (specific, project-focused)\r\n   - What needs to be done? (demolition, construction, finishes)\r\n   - Systems involved? (electrical, plumbing, HVAC)\r\n   - Materials preferences?\r\n\r\n4. **Space Context & Measurements** (practical, flexible)\r\n   - Room type (kitchen, bathroom, living room, etc.)\r\n   - Approximate dimensions (metri quadri or linear meters)\r\n   - Accept rough estimates (\"circa 20mq\", \"4x5 metri\", \"piccolo/medio/grande\")\r\n   - Any structural constraints? (load-bearing walls, windows, doors)\r\n\r\nADAPTIVE (Based on Context):\r\n- For kitchens: Layout changes? Appliances included? Linear meters of cabinets?\r\n- For bathrooms: Fixture replacement? New installations? Wall tile coverage area?\r\n- For renovations: Demolition extent? Preserve anything? Floor area?\r\n- For new construction: From scratch or partial? Total surface area?\r\n- For flooring/tiling: Square meters to cover?\r\n- For painting: Wall surface area (or room dimensions)?\r\n\r\n═══════════════════════════════════════════════════════════════\r\nCONVERSATION APPROACH\r\n═══════════════════════════════════════════════════════════════\r\n\r\nSTART: Friendly intro + contact info request\r\nExample: \"Ciao! Per prepararti un preventivo accurato, partiamo dai contatti. \r\nCome ti chiami e qual è la tua email?\"\r\n\r\nMIDDLE: Open-ended project questions → Intelligent follow-ups (including measurements)\r\n- Ask WHAT they want (vision), not HOW they'll execute (logistics)\r\n- Let them describe freely, then drill into specifics\r\n- Request measurements naturally, accept approximations\r\n- Adapt questions to their answers (be contextual!)\r\n- Focus on SCOPE, MATERIALS, and DIMENSIONS\r\n\r\nEND: Confirm understanding + save\r\nExample: \"Perfetto! Ho tutti i dettagli. Ricapitoliamo: [summary]. \r\nProcedo a salvare il tutto?\"\r\n\r\nMinimum Exchanges: 4-6 back-and-forth to gather quality information.\r\nMaximum: Keep it efficient - respect their time.\r\n\r\n═══════════════════════════════════════════════════════════════\r\nEXAMPLES - GOOD QUESTIONS ✅\r\n═══════════════════════════════════════════════════════════════\r\n\r\n**Project Vision:**\r\n✅ \"Raccontami del tuo progetto: cosa vuoi realizzare?\"\r\n✅ \"Qual è l'obiettivo principale? Estetico, funzionale, o entrambi?\"\r\n✅ \"Hai riferimenti di stile? (Moderno, classico, industriale...)\"\r\n\r\n**Scope of Work:**\r\n✅ \"Cosa prevedi di cambiare esattamente?\"\r\n✅ \"Partiamo da zero o mantieni qualcosa dell'esistente?\"\r\n✅ \"Gli impianti (elettrico, idraulico) vanno rifatti o aggiornati?\"\r\n✅ \"Prevedi demolizioni? Se sì, totali o parziali?\"\r\n\r\n**Measurements (Natural, Flexible):**\r\n✅ \"Che dimensioni ha lo spazio? Anche indicative vanno bene.\"\r\n✅ \"Più o meno quanti metri quadri? (non servono misure millimetriche)\"\r\n✅ \"Per il pavimento, quanto è grande la superficie da rifare?\"\r\n✅ \"La cucina: sai i metri lineari disponibili per i mobili?\"\r\n✅ \"Pareti da tinteggiare: quanti mq circa? (o dimmi le dimensioni della stanza)\"\r\n\r\n**Materials & Finishes:**\r\n✅ \"Quali materiali hai in mente? (Legno, marmo, gres, laminato...)\"\r\n✅ \"Pavimento: sostituzione o manutenzione?\"\r\n✅ \"Rivestimenti bagno/cucina: piastrelle, resina, altro?\"\r\n\r\n**Space Context & Measurements:**\r\n✅ \"Che dimensioni ha lo spazio? Anche indicative vanno bene.\"\r\n✅ \"Più o meno quanti metri quadri? (non servono misure millimetriche)\"\r\n✅ \"Ci sono vincoli architettonici da considerare?\"\r\n✅ \"Finestre e porte: mantieni posizioni o vuoi modifiche?\"\r\n\r\n**Room-Specific (Kitchen):**\r\n✅ \"La disposizione attuale va bene o vuoi cambiarla?\"\r\n✅ \"Elettrodomestici: li fornisci tu o li includiamo?\"\r\n✅ \"Top e ante: che materiali preferisci?\"\r\n\r\n**Room-Specific (Bathroom):**\r\n✅ \"Sanitari: quanti e che tipo? (Doccia, vasca, bidet...)\"\r\n✅ \"Mobili bagno: su misura o standard?\"\r\n✅ \"Rivestimenti: totali o solo zona doccia?\"\r\n\r\n═══════════════════════════════════════════════════════════════\r\nEXAMPLES - BAD QUESTIONS ❌ (DO NOT ASK)\r\n═══════════════════════════════════════════════════════════════\r\n\r\n**Logistics (Not Relevant for Quote):**\r\n❌ \"A che piano è l'appartamento?\"\r\n❌ \"C'è l'ascensore?\"\r\n❌ \"Di che anno è la costruzione?\"\r\n❌ \"Qual è l'altezza esatta dei soffitti?\"\r\n❌ \"Come si arriva al cantiere?\"\r\n\r\n**Too Bureaucratic:**\r\n❌ \"Compilare campo numero 7: metri quadri esatti\"\r\n❌ \"Protocollo richiede [long list]\"\r\n❌ \"Dato obbligatorio: [technical jargon]\"\r\n\r\n**Premature Budget Talk:**\r\n❌ \"Qual è il tuo budget massimo?\"\r\n❌ \"Quanto vuoi spendere?\"\r\n(Note: If user mentions budget, acknowledge and note it, but focus on scope)\r\n\r\n═══════════════════════════════════════════════════════════════\r\nFLEXIBILITY & INTELLIGENCE\r\n═══════════════════════════════════════════════════════════════\r\n\r\n**If User is Vague:**\r\nAsk clarifying open-ended questions to get richer details.\r\nExample: \"Interessante! Puoi darmi qualche dettaglio in più su [aspect]?\"\r\n\r\n**If User is Very Detailed:**\r\nAcknowledge their thoroughness, fill any remaining gaps.\r\nExample: \"Ottimo, hai già le idee chiare! Solo per completare...\"\r\n\r\n**If User Has Photo:**\r\nStart from visual analysis, then converge to project scope.\r\nExample: \"Vedo che hai [current state]. Intendi [demolish/preserve]?\"\r\n\r\n**If User Asks About Budget:**\r\nPolitely redirect to scope first.\r\nExample: \"Per darti una stima accurata, fammi capire meglio il progetto. \r\nPoi potremo discutere budget in base al lavoro.\"\r\n\r\n═══════════════════════════════════════════════════════════════\r\nOUTPUT FORMATTING\r\n═══════════════════════════════════════════════════════════════\r\n\r\nAfter gathering information, compile into projectDetails field as rich narrative:\r\n\r\nExample projectDetails:\r\n\"Ristrutturazione cucina 20mq, stile moderno. Demolizione parziale con \r\nmantenimento disposizione attuale. Top in quarzo, ante laccate bianche, \r\npavimento in gres effetto cemento. Elettrodomestici da includere: piano \r\ncottura induzione, forno, frigo, lavastoviglie. Impianto elettrico da \r\naggiornare, idraulico invariato. Illuminazione LED a soffitto + sottopensile.\"\r\n\r\nThen call submit_lead_data with all gathered fields.\r\n\r\nEnd Message Template:\r\n\"Riepilogo Tecnico salvato! \r\nTi ricontatteremo presto per un sopralluogo e la proposta economica. \r\nGrazie [Name]!\"\r\n\r\n[STATE MACHINE & TRANSITIONS - SYMMETRIC LOGIC]\r\nTrack conversation state based on tools used. Apply SYMMETRIC rules for both renders and quotes.\r\n\r\n═══════════════════════════════════════════════════════════════\r\nSTATE 0: INITIAL (Nothing done yet)\r\n═══════════════════════════════════════════════════════════════\r\n- Condition: Neither generate_render nor submit_lead_data called\r\n- Action: Determine user intent (MODE A for visualization, MODE B for quote)\r\n- Next: Transition to STATE 1A or STATE 1B based on user's first request\r\n\r\n═══════════════════════════════════════════════════════════════\r\nSTATE 1A: RENDER_ONLY (Render done, Quote NOT done)\r\n═══════════════════════════════════════════════════════════════\r\n- Condition: generate_render called successfully, submit_lead_data NOT called\r\n- NEXT ACTION REQUIRED (NON-NEGOTIABLE):\r\n  * IMMEDIATELY propose quote (complementary action)\r\n  * DO NOT propose another render (already have one)\r\n  \r\n- Prompt Template:\r\n  \"✨ Ti piace questo rendering? \r\n  \r\n  💰 **Vuoi realizzarlo davvero?** Posso prepararti un preventivo gratuito. \r\n  Mi servono solo 3-4 dettagli tecnici (piano, metratura, tipo di interventi). \r\n  \r\n  Procediamo con il preventivo?\"\r\n\r\n- Critical Rules:\r\n  ✅ Always propose quote after first render\r\n  ❌ Never propose second render (no changes yet)\r\n  ❌ Don't allow second render unless substantial modifications requested\r\n\r\n═══════════════════════════════════════════════════════════════\r\nSTATE 1B: QUOTE_ONLY (Quote done, Render NOT done) \r\n═══════════════════════════════════════════════════════════════\r\n- Condition: submit_lead_data called successfully, generate_render NOT called\r\n- NEXT ACTION REQUIRED (NON-NEGOTIABLE):\r\n  * IMMEDIATELY propose render (complementary action)\r\n  * DO NOT propose another quote (already have one)\r\n  \r\n- Prompt Template:\r\n  \"✅ Dati salvati correttamente!\r\n  \r\n  🎨 **Vuoi vedere come verrebbe?** Posso generarti un rendering 3D fotorealistico \r\n  del progetto che hai in mente.\r\n  \r\n  Procediamo con la visualizzazione?\"\r\n\r\n- Critical Rules:\r\n  ✅ Always propose render after first quote\r\n  ❌ Never propose second quote (no changes yet)\r\n  ❌ Don't allow second quote unless substantial modifications requested\r\n\r\n═══════════════════════════════════════════════════════════════\r\nSTATE 2: COMPLETE (Both Render AND Quote done)\r\n═══════════════════════════════════════════════════════════════\r\n- Condition: Both generate_render AND submit_lead_data called successfully\r\n- NEXT ACTION: Listen for modification requests, distinguish substantial vs minor\r\n\r\n- Behavior Based on Change Type:\r\n  \r\n  🔄 SUBSTANTIAL CHANGES (New Project Scope):\r\n  - Examples: \r\n    * \"Invece voglio stile industriale, non moderno\"\r\n    * \"Cambiamo ambiente: bagno invece di cucina\"\r\n    * \"Progetto completamente diverso\"\r\n  - Action:\r\n    ✅ Generate new render if requested\r\n    ✅ CAN propose new quote (different scope)\r\n    ✅ Collect new quote data if needed\r\n    ✅ Treat as NEW iteration\r\n  \r\n  🎨 MINOR VARIATIONS (Same Project Scope):\r\n  - Examples:\r\n    * \"Fammi vedere con pavimento più chiaro\"\r\n    * \"Cambia colore divano\"\r\n    * \"Mostrami variante con altra disposizione\"\r\n  - Action:\r\n    ✅ Generate new render if requested\r\n    ❌ DO NOT propose new quote (same project, data valid)\r\n    ❌ DO NOT propose new render (user already asked)\r\n    ✅ Just execute what user explicitly requests\r\n\r\n- Prompt Template (After Completion):\r\n  \"Perfetto! Abbiamo il progetto visivo e il preventivo.\r\n  \r\n  Se vuoi esplorare un'opzione completamente diversa o apportare modifiche, \r\n  sono qui per aiutarti!\"\r\n\r\n═══════════════════════════════════════════════════════════════\r\nANTI-DUPLICATE RULES (Critical - Prevent Waste)\r\n═══════════════════════════════════════════════════════════════\r\n1. ❌ NEVER propose a tool that was JUST used\r\n   - After render → propose QUOTE, not another render\r\n   - After quote → propose RENDER, not another quote\r\n\r\n2. ❌ NEVER propose same tool twice in same iteration\r\n   - One render proposal per iteration\r\n   - One quote proposal per iteration\r\n\r\n3. ❌ NEVER allow second use without modifications\r\n   - \"Want another render?\" → NO (unless changes requested)\r\n   - \"Want another quote?\" → NO (unless project changed)\r\n\r\n4. ✅ ONLY allow tool reuse on:\r\n   - User explicitly requests it with substantial changes\r\n   - New project scope identified\r\n\r\n═══════════════════════════════════════════════════════════════\r\nSEQUENCE-AWARE RULES (Bidirectional & Symmetric)\r\n═══════════════════════════════════════════════════════════════\r\n\r\nFOR QUOTES:\r\n1. Render FIRST → Quote NOT done: ✅ Propose quote (STATE 1A)\r\n2. Quote FIRST → Render AFTER: ❌ Never propose second quote (STATE 1B → 2)\r\n3. Both COMPLETE → Substantial changes: ✅ Can propose new quote\r\n4. Both COMPLETE → Minor variations: ❌ Never propose quote\r\n\r\nFOR RENDERS (SYMMETRIC):\r\n1. Quote FIRST → Render NOT done: ✅ Propose render (STATE 1B)\r\n2. Render FIRST → Quote AFTER: ❌ Never propose second render (STATE 1A → 2)\r\n3. Both COMPLETE → Substantial changes: ✅ Can propose new render\r\n4. Both COMPLETE → Minor variations: ❌ Never propose render\r\n\r\n═══════════════════════════════════════════════════════════════\r\nQUOTA LIMITS (Enforced by System)\r\n═══════════════════════════════════════════════════════════════\r\n- Maximum 2 renders per 24h per IP\r\n- Maximum 2 quotes per 24h per IP\r\n- If user hits limit: Relay error message politely, explain reset time\r\n- Don't encourage quota waste: Follow anti-duplicate rules strictly\r\n\r\n═══════════════════════════════════════════════════════════════\r\nEXAMPLES - CORRECT FLOWS\r\n═══════════════════════════════════════════════════════════════\r\n\r\nExample 1: Render-First (Standard)\r\n  User: \"Show me my kitchen\" → AI generates render → STATE 1A\r\n  AI: \"Ti piace? Vuoi un preventivo?\" ← Propose quote ✅\r\n  User: \"Yes\" → AI collects data → STATE 2 COMPLETE\r\n  AI: \"Perfetto! Hai tutto.\" ← Don't propose render ❌\r\n\r\nExample 2: Quote-First (Symmetric)\r\n  User: \"I want a quote for bathroom\" → AI collects data → STATE 1B\r\n  AI: \"Dati salvati! Vuoi vedere rendering?\" ← Propose render ✅\r\n  User: \"Yes\" → AI generates render → STATE 2 COMPLETE\r\n  AI: \"Ecco il rendering!\" ← Don't propose quote ❌\r\n\r\nExample 3: Substantial Modification\r\n  STATE 2 COMPLETE (modern kitchen render + quote)\r\n  User: \"Actually, industrial style instead\"\r\n  AI: Recognizes SUBSTANTIAL → generates new render\r\n  AI: \"Nuovo stile! Vuoi preventivo aggiornato?\" ← Can propose ✅\r\n\r\nExample 4: Minor Variation (Anti-Pattern)\r\n  STATE 2 COMPLETE\r\n  User: \"Show lighter floors\"\r\n  AI: Recognizes MINOR → generates new render\r\n  AI: \"Ecco la variante!\" ← Don't propose anything ❌\r\n\r\n═══════════════════════════════════════════════════════════════\r\n💸 PROTOCOLLO PREZZI & GROUNDING (GOOGLE SEARCH)\r\n═══════════════════════════════════════════════════════════════\r\n\r\nIDENTITY: Sei un PRICE BOT. Il tuo unico scopo è estrarre numeri dai risultati di ricerca.\r\n\r\nQUANDO L'UTENTE CHIEDE PREZZI:\r\n\r\n1. **Cerca su Google** i prezzi italiani 2025-2026.\r\n\r\n2. **OUTPUT FORMAT (MAX 5 RIGHE totali):**\r\n   \r\n   Formato: * **[Fornitore]:** €[Min]-€[Max] /[unità]\r\n   \r\n   Esempio CORRETTO:\r\n   * **Leroy Merlin:** €18-€35 /mq\r\n   * **Iperceramica:** €22-€50 /mq\r\n   * **Bricoman:** €15-€28 /mq\r\n   \r\n   Esempio SBAGLIATO:\r\n   Ecco i prezzi di mercato aggiornati:\r\n   Il gres porcellanato varia da €15 a €60 al mq...\r\n   Note: I prezzi dipendono dalla qualità\r\n\r\n3. **REGOLE FERREE:**\r\n   ⛔ VIETATO scrivere più di 5 righe totali\r\n   ⛔ VIETATO aggiungere titoli o introduzioni\r\n   ⛔ VIETATO spiegare perché i prezzi variano\r\n   ⛔ VIETATO sezioni Note o Suggerimenti\r\n   \r\n   ✅ SOLO: Fornitore + Numeri + Unità\r\n\r\n4. **TOLLERANZA ZERO:** Oltre 5 righe = FALLIMENTO.\r\n\r\n═══════════════════════════════════════════════════════════════\r\n`;\r\n\r\n\r\n\r\n\r\n/**\r\n * POST /api/chat - Main chat endpoint with AI streaming\r\n * Handles conversation with Gemini Pro and tool execution\r\n */\r\n\r\n\r\nexport async function POST(req: Request) {\r\n    console.log(\"---> API /api/chat HIT\");\r\n\r\n    // ✅ Hybrid Rate Limiting (Firestore + In-Memory Cache)\r\n    const ip = (req.headers.get('x-forwarded-for') ?? '127.0.0.1').split(',')[0];\r\n\r\n    const { allowed, remaining, resetAt } = await checkRateLimit(ip);\r\n\r\n    if (!allowed) {\r\n        console.warn(`[RateLimit] IP ${ip} exceeded rate limit`);\r\n        return new Response('Too Many Requests - Please wait before trying again', {\r\n            status: 429,\r\n            headers: {\r\n                'Content-Type': 'text/plain',\r\n                'X-RateLimit-Limit': '20',\r\n                'X-RateLimit-Remaining': remaining.toString(),\r\n                'X-RateLimit-Reset': resetAt.toISOString(),\r\n                'Retry-After': Math.ceil((resetAt.getTime() - Date.now()) / 1000).toString(),\r\n            },\r\n        });\r\n    }\r\n\r\n    console.log(`[RateLimit] IP ${ip} allowed - ${remaining} requests remaining`);\r\n\r\n    try {\r\n        const body = await req.json();\r\n        const { messages, images, imageUrls, sessionId } = body; // ✅ Extract imageUrls\r\n\r\n        // ✅ BUG FIX #5: Strict sessionId validation (security)\r\n        if (!sessionId || typeof sessionId !== 'string' || sessionId.trim().length === 0) {\r\n            console.error('[API] Missing or invalid sessionId');\r\n            return new Response(JSON.stringify({\r\n                error: 'sessionId is required',\r\n                details: 'A valid session identifier must be provided'\r\n            }), {\r\n                status: 400,\r\n                headers: { 'Content-Type': 'application/json' }\r\n            });\r\n        }\r\n\r\n        console.log(\"API Request Debug:\", {\r\n            hasMessages: !!messages,\r\n            messagesLength: messages?.length,\r\n            hasImages: !!images,\r\n            hasImageUrls: !!imageUrls, // ✅ Log imageUrls presence\r\n            imageUrlsCount: imageUrls?.length || 0,\r\n            sessionId\r\n        });\r\n\r\n        // Ensure session exists in Firestore\r\n        await ensureSession(sessionId);\r\n\r\n        // Load conversation history from Firestore\r\n        const conversationHistory = await getConversationContext(sessionId, 10);\r\n\r\n        // Get the latest user message from the request\r\n        const safeMessages = Array.isArray(messages) ? messages : [];\r\n        const latestUserMessage = safeMessages[safeMessages.length - 1];\r\n\r\n        // 👇 DEBUG CRITICO: Stampa la struttura grezza per capire dove è il testo\r\n        console.log('🔍 [DEBUG RAW MESSAGE]:', JSON.stringify(latestUserMessage, null, 2));\r\n\r\n        // Combine history + new message\r\n        let coreMessages = [\r\n            ...conversationHistory,\r\n            {\r\n                role: latestUserMessage?.role || 'user',\r\n                content: latestUserMessage?.content || ''\r\n            }\r\n        ];\r\n\r\n        // Inject images into the last user message if provided\r\n        if (images && Array.isArray(images) && images.length > 0) {\r\n            const lastMessage = coreMessages[coreMessages.length - 1];\r\n\r\n            if (lastMessage && lastMessage.role === 'user') {\r\n                const textContent = typeof lastMessage.content === 'string' ? lastMessage.content : '';\r\n\r\n                lastMessage.content = [\r\n                    { type: 'text', text: textContent },\r\n                    ...images.map((img: string) => ({ type: 'image', image: img }))\r\n                ] as any;\r\n            }\r\n        }\r\n\r\n        // Save user message to Firestore (async, don't await)\r\n        // ✅ FIX: Use helper to correctly extract text from message.parts structure\r\n        let userTextContent = extractUserMessage(latestUserMessage);\r\n\r\n        // ✅ HYBRID TOOL: Append marker with public URL if imageUrls available\r\n        if (images && Array.isArray(images) && images.length > 0) {\r\n            // If we have public URLs, include them in the marker for AI context\r\n            if (imageUrls && Array.isArray(imageUrls) && imageUrls.length > 0) {\r\n                // Save first URL (most recent image) in marker for modification mode\r\n                const firstImageUrl = imageUrls[0];\r\n                userTextContent += ` [Immagine allegata: ${firstImageUrl}]`;\r\n                console.log('[API] ✅ Appended [Immagine allegata] marker with public URL:', firstImageUrl);\r\n            } else {\r\n                // Fallback: basic marker without URL\r\n                userTextContent += ' [Immagine allegata]';\r\n                console.log('[API] Appended [Immagine allegata] marker (no public URL available)');\r\n            }\r\n        }\r\n\r\n        console.log('[Firestore] Attempting to save user message...', { sessionId, content: userTextContent.substring(0, 50) });\r\n        console.log(`[API] Parsed User Message: \"${userTextContent}\"`);\r\n        saveMessage(sessionId, 'user', userTextContent)\r\n            .then(() => console.log('[Firestore] ✅ User message saved successfully'))\r\n            .catch((error) => {\r\n                console.error('[Firestore] ❌ ERROR saving user message:', error);\r\n                console.error('[Firestore] Error details:', {\r\n                    message: error.message,\r\n                    stack: error.stack,\r\n                    code: error.code\r\n                });\r\n            });\r\n\r\n        // Initialize Google Provider\r\n        const googleProvider = createGoogleGenerativeAI({\r\n            apiKey: process.env.GEMINI_API_KEY || '',\r\n        });\r\n\r\n        // ✅ CRITICAL FIX: Conditional Tool Loading\r\n        // Only enable tools when user has explicitly requested them\r\n        // This prevents Gemini from calling generate_render on simple greetings\r\n\r\n        const conversationText = coreMessages.map((m: any) =>\r\n            typeof m.content === 'string' ? m.content.toLowerCase() : ''\r\n        ).join(' ');\r\n\r\n        // ✅ ALWAYS enable tools - let the AI decide when to use them\r\n        // The system prompt already instructs the AI to only use tools after confirmation\r\n        const { createChatTools } = await import('@ai-core');\r\n        const tools = createChatTools(sessionId, ip);\r\n        console.log('[Tools] ✅ Tools ENABLED (always available)');\r\n\r\n        // ✅ MANUAL DATA STREAM IMPLEMENTATION\r\n        // Since createDataStream is missing in certain versions, we manually construct the stream\r\n        // strictly following Vercel's Data Stream Protocol (v1)\r\n\r\n        const stream = new ReadableStream({\r\n            async start(controller) {\r\n                // Helper to write formatted data protocol chunks\r\n                const writeData = (key: string, value: any) => {\r\n                    const raw = JSON.stringify(value);\r\n                    controller.enqueue(new TextEncoder().encode(`${key}:${raw} \\n`));\r\n                };\r\n\r\n                // ✅ ACCUMULATE STREAM: Track exactly what user sees for database persistence\r\n                let streamedContent = '';\r\n\r\n                try {\r\n                    // ✅ CONTEXT INJECTION: Force last known image into System Instruction\r\n                    // This ensures the AI \"sees\" the image even in subsequent turns\r\n                    let activeSystemInstruction = SYSTEM_INSTRUCTION;\r\n\r\n                    // Find the last image URL in the conversation history (including current request)\r\n                    let lastImageUrl = imageUrls?.[0]; // Current request\r\n                    if (!lastImageUrl) {\r\n                        // Fallback: Scan history for [Immagine allegata: URL] marker\r\n                        const reversedHistory = [...conversationHistory].reverse();\r\n                        for (const msg of reversedHistory) {\r\n                            const match = msg.content.match(/\\[Immagine allegata: (https?:\\/\\/[^\\]]+)\\]/);\r\n                            if (match) {\r\n                                lastImageUrl = match[1];\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    if (lastImageUrl) {\r\n                        console.log('[Context] 💉 Injecting ACTIVE_IMAGE_URL into System Instruction:', lastImageUrl);\r\n                        activeSystemInstruction += `\\n\\n[[ACTIVE CONTEXT]]\\nLAST_UPLOADED_IMAGE_URL=\"${lastImageUrl}\"\\nWhen calling generate_render, you MUST set sourceImageUrl=\"${lastImageUrl}\" if the user wants to modify this image.`;\r\n                    }\r\n\r\n                    // 1. Start the actual AI stream\r\n                    // Cast options to any to avoid strict type checks on experimental features\r\n                    const result = streamText({\r\n                        model: googleProvider(process.env.CHAT_MODEL_VERSION || 'gemini-3-flash-preview'),\r\n                        system: activeSystemInstruction, // Use dynamic system prompt\r\n                        messages: coreMessages as any,\r\n                        tools: tools as any,\r\n                        maxSteps: 5,\r\n                        maxToolRoundtrips: 2, // Allow Gemini to use tools AND generate final response\r\n                        experimental_providerMetadata: { sessionId },\r\n\r\n                        // ✅ DIRECT TOOL RESULT STREAMING\r\n                        // Write tool results directly to the stream instead of waiting for Gemini\r\n                        async onToolCall({ toolCall, toolResult }: { toolCall: any; toolResult: any }) {\r\n                            console.log('🔧 [Tool Call]', toolCall.toolName);\r\n\r\n                            // 💸 PERPLEXITY: Stream market prices directly to chat\r\n                            if (toolCall.toolName === 'get_market_prices' && toolResult) {\r\n                                const resultText = typeof toolResult === 'string' ? toolResult : JSON.stringify(toolResult);\r\n                                console.log('📤 [Market Prices] Streaming to chat');\r\n                                writeData('0', resultText);\r\n                                streamedContent += resultText;\r\n                            }\r\n                        },\r\n\r\n                        // Keep onFinish logic\r\n                        onFinish: async ({ text, toolResults, finishReason, toolCalls }: { text: string; toolResults: any[]; finishReason?: string; toolCalls?: any[] }) => {\r\n                            console.log('[onFinish] 🔍 Streamed Content Length:', streamedContent.length);\r\n                            console.log('[onFinish] 📊 Finish Reason:', finishReason || 'unknown');\r\n                            console.log('[onFinish] 🔧 Tool Calls:', toolCalls?.length || 0);\r\n                            console.log('[onFinish] 📋 Tool Results:', toolResults?.length || 0);\r\n                            if (streamedContent.length === 0 && (!toolCalls || toolCalls.length === 0)) {\r\n                                console.warn('[onFinish] ⚠️ EMPTY RESPONSE: No text and no tool calls - Model may be refusing');\r\n                            }\r\n                            console.log('[onFinish] Saving assistant message');\r\n\r\n                            try {\r\n                                // ✅ SINGLE SOURCE OF TRUTH: Save exactly what was streamed to user\r\n                                await saveMessage(sessionId, 'assistant', streamedContent, {\r\n                                    toolCalls: toolResults?.map((tr: any) => ({\r\n                                        name: tr.toolName || 'unknown',\r\n                                        args: tr.args || {},\r\n                                        result: tr.result || {}\r\n                                    }))\r\n                                });\r\n                                console.log('[onFinish] ✅ Message saved successfully');\r\n                            } catch (error) {\r\n                                console.error('[onFinish] ❌ CRITICAL: Failed to save message', error);\r\n                            }\r\n                        },\r\n                    } as any);\r\n\r\n                    // 2. Consume the FULL stream to capture tools and text\r\n                    // We iterate over the full event stream to manually inject tool outputs (images) as text\r\n                    // \r\n                    // 🔍 GOOGLE SEARCH GROUNDING: When the model uses google_search,\r\n                    // results are automatically incorporated into text-delta responses.\r\n                    // The AI SDK handles grounding metadata internally, including:\r\n                    // - webSearchQueries: Search queries used\r\n                    // - searchEntryPoint: Main search result content\r\n                    // - groundingSupports: Citations and confidence scores\r\n                    for await (const part of result.fullStream) {\r\n                        if (part.type === 'text-delta') {\r\n                            streamedContent += part.text;\r\n                            writeData('0', part.text);\r\n                        }\r\n\r\n                        // Check for tool results (specifically our generation tool)\r\n                        // ✅ SECURITY FIX: Robust error handling for tool failures\r\n\r\n                        // 💸 PERPLEXITY: Write market prices to stream  \r\n                        if (part.type === 'tool-result' && part.toolName === 'get_market_prices') {\r\n                            try {\r\n                                const result = (part as any).result || (part as any).output;\r\n                                const resultText = typeof result === 'string' ? result : JSON.stringify(result);\r\n                                console.log('📤 [Market Prices] Writing to stream:', resultText.substring(0, 100));\r\n                                writeData('0', resultText);\r\n                                streamedContent += resultText;\r\n                            } catch (error) {\r\n                                console.error('❌ [Market Prices] Stream error:', error);\r\n                            }\r\n                        }\r\n\r\n                        if (part.type === 'tool-result' && part.toolName === 'generate_render') {\r\n                            try {\r\n                                const result = (part as any).result || (part as any).output;\r\n\r\n                                // Check for error status first (tool-level failure)\r\n                                if (result?.status === 'error') {\r\n                                    const errorMessage = `\\n\\n⚠️ Mi dispiace, il servizio di rendering è temporaneamente non disponibile.\\nErrore tecnico: ${JSON.stringify(result.error)}\\n\\n`;\r\n                                    console.error('[Stream] Tool returned error:', result.error);\r\n                                    streamedContent += errorMessage;\r\n                                    writeData('0', errorMessage);\r\n                                } else if (result?.status === 'success' && result?.imageUrl) {\r\n                                    // Inject the image as a markdown text chunk\r\n                                    const imageMarkdown = `\\n\\n![](${result.imageUrl}) \\n\\n`;\r\n                                    console.log('[Stream] Injecting image to stream:', result.imageUrl);\r\n                                    streamedContent += imageMarkdown;\r\n                                    writeData('0', imageMarkdown);\r\n                                } else {\r\n                                    // Unexpected result format\r\n                                    const unexpectedError = '\\n\\n⚠️ Si è verificato un errore imprevisto. Riprova.\\n\\n';\r\n                                    console.warn('[Stream] Unexpected tool result format:', result);\r\n                                    streamedContent += unexpectedError;\r\n                                    writeData('0', unexpectedError);\r\n                                }\r\n                            } catch (toolError) {\r\n                                // Catch any unexpected errors during tool result processing\r\n                                const processingError = '\\n\\n⚠️ Si è verificato un errore durante la generazione. Riprova.\\n\\n';\r\n                                console.error('[Stream] Error processing tool result:', toolError);\r\n                                streamedContent += processingError;\r\n                                writeData('0', processingError);\r\n                            }\r\n                        }\r\n\r\n                        // We also likely need to send tool call info if we want to be \"correct\", \r\n                        // but for this specific \"Text + Image\" requirement, injecting text is safer.\r\n\r\n                        // ✅ FIX: Forward tool calls to client (Protocol '9')\r\n                        if (part.type === 'tool-call') {\r\n                            const p = part as any;\r\n                            const toolCall = {\r\n                                toolCallId: p.toolCallId,\r\n                                toolName: p.toolName,\r\n                                args: p.args || p.input || {}\r\n                            };\r\n                            writeData('9', toolCall);\r\n                        }\r\n\r\n                        // ✅ Forward ALL tool results (Protocol 'a') for frontend metadata access\r\n                        // User-facing content sent via Protocol '0', metadata via Protocol 'a'\r\n                        if (part.type === 'tool-result') {\r\n                            const p = part as any;\r\n                            const toolResult = {\r\n                                toolCallId: p.toolCallId,\r\n                                result: p.result\r\n                            };\r\n                            writeData('a', toolResult);\r\n                        }\r\n                    }\r\n\r\n                    // 3. Close the stream cleanly\r\n                    controller.close();\r\n\r\n                } catch (error: any) {\r\n                    // Protocol: '3' key for error messages\r\n                    writeData('3', { error: error.message });\r\n                    console.error(\"Stream Error:\", error);\r\n                    controller.close();\r\n                }\r\n            }\r\n        });\r\n\r\n        // Return the standard response with correct headers\r\n        return new Response(stream, {\r\n            status: 200,\r\n            headers: {\r\n                'Content-Type': 'text/plain; charset=utf-8',\r\n                'X-Vercel-AI-Data-Stream': 'v1', // Activates frontend tool/image mode\r\n                'X-RateLimit-Limit': '20',\r\n                'X-RateLimit-Remaining': remaining.toString(),\r\n                'X-RateLimit-Reset': resetAt.toISOString(),\r\n            },\r\n        });\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Chat API Error Details:\", error);\r\n        return new Response(JSON.stringify({\r\n            error: 'Internal Server Error',\r\n            details: error.message,\r\n            stack: error.stack\r\n        }), {\r\n            status: 500,\r\n            headers: { 'Content-Type': 'application/json' }\r\n        });\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}