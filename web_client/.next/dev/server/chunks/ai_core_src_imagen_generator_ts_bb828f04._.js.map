{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/User01/.gemini/antigravity/scratch/renovation-next/ai_core/src/imagen/generator.ts"],"sourcesContent":["\r\nimport { VertexAI, HarmCategory, HarmBlockThreshold } from '@google-cloud/vertexai';\r\n\r\n/**\r\n * The Painter: Executes the renovation using the provided Locked Prompt.\r\n * Uses Gemini 3 Pro Image Preview (Multimodal) for high-fidelity generation.\r\n * \r\n * ROLE: Senior AI Engineer Implementation\r\n * MODEL: gemini-3-pro-image-preview\r\n * REGION: us-central1\r\n */\r\nexport async function generateRenovation(imageBuffer: Buffer, prompt: string): Promise<Buffer> {\r\n    console.log(`[Painter] Starting renovation generation...`);\r\n    // console.log(`[Painter] Prompt length: ${prompt.length} chars`);\r\n\r\n    // STEP 2: The Painter (Vertex AI Generation) - DIRECT EXECUTION\r\n    // The prompt is now provided by the orchestrator (JIT Pipeline)\r\n    const finalPrompt = `${prompt}\\n\\nOutput a high-res renovation image.`;\r\n\r\n    // STEP 2: The Painter (Vertex AI Generation)\r\n    const projectId = process.env.FIREBASE_PROJECT_ID;\r\n    const location = 'us-central1'; // REQUIRED for preview models\r\n\r\n    if (!projectId) {\r\n        throw new Error('FIREBASE_PROJECT_ID not found');\r\n    }\r\n\r\n    // Initialize Vertex AI with explicit auth support for local dev\r\n    const vertex_ai = new VertexAI({\r\n        project: projectId,\r\n        location: location,\r\n        googleAuthOptions: process.env.FIREBASE_CLIENT_EMAIL && process.env.FIREBASE_PRIVATE_KEY ? {\r\n            credentials: {\r\n                client_email: process.env.FIREBASE_CLIENT_EMAIL,\r\n                private_key: process.env.FIREBASE_PRIVATE_KEY.replace(/\\\\n/g, '\\n')\r\n            }\r\n        } : undefined\r\n    });\r\n\r\n    // Use the model version from env (User requested: gemini-2.5-flash-image for I2I)\r\n    const envModel = process.env.VISION_MODEL_VERSION;\r\n    const modelName = envModel || 'gemini-2.5-flash-image';\r\n    console.log(`[Painter] ENV VISION_MODEL_VERSION: ${envModel}`);\r\n    console.log(`[Painter] Initializing model: ${modelName} in ${location}`);\r\n\r\n    const generativeModel = vertex_ai.getGenerativeModel({\r\n        model: modelName,\r\n        safetySettings: [\r\n            { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },\r\n            { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },\r\n            { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },\r\n            { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },\r\n        ],\r\n        generationConfig: {\r\n            maxOutputTokens: 8192,\r\n            temperature: 0.2, // Keep low to respect the \"Locked\" instructions\r\n            topP: 0.95,\r\n        }\r\n    });\r\n\r\n    try {\r\n        const base64Image = imageBuffer.toString('base64');\r\n        const mimeType = 'image/jpeg';\r\n\r\n        const multimodalPrompt = {\r\n            inlineData: {\r\n                mimeType: mimeType,\r\n                data: base64Image\r\n            }\r\n        };\r\n\r\n        const textPart = {\r\n            text: finalPrompt\r\n        };\r\n\r\n        const request = {\r\n            contents: [{\r\n                role: 'user',\r\n                parts: [multimodalPrompt, textPart]\r\n            }]\r\n        };\r\n\r\n        console.log('[Painter] Sending request to Vertex AI...');\r\n        const response = await generativeModel.generateContent(request);\r\n        const result = await response.response;\r\n\r\n        // Extract Image\r\n        if (!result.candidates || result.candidates.length === 0) {\r\n            throw new Error('No candidates returned');\r\n        }\r\n\r\n        const candidate = result.candidates[0];\r\n        let generatedImageBase64: string | undefined;\r\n\r\n        for (const part of candidate.content.parts) {\r\n            // Check for inlineData (Base64)\r\n            if (part.inlineData && part.inlineData.mimeType.startsWith('image/')) {\r\n                generatedImageBase64 = part.inlineData.data;\r\n                break;\r\n            }\r\n            // Future-proofing: Check for fileData (URI) if returned by some versions\r\n            // @ts-ignore\r\n            if (part.fileData && part.fileData.mimeType.startsWith('image/')) {\r\n                console.warn('[Painter] Received fileData URL instead of inlineData, functionality might need update.');\r\n            }\r\n        }\r\n\r\n        if (!generatedImageBase64) {\r\n            console.error('[Painter] Full Response:', JSON.stringify(result, null, 2));\r\n            throw new Error('Model returned valid response but NO image data found.');\r\n        }\r\n\r\n        const generatedBuffer = Buffer.from(generatedImageBase64, 'base64');\r\n        console.log(`[Painter] âœ… Generation complete! Image size: ${(generatedBuffer.length / 1024).toFixed(2)} KB`);\r\n\r\n        return generatedBuffer;\r\n\r\n    } catch (error) {\r\n        console.error('[Painter] Error:', error);\r\n        if (error instanceof Error && error.message.includes('404')) {\r\n            throw new Error(`Model ${modelName} not found in ${location}. Ensure Project ID is allowlisted.`);\r\n        }\r\n        throw new Error(`Painter generation failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}